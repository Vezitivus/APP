<!doctype html>
<html lang="lv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>STEEL, FIRE & STEAK</title>

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#0b0c10">

  <style>
    :root{
      --bg-1:#0b0c10; --bg-2:#14161d; --ember:#f25f3a; --steel:#7f8c9a;
      --text:#e8e9ef; --muted:#a7adba; --border:#ffffff24; --radius:18px;
      --blur:14px; --shadow:0 10px 30px rgba(0,0,0,.35), 0 1px 0 rgba(255,255,255,.02) inset;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--text);
      font:16px/1.45 -apple-system,BlinkMacSystemFont,"SF Pro Text","Segoe UI",Roboto,"Helvetica Neue",Arial,system-ui,sans-serif;
      background:
        radial-gradient(1200px 800px at 20% -10%, #f25f3a22 0%, transparent 60%),
        radial-gradient(900px 700px at 90% 110%, #ffcf6a14 0%, transparent 60%),
        linear-gradient(180deg,var(--bg-1),var(--bg-2));
      overflow-x:hidden;
    }

    .wrap{ min-height:100dvh; display:flex; align-items:center; justify-content:center; padding:clamp(16px,3vw,32px); }
    .card{
      width:min(920px,100%); border-radius:var(--radius);
      background:linear-gradient(180deg, #ffffff12, #ffffff08);
      border:1px solid var(--border); backdrop-filter:saturate(130%) blur(var(--blur));
      box-shadow:var(--shadow); padding:clamp(18px,3vw,28px);
      transform:translateY(-18px); opacity:0;
      transition:transform .7s cubic-bezier(.2,.75,.2,1), opacity .7s ease;
    }
    .card.reveal{ transform:translateY(0); opacity:1; }

    header{ text-align:center; padding:6px 8px 12px; }
    header h1{
      margin:0; letter-spacing:.14em; font-weight:700; font-size:clamp(20px,4.2vw,32px);
      text-transform:uppercase; color:#fff;
      text-shadow:0 1px 0 rgba(255,255,255,.05), 0 12px 30px rgba(0,0,0,.35);
    }
    .motto{
      margin-top:8px; color:#e6e7ec; font-weight:600;
      font-size:clamp(14px,2.6vw,18px); letter-spacing:.06em; opacity:.95;
    }
    .sub{ margin-top:6px; color:var(--muted); font-size:13px; letter-spacing:.08em; }

    /* 3D zona */
    .stage{ perspective:1200px; margin:18px auto 10px; width:100%; display:grid; place-items:center; }
    .badge{ position:relative; width:min(340px,68vw); aspect-ratio:1/1; transform-style:preserve-3d; filter:drop-shadow(0 24px 60px rgba(242,95,58,.18)); }
    .halo{ position:absolute; inset:-10%; border-radius:50%; background:radial-gradient(circle at 50% 50%, #f25f3a33, transparent 60%); filter:blur(30px); transform:translateZ(-60px) scale(1.05); pointer-events:none; }

    /* Divpusējā rotācija: korpuss + 2 sejas */
    .spinner{
      position:relative;
      width:100%; height:100%;
      transform-style:preserve-3d;
      animation:spinY 12s linear infinite;
      will-change:transform;
    }
    .face{
      position:absolute; inset:0;
      width:100%; height:100%; display:block; object-fit:contain;
      backface-visibility:hidden; -webkit-backface-visibility:hidden;
    }
    .face.front{ transform:rotateY(0deg); }
    .face.back { transform:rotateY(180deg); }

    @keyframes spinY{
      from{ transform:rotateY(0deg) }
      to  { transform:rotateY(360deg) }
    }

    .grid{ display:grid; gap:14px; margin-top:8px; }
    .row{ border:1px solid var(--border); background:linear-gradient(180deg, #0d0f1311, #0d0f1307); border-radius:calc(var(--radius) - 8px); padding:16px 18px; }
    .label{ font-size:12px; letter-spacing:.14em; text-transform:uppercase; color:var(--steel); margin-bottom:6px; }
    .value{ font-size:clamp(18px,4.2vw,22px); font-weight:600; color:#fff; }
    .value.note{ white-space:pre-wrap; color:#e9e9ee; font-weight:500; }

    /* skeleton */
    .skeleton{ position:relative; overflow:hidden; background:#ffffff0f; border-radius:12px; height:1.2em; display:inline-block; min-width:120px; }
    .skeleton::after{ content:""; position:absolute; inset:0; background:linear-gradient(90deg, transparent, #ffffff22, transparent); animation:shimmer 1.1s infinite; }
    @keyframes shimmer{ from{ transform:translateX(-100%) } to{ transform:translateX(100%) } }

    /* toast */
    .toast{
      position:fixed; left:50%; bottom:20px; transform:translateX(-50%) translateY(20px);
      background:#111418ee; color:#fff; padding:10px 14px; border-radius:12px; border:1px solid #ffffff22;
      box-shadow:0 6px 20px rgba(0,0,0,.35); opacity:0; pointer-events:none; transition:.35s; font-size:14px;
    }
    .toast.show{ opacity:1; transform:translateX(-50%) translateY(0); }

    /* ID modālis */
    dialog{ border:none; padding:0; background:transparent; }
    .modal{
      width:min(540px,92vw); border-radius:16px;
      background:linear-gradient(180deg, #0f1217ee, #0e1014ee);
      border:1px solid #ffffff2a; backdrop-filter:blur(16px);
      padding:18px; color:#fff; box-shadow:0 30px 80px rgba(0,0,0,.55);
    }
    .modal h3{ margin:0 0 10px; font-size:18px; letter-spacing:.06em; }
    .modal .row{ background:transparent; border:none; padding:0; }
    .modal input{
      width:100%; font:600 18px/1.2 ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;
      color:#fff; background:#ffffff10; border:1px solid #ffffff22; border-radius:12px; padding:12px 14px; outline:none;
    }
    .modal button{
      margin-top:12px; width:100%; appearance:none; border:none; cursor:pointer;
      border-radius:12px; padding:12px 14px; font-weight:700; letter-spacing:.06em; text-transform:uppercase;
      background:linear-gradient(180deg, #f66a41, #e35631); color:#fff; box-shadow:0 10px 26px rgba(242,95,58,.35);
    }

    @media (min-width:720px){
      .grid{ grid-template-columns:1fr 1fr; }
      .row.notes{ grid-column:1 / -1; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <main class="card" id="card">
      <header>
        <h1>STEEL, FIRE &amp; STEAK</h1>
        <div class="motto" id="motto"><span class="skeleton" style="width:60%"></span></div>
        <div class="sub" id="subInfo">Ielāde…</div>
      </header>

      <!-- Divpusējā rotācija -->
      <section class="stage" aria-label="Rotējošais attēls">
        <div class="badge">
          <div class="halo" aria-hidden="true"></div>
          <div class="spinner" id="spinner">
            <img id="imgFront" class="face front" alt="Attēls – priekšpuse" />
            <img id="imgBack"  class="face back"  alt="Attēls – aizmugure" />
          </div>
        </div>
      </section>

      <section class="grid">
        <div class="row">
          <div class="label">Vārds</div>
          <div id="name" class="value"><span class="skeleton" style="width:40%"></span></div>
        </div>

        <div class="row">
          <div class="label">Uzdevums</div>
          <div id="task" class="value note"><span class="skeleton" style="width:95%"></span></div>
        </div>

        <div class="row notes">
          <div class="label">Piezīmes</div>
          <div id="notes" class="value note"><span class="skeleton" style="width:95%"></span></div>
        </div>
      </section>
    </main>
  </div>

  <div class="toast" id="toast"></div>

  <!-- ID dialogs -->
  <dialog id="idDialog">
    <div class="modal">
      <h3>Ieraksti dalībnieka ID</h3>
      <div class="row">
        <input id="idInput" type="text" inputmode="numeric" placeholder="piem., 101" autofocus />
      </div>
      <button id="saveIdBtn">Apstiprināt</button>
    </div>
  </dialog>

  <script>
    const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbxqumDDgdZMnjps9ZBEQIu5s40958y609r4taVT9VYEtlNJTdOJ3fPnDxqHnPl4YQMU/exec";
    const SHEET_NAME = "SFS";

    const qs = new URLSearchParams(location.search);
    const $ = s => document.querySelector(s);
    function toast(m,t=2200){const el=$("#toast");el.textContent=m;el.classList.add("show");setTimeout(()=>el.classList.remove("show"),t);}
    function persistId(id){try{localStorage.setItem("sfs:id",String(id));}catch{}}
    function readPersistedId(){try{return localStorage.getItem("sfs:id")||"";}catch{return""}}
    function reveal(){requestAnimationFrame(()=>$("#card").classList.add("reveal"));}

    // Vienmēr ieliekam ?id=... pašreizējā URL (bez pārlādes)
    function ensureUrlHasId(id){
      try{
        const u = new URL(location.href);
        if (u.searchParams.get("id") !== String(id)) {
          u.searchParams.set("id", String(id));
          history.replaceState(null, "", u.toString());
        }
      }catch{}
    }

    // JSONP fallback
    function jsonp(url,timeout=6000){
      return new Promise((resolve,reject)=>{
        const cb="__sfs_cb_"+Math.random().toString(36).slice(2);
        const s=document.createElement("script");
        const tm=setTimeout(()=>{cleanup();reject(new Error("JSONP timeout"));},timeout);
        function cleanup(){clearTimeout(tm);delete window[cb];s.remove();}
        window[cb]=d=>{cleanup();resolve(d);};
        const u=new URL(url);u.searchParams.set("callback",cb);
        s.src=u.toString();s.onerror=()=>{cleanup();reject(new Error("JSONP load error"));};
        document.head.appendChild(s);
      });
    }

    function setSkeleton(){
      $("#motto").innerHTML=`<span class="skeleton" style="width:60%"></span>`;
      $("#name").innerHTML=`<span class="skeleton" style="width:40%"></span>`;
      $("#task").innerHTML=`<span class="skeleton" style="width:95%"></span>`;
      $("#notes").innerHTML=`<span class="skeleton" style="width:95%"></span>`;
    }

    // Cloudinary optimizators
    function optimizeCloudinary(url){
      if(!/res\.cloudinary\.com\/.+\/image\/upload\//.test(url)) return url;
      if(/\/image\/upload\/.*(f_auto|q_auto|w_)/.test(url)) return url;
      return url.replace(/\/image\/upload\//, "/image/upload/f_auto,q_auto,w_900/");
    }

    function setCookie(n,v,d=365){const t=new Date();t.setTime(t.getTime()+d*864e5);document.cookie=`${encodeURIComponent(n)}=${encodeURIComponent(v)};expires=${t.toUTCString()};path=/;SameSite=Lax`;}
    async function fetchAsDataURL(url){
      const res=await fetch(url,{cache:"force-cache"});
      const blob=await res.blob();
      return await new Promise((resolve,reject)=>{const r=new FileReader();r.onload=()=>resolve(r.result);r.onerror=reject;r.readAsDataURL(blob);});
    }
    async function getCachedImageForId(id, srcUrl){
      const key=`sfs:img:${id}`, cookieKey=`sfs_img_${id}`;
      try{const cached=localStorage.getItem(key);if(cached) return cached;}catch{}
      let url=optimizeCloudinary(srcUrl);
      try{
        const dataUrl=await fetchAsDataURL(url);
        try{localStorage.setItem(key,dataUrl);}catch{}
        setCookie(cookieKey,"1",365);
        return dataUrl;
      }catch{
        return srcUrl;
      }
    }

    // Uzdevuma formatēšana: teikumus ieliekam jaunā rindā, vienā laukā
    function formatTasks(t){
      if(!t) return "—";
      const lines = String(t)
        .replace(/\r/g," ")
        .split(/(?:[.!?;]+|\n)+\s*/).map(s=>s.trim()).filter(Boolean);
      return lines.length ? lines.join("\n") : t;
    }

    function fillUI({name,motto,task,notes}){
      $("#name").textContent = name || "—";
      $("#motto").textContent = motto || "—";
      $("#task").textContent  = formatTasks(task);
      $("#notes").textContent = notes || "—";
    }

    function mapPayload(p){
      const r=p?.data||p; const row=Array.isArray(r)?r[0]:r; if(!row) return null;
      const pick=(o,keys,fb="")=>{for(const k of keys){if(o?.[k]!=null && o[k]!=="") return String(o[k]);}return fb;};
      return {
        id:pick(row,["id","ID","a","A"],""),
        name:pick(row,["vards","vārds","name","B","b"],""),
        motto:pick(row,["devize","devīze","motto","C","c"],""),
        image:pick(row,["image","img","D","d"],""),
        imageDataUrl:pick(row,["imageDataUrl","image_data_url"],""),
        task:pick(row,["uzdevums","task","E","e"],""),
        notes:pick(row,["notes","piezimes","piezīmes","F","f"],"")
      };
    }

    async function fetchRowById(id){
      const base=`${WEBAPP_URL}?sheet=${encodeURIComponent(SHEET_NAME)}&id=${encodeURIComponent(id)}`;
      try{ const r=await fetch(base,{cache:"no-store"}); const j=await r.json(); if(j?.ok){const m=mapPayload(j); if(m) return m;} }catch(_){}
      const j=await jsonp(base); if(j?.ok){const m=mapPayload(j); if(m) return m;}
      throw new Error("Dati nav atgriezti");
    }

    async function resolveImageForId(row){
      const id=row.id;
      if(row.imageDataUrl){
        try{localStorage.setItem(`sfs:img:${id}`,row.imageDataUrl);}catch{}
        try{document.cookie=`sfs_img_${id}=1;path=/;SameSite=Lax;max-age=${60*60*24*365}`;}catch{}
        return row.imageDataUrl;
      }
      if(row.image){
        return await getCachedImageForId(id,row.image);
      }
      return "";
    }

    async function run(id){
      setSkeleton(); $("#subInfo").textContent="Ielāde…";
      try{
        const row=await fetchRowById(id);

        // Kanonizējam ID – saglabājam un ieliekam URL
        const canonicalId = row.id || id;
        persistId(canonicalId);
        ensureUrlHasId(canonicalId);

        fillUI(row);

        const src=await resolveImageForId(row);
        if(src){
          $("#imgFront").src = src;
          $("#imgBack").src  = src;
        }

        $("#subInfo").textContent="Gatavs";
      }catch(e){
        console.error(e);
        fillUI({name:"",motto:"",task:"",notes:""});
        $("#imgFront").src = ""; $("#imgBack").src = "";
        $("#subInfo").innerHTML="Neizdevās ielādēt datus. Pārbaudi ID un GAS webapp.";
        toast("Datu ielāde neizdevās");
      }finally{ reveal(); }
    }

    (function init(){
      const dialog=$("#idDialog"), idInput=$("#idInput");
      const urlId=qs.get("id"); const saved=readPersistedId(); const id=urlId||saved;

      document.getElementById("saveIdBtn").addEventListener("click",()=>{
        const v=idInput.value.trim();
        if(!v){toast("Ievadi ID");return;}
        persistId(v);
        ensureUrlHasId(v);
        dialog.close();
        run(v);
      });

      if(id){
        if(!urlId) ensureUrlHasId(id);
        persistId(id);
        run(id);
      }else{
        reveal(); dialog.showModal();
      }
    })();
  </script>
</body>
</html>