<!doctype html>
<html lang="lv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>STEEL, FIRE & STEAK</title>

  <!-- iOS/PWA noskaņa -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#0b0c10">

  <style>
    :root{
      --bg-1:#0b0c10; --bg-2:#14161d; --ember:#f25f3a; --steel:#7f8c9a;
      --text:#e8e9ef; --muted:#a7adba; --border:#ffffff24; --radius:18px;
      --blur:14px; --shadow:0 10px 30px rgba(0,0,0,.35), 0 1px 0 rgba(255,255,255,.02) inset;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--text);
      font:16px/1.45 -apple-system,BlinkMacSystemFont,"SF Pro Text","Segoe UI",Roboto,"Helvetica Neue",Arial,system-ui,sans-serif;
      background:
        radial-gradient(1200px 800px at 20% -10%, #f25f3a22 0%, transparent 60%),
        radial-gradient(900px 700px at 90% 110%, #ffcf6a14 0%, transparent 60%),
        linear-gradient(180deg,var(--bg-1),var(--bg-2));
      overflow-x:hidden;
    }
    .wrap{ min-height:100dvh; display:flex; align-items:center; justify-content:center; padding:clamp(16px,3vw,32px); }
    .card{
      width:min(920px,100%); border-radius:var(--radius);
      background:linear-gradient(180deg, #ffffff12, #ffffff08);
      border:1px solid var(--border); backdrop-filter:saturate(130%) blur(var(--blur));
      box-shadow:var(--shadow); padding:clamp(18px,3vw,28px);
      transform:translateY(-18px); opacity:0;
      transition:transform .7s cubic-bezier(.2,.75,.2,1), opacity .7s ease;
    }
    .card.reveal{ transform:translateY(0); opacity:1; }

    header{ text-align:center; padding:6px 8px 12px; }
    header h1{
      margin:0; letter-spacing:.14em; font-weight:700; font-size:clamp(18px,3.8vw,28px);
      text-transform:uppercase; color:#fff;
      text-shadow:0 1px 0 rgba(255,255,255,.05), 0 12px 30px rgba(0,0,0,.35);
    }
    header .sub{ margin-top:6px; color:var(--muted); font-size:13px; letter-spacing:.08em; }

    .topbar{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .actions{ display:flex; gap:8px; }
    .chip{
      border:1px solid var(--border); background:#ffffff10; color:#fff;
      padding:8px 10px; border-radius:100px; font-size:12px; letter-spacing:.08em; text-transform:uppercase;
      cursor:pointer; user-select:none;
    }

    /* Rotējošais PNG */
    .stage{ perspective:1200px; margin:18px auto 10px; width:100%; display:grid; place-items:center; }
    .badge{ position:relative; width:min(340px,68vw); aspect-ratio:1/1; transform-style:preserve-3d; filter:drop-shadow(0 24px 60px rgba(242,95,58,.18)); }
    .halo{ position:absolute; inset:-10%; border-radius:50%; background:radial-gradient(circle at 50% 50%, #f25f3a33, transparent 60%); filter:blur(30px); transform:translateZ(-60px) scale(1.05); pointer-events:none; }
    .spin{ width:100%; height:100%; display:block; object-fit:contain; transform-origin:50% 50%; animation:spinY 12s linear infinite; will-change:transform; backface-visibility:hidden; }
    @keyframes spinY{ from{ transform:rotateY(0deg) } to{ transform:rotateY(360deg) } }

    .grid{ display:grid; gap:14px; margin-top:8px; }
    .row{ border:1px solid var(--border); background:linear-gradient(180deg, #0d0f1311, #0d0f1307); border-radius:calc(var(--radius) - 8px); padding:16px 18px; }
    .label{ font-size:12px; letter-spacing:.14em; text-transform:uppercase; color:var(--steel); margin-bottom:6px; }
    .value{ font-size:clamp(18px,4.2vw,22px); font-weight:600; color:#fff; }
    .value.monospace{ font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace; font-weight:500; color:#d8dde6; font-size:14px; }
    .value.note{ white-space:pre-wrap; color:#e9e9ee; font-weight:500; }

    /* skeleton */
    .skeleton{ position:relative; overflow:hidden; background:#ffffff0f; border-radius:12px; height:1.2em; display:inline-block; min-width:120px; }
    .skeleton::after{ content:""; position:absolute; inset:0; background:linear-gradient(90deg, transparent, #ffffff22, transparent); animation:shimmer 1.1s infinite; }
    @keyframes shimmer{ from{ transform:translateX(-100%) } to{ transform:translateX(100%) } }

    /* toast */
    .toast{
      position:fixed; left:50%; bottom:20px; transform:translateX(-50%) translateY(20px);
      background:#111418ee; color:#fff; padding:10px 14px; border-radius:12px; border:1px solid #ffffff22;
      box-shadow:0 6px 20px rgba(0,0,0,.35); opacity:0; pointer-events:none; transition:.35s; font-size:14px;
    }
    .toast.show{ opacity:1; transform:translateX(-50%) translateY(0); }

    /* ID modālis */
    dialog{ border:none; padding:0; background:transparent; }
    .modal{
      width:min(540px,92vw); border-radius:16px;
      background:linear-gradient(180deg, #0f1217ee, #0e1014ee);
      border:1px solid #ffffff2a; backdrop-filter:blur(16px);
      padding:18px; color:#fff; box-shadow:0 30px 80px rgba(0,0,0,.55);
    }
    .modal h3{ margin:0 0 10px; font-size:18px; letter-spacing:.06em; }
    .modal .row{ background:transparent; border:none; padding:0; }
    .modal input{
      width:100%; font:600 18px/1.2 ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;
      color:#fff; background:#ffffff10; border:1px solid #ffffff22; border-radius:12px; padding:12px 14px; outline:none;
    }
    .modal button{
      margin-top:12px; width:100%; appearance:none; border:none; cursor:pointer;
      border-radius:12px; padding:12px 14px; font-weight:700; letter-spacing:.06em; text-transform:uppercase;
      background:linear-gradient(180deg, #f66a41, #e35631); color:#fff; box-shadow:0 10px 26px rgba(242,95,58,.35);
    }

    @media (min-width:720px){
      .grid{ grid-template-columns:1fr 1fr; }
      .row.notes{ grid-column:1 / -1; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <main class="card" id="card">
      <header>
        <div class="topbar">
          <h1>STEEL, FIRE &amp; STEAK</h1>
          <div class="actions">
            <button class="chip" id="shareBtn" title="Kopēt saiti ar ID">Kopēt saiti</button>
            <button class="chip" id="switchIdBtn" title="Mainīt ID">Mainīt ID</button>
          </div>
        </div>
        <div class="sub" id="subInfo">Ielāde…</div>
      </header>

      <section class="stage" aria-label="Rotējošais attēls">
        <div class="badge">
          <div class="halo" aria-hidden="true"></div>
          <img id="personImage" class="spin" alt="Attēls" src="" />
        </div>
      </section>

      <section class="grid">
        <div class="row">
          <div class="label">Vārds</div>
          <div id="name" class="value"><span class="skeleton" style="width:40%"></span></div>
        </div>

        <div class="row">
          <div class="label">Uzdevums</div>
          <div id="task" class="value"><span class="skeleton" style="width:80%"></span></div>
        </div>

        <div class="row notes">
          <div class="label">Piezīmes</div>
          <div id="notes" class="value note"><span class="skeleton" style="width:95%"></span></div>
        </div>

        <div class="row">
          <div class="label">ID</div>
          <div id="idOut" class="value monospace"><span class="skeleton" style="width:120px"></span></div>
        </div>
      </section>
    </main>
  </div>

  <div class="toast" id="toast"></div>

  <!-- ID dialogs -->
  <dialog id="idDialog">
    <div class="modal">
      <h3>Ieraksti dalībnieka ID</h3>
      <div class="row">
        <input id="idInput" type="text" inputmode="numeric" placeholder="piem., 101" autofocus />
      </div>
      <button id="saveIdBtn">Apstiprināt</button>
    </div>
  </dialog>

  <script>
    // === KONFIGS ===
    const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbxqumDDgdZMnjps9ZBEQIu5s40958y609r4taVT9VYEtlNJTdOJ3fPnDxqHnPl4YQMU/exec";
    const SHEET_NAME = "SFS";

    // === UTIL ===
    const qs = new URLSearchParams(location.search);
    const $ = sel => document.querySelector(sel);

    function toast(msg, t=2200){
      const el = $("#toast"); el.textContent = msg;
      el.classList.add("show"); setTimeout(()=>el.classList.remove("show"), t);
    }
    function persistId(id){ try{ localStorage.setItem("sfs:id", String(id)); }catch{} }
    function readPersistedId(){ try{ return localStorage.getItem("sfs:id") || ""; }catch{ return ""; } }
    function buildShareUrl(id){ const u = new URL(location.href); u.searchParams.set("id", id); return u.toString(); }
    function reveal(){ requestAnimationFrame(()=> $("#card").classList.add("reveal")); }

    // JSONP fallback (CORS drošībai)
    function jsonp(url, timeout=6000){
      return new Promise((resolve,reject)=>{
        const cbName = "__sfs_cb_"+Math.random().toString(36).slice(2);
        const scr = document.createElement("script");
        const tm = setTimeout(()=>{ cleanup(); reject(new Error("JSONP timeout")); }, timeout);
        function cleanup(){
          clearTimeout(tm);
          delete window[cbName];
          scr.remove();
        }
        window[cbName] = (data)=>{ cleanup(); resolve(data); };
        const u = new URL(url);
        u.searchParams.set("callback", cbName);
        scr.src = u.toString();
        scr.onerror = ()=>{ cleanup(); reject(new Error("JSONP load error")); };
        document.head.appendChild(scr);
      });
    }

    function setSkeleton(on){
      const ids = ["#name","#task","#notes","#idOut"];
      for(const sel of ids){
        const node = document.querySelector(sel);
        if(on) node.innerHTML = `<span class="skeleton" style="width:${sel==="#idOut"?"120px":"90%"}"></span>`;
      }
    }

    function fillUI({id, name, image, task, notes}){
      const fallbackPNG = "data:image/svg+xml;utf8," + encodeURIComponent(`
        <svg xmlns='http://www.w3.org/2000/svg' width='800' height='800' viewBox='0 0 800 800'>
          <defs><linearGradient id='g' x1='0' x2='1' y1='0' y2='1'><stop offset='0' stop-color='#f25f3a'/><stop offset='1' stop-color='#7f8c9a'/></linearGradient></defs>
          <rect width='800' height='800' rx='160' ry='160' fill='url(#g)'/>
          <text x='50%' y='52%' font-family='SF Pro, system-ui, sans-serif' font-size='70' fill='white' text-anchor='middle' dominant-baseline='middle'>S F S</text>
        </svg>
      `);
      $("#personImage").src = image || fallbackPNG;
      $("#name").textContent = name || "—";
      $("#task").textContent = task || "—";
      $("#notes").textContent = notes || "—";
      $("#idOut").textContent = id || "—";
      $("#subInfo").innerHTML = name ? `Dalībnieks: <strong>${name}</strong>` : "&nbsp;";
    }

    function mapPayload(payload){
      const r = payload?.data || payload?.row || payload?.item || payload;
      const row = Array.isArray(r) ? r[0] : r;
      if(!row) return null;

      const pick = (o, keys, fb="") => { for(const k of keys){ if(o?.[k]!=null && o[k]!=="") return String(o[k]); } return fb; };
      return {
        id:    pick(row, ["id","ID","a","A"], ""),
        name:  pick(row, ["vards","vārds","name","B","b"], ""),
        image: pick(row, ["attels","attēls","image","img","C","c"], ""),
        task:  pick(row, ["uzdevums","task","D","d"], ""),
        notes: pick(row, ["notes","piezimes","piezīmes","E","e"], "")
      };
    }

    async function fetchRowById(id){
      const base = `${WEBAPP_URL}?sheet=${encodeURIComponent(SHEET_NAME)}&id=${encodeURIComponent(id)}`;
      // 1) mēģinām JSON
      try{
        const res = await fetch(base, {cache:"no-store"});
        const data = await res.json();
        if(data?.ok){ const mapped = mapPayload(data); if(mapped) return mapped; }
      }catch(_){ /* turpinām ar JSONP */ }
      // 2) JSONP drošais ceļš
      const data = await jsonp(base);
      if(data?.ok){ const mapped = mapPayload(data); if(mapped) return mapped; }
      throw new Error("Dati nav atgriezti");
    }

    function preload(src){
      return new Promise((resolve)=>{ if(!src) return resolve(); const i = new Image(); i.onload=resolve; i.onerror=resolve; i.src=src; });
    }

    // UI elementi
    const dialog = $("#idDialog");
    const idInput = $("#idInput");
    $("#saveIdBtn").addEventListener("click", ()=>{
      const id = idInput.value.trim();
      if(!id){ toast("Ievadi ID"); return; }
      persistId(id); dialog.close(); run(id);
    });
    $("#switchIdBtn").addEventListener("click", ()=>{ idInput.value=""; dialog.showModal(); setTimeout(()=> idInput.focus(), 50); });
    $("#shareBtn").addEventListener("click", async ()=>{
      const id = $("#idOut").textContent.trim();
      if(!id || id==="—"){ toast("ID nav ielādēts"); return; }
      const url = buildShareUrl(id);
      try{ await navigator.clipboard.writeText(url); toast("Saite ar ID nokopēta"); }
      catch{ toast(url); }
    });

    async function run(id){
      setSkeleton(true); $("#subInfo").textContent = "Ielāde…";
      try{
        const row = await fetchRowById(id);
        persistId(row.id || id);
        await preload(row.image);
        fillUI(row);
        $("#subInfo").textContent = "Gatavs";
      }catch(e){
        console.error(e);
        fillUI({id, name:"", image:"", task:"", notes:""});
        $("#subInfo").innerHTML = `Neizdevās ielādēt datus. Pārbaudi ID un GAS webapp.`;
        toast("Datu ielāde neizdevās");
      }finally{ reveal(); }
    }

    // Starta plūsma
    (function init(){
      const urlId = qs.get("id");
      const saved = readPersistedId();
      const id = urlId || saved;
      if(id){ if(urlId && urlId!==saved) persistId(urlId); run(id); }
      else{ reveal(); dialog.showModal(); }
    })();
  </script>
</body>
</html>