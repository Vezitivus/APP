<!DOCTYPE html>
<html lang="lv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VEZITIVUS GAME HOST</title>
  <style>
    /* iOS/Apple stilizācija */
    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background-color: #f2f2f7;
      color: #333;
    }
    /* Fiksēts virsraksts ar caurspīdīgu fonu */
    #header {
      position: fixed;
      top: 0;
      width: 100%;
      background-color: rgba(0,0,0,0.5);
      color: #fff;
      text-align: center;
      font-size: 1.5rem;
      padding: 1rem;
      z-index: 999;
    }
    /* Saturs – ar atstarpi no fiksētā virsraksta */
    .content {
      padding-top: 80px;
      max-width: 800px;
      margin: 0 auto;
      padding-left: 1rem;
      padding-right: 1rem;
    }
    /* Ievades lauki un pogas stils */
    .input-section {
      margin-bottom: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    .input-section label {
      font-weight: 600;
    }
    select, input[type="number"] {
      font-size: 1rem;
      padding: 0.5rem;
      border-radius: 8px;
      border: 1px solid #ccc;
      outline: none;
    }
    button {
      font-size: 1rem;
      padding: 0.6rem 1rem;
      border: none;
      border-radius: 8px;
      background: #007aff;
      color: #fff;
      cursor: pointer;
      transition: background 0.2s ease;
    }
    button:hover {
      background: #005bbf;
    }
    /* Komandu konteineri */
    #teamsContainer {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin-bottom: 1rem;
    }
    .team-block {
      flex: 1 1 200px;
      background-color: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      padding: 1rem;
      min-width: 180px;
    }
    .team-block h3 {
      margin-top: 0;
      font-size: 1.1rem;
      margin-bottom: 0.5rem;
      text-align: center;
    }
    .team-score-input {
      display: block;
      margin: 0 auto 0.5rem auto;
      text-align: center;
      font-size: 1rem;
      padding: 0.3rem;
      border-radius: 8px;
      border: 1px solid #ccc;
      width: 60%;
      outline: none;
    }
    /* Dropzone – vieta, kur nomest spēlētājus */
    .dropzone {
      border: 2px dashed #ccc;
      border-radius: 8px;
      min-height: 80px;
      padding: 0.5rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      justify-content: center;
      align-items: center;
    }
    .dropzone.hover {
      border-color: #007aff;
    }
    /* Spēlētāju saraksta konteiners */
    #playersContainer {
      background-color: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      padding: 1rem;
      margin-bottom: 1rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }
    /* Spēlētāja "kartīte" */
    .player-card {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background-color: #007aff;
      color: #fff;
      padding: 0.5rem;
      border-radius: 8px;
      min-width: 80px;
      text-align: center;
      cursor: grab;
      -webkit-user-select: none;
      user-select: none;
    }
    .player-card:active {
      cursor: grabbing;
    }
    .player-uid {
      font-weight: 600;
      font-size: 0.9rem;
    }
    .player-name {
      font-size: 0.8rem;
    }
    /* Saglabāt rezultātu poga (sākotnēji slēpta) */
    #saveResults {
      display: none;
      margin-bottom: 2rem;
    }
    .footer-space {
      height: 80px;
    }
  </style>
</head>
<body>
  <div id="header">VEZITIVUS GAME HOST</div>
  <div class="content">
    <!-- Aktivitāšu izvēle -->
    <div class="input-section">
      <label for="activitySelect">Izvēlies aktivitāti:</label>
      <select id="activitySelect"></select>
    </div>
    <!-- Komandu skaita ievade -->
    <div class="input-section">
      <label for="teamCountInput">Cik komandas izveidot?</label>
      <input type="number" id="teamCountInput" min="0" value="0" />
      <button id="createTeamsBtn">Izveidot komandas</button>
    </div>
    <!-- Komandu laukumi -->
    <div id="teamsContainer"></div>
    <!-- Spēlētāju saraksts (dati no Google Sheets) -->
    <div id="playersContainer"></div>
    <!-- Saglabāt rezultātu poga -->
    <button id="saveResults">Saglabāt rezultātus</button>
    <div class="footer-space"></div>
  </div>

  <script>
    /******************************************
     * Aizstājiet ar savu Google Apps Script Web App URL:
     ******************************************/
    const GS_URL = "https://script.google.com/macros/s/AKfycbwvbYSracMlNJ2dhhD74EtX2FjJ0ASsDcZBy7qGm9V-kgOWIoybclFSJN1dJ6TFmM-S/exec";

    // Dati no Sheets (lokāli glabāsim)
    let allActivities = [];  // Tiks ielādētas no mode=activities
    let allPlayers = [];     // Tiks ielādēti no mode=players
    let teams = [];          // Komandu info

    // HTML elementu references
    let activitySelect, teamCountInput, createTeamsBtn, teamsContainer, playersContainer, saveResultsBtn;

    window.addEventListener("DOMContentLoaded", init);

    function init() {
      activitySelect   = document.getElementById("activitySelect");
      teamCountInput   = document.getElementById("teamCountInput");
      createTeamsBtn   = document.getElementById("createTeamsBtn");
      teamsContainer   = document.getElementById("teamsContainer");
      playersContainer = document.getElementById("playersContainer");
      saveResultsBtn   = document.getElementById("saveResults");

      if (createTeamsBtn) {
        createTeamsBtn.addEventListener("click", onCreateTeamsClick);
      }
      if (saveResultsBtn) {
        saveResultsBtn.addEventListener("click", onSaveResultsClick);
      }

      // Ielādē aktivitātes
      fetchActivities()
        .then(activities => {
          allActivities = activities;
          populateActivitySelect();
        })
        .catch(err => console.error("Error in fetchActivities:", err));

      // Ielādē spēlētājus
      fetchPlayers()
        .then(players => {
          allPlayers = players;
          renderPlayers(players);
        })
        .catch(err => console.error("Error in fetchPlayers:", err));
    }

    /******************************
     * 1) Ielādē aktivitātes no Sheets (mode=activities)
     ******************************/
    function fetchActivities() {
      const url = GS_URL + "?mode=activities";
      return fetch(url)
        .then(res => res.json())
        .then(json => {
          if (json.success) {
            return json.activities; // masīvs ar aktivitāšu nosaukumiem
          } else {
            throw new Error(json.error || "Unknown fetchActivities error");
          }
        });
    }

    /******************************
     * 2) Ielādē spēlētājus no Sheets (mode=players)
     ******************************/
    function fetchPlayers() {
      const url = GS_URL + "?mode=players";
      return fetch(url)
        .then(res => res.json())
        .then(json => {
          if (json.success) {
            return json.players; // masīvs ar {uid,name}
          } else {
            throw new Error(json.error || "Unknown fetchPlayers error");
          }
        });
    }

    /******************************
     * Aizpilda aktivitāšu <select> ar ielādētajām vērtībām
     ******************************/
    function populateActivitySelect() {
      activitySelect.innerHTML = "";
      if (!allActivities || allActivities.length === 0) {
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "Nav pieejamu aktivitāšu";
        activitySelect.appendChild(opt);
        return;
      }
      allActivities.forEach(act => {
        const opt = document.createElement("option");
        opt.value = act;
        opt.textContent = act;
        activitySelect.appendChild(opt);
      });
      activitySelect.selectedIndex = 0;
    }

    /******************************
     * Attēlo spēlētājus #playersContainer
     ******************************/
    function renderPlayers(players) {
      playersContainer.innerHTML = "";
      players.forEach(player => {
        const card = createPlayerCard(player);
        playersContainer.appendChild(card);
      });
    }

    /******************************
     * Izveido vienu spēlētāja "kartīti"
     ******************************/
    function createPlayerCard(player) {
      const div = document.createElement("div");
      div.classList.add("player-card");
      div.draggable = true;
      div.dataset.uid = player.uid;
      div.dataset.name = player.name;

      // Drag start
      div.addEventListener("dragstart", onPlayerDragStart);

      const uidEl = document.createElement("div");
      uidEl.classList.add("player-uid");
      uidEl.textContent = player.uid;

      const nameEl = document.createElement("div");
      nameEl.classList.add("player-name");
      nameEl.textContent = player.name;

      div.appendChild(uidEl);
      div.appendChild(nameEl);
      return div;
    }

    /******************************
     * Komandu veidošanas loģika
     ******************************/
    function onCreateTeamsClick() {
      const count = parseInt(teamCountInput.value) || 0;
      generateTeams(count);
    }

    function generateTeams(count) {
      teamsContainer.innerHTML = "";
      teams = [];

      for (let i = 0; i < count; i++) {
        const teamId = "team_" + i;
        const team = {
          id: teamId,
          name: `Komanda ${i + 1}`,
          score: "",
          players: []
        };
        teams.push(team);

        // HTML
        const teamBlock = document.createElement("div");
        teamBlock.classList.add("team-block");

        const h3 = document.createElement("h3");
        h3.textContent = team.name;

        const scoreInput = document.createElement("input");
        scoreInput.type = "text";
        scoreInput.placeholder = "Punkti";
        scoreInput.classList.add("team-score-input");
        scoreInput.addEventListener("input", onScoreInput);

        const dropzone = document.createElement("div");
        dropzone.classList.add("dropzone");
        dropzone.addEventListener("dragover", onDragOver);
        dropzone.addEventListener("drop", onDrop);

        teamBlock.appendChild(h3);
        teamBlock.appendChild(scoreInput);
        teamBlock.appendChild(dropzone);
        teamsContainer.appendChild(teamBlock);
      }
    }

    /******************************
     * Drag un Drop notikumi
     ******************************/
    function onPlayerDragStart(e) {
      e.dataTransfer.setData("text/plain", JSON.stringify({
        uid: e.target.dataset.uid,
        name: e.target.dataset.name
      }));
    }

    function onDragOver(e) {
      e.preventDefault();
      e.currentTarget.classList.add("hover");
    }

    function onDrop(e) {
      e.preventDefault();
      e.currentTarget.classList.remove("hover");

      const data = e.dataTransfer.getData("text/plain");
      if (data) {
        try {
          const player = JSON.parse(data);
          const card = createPlayerCard(player);
          removePlayerCardFromTeams(player.uid);
          removePlayerCardFromContainer(player.uid, playersContainer);
          e.currentTarget.appendChild(card);
        } catch (error) {
          console.error("onDrop error:", error);
        }
      }
    }

    /******************************
     * Noņem spēlētāju no komandas dropzone
     ******************************/
    function removePlayerCardFromTeams(uid) {
      const dropzones = teamsContainer.querySelectorAll(".dropzone");
      dropzones.forEach(dz => {
        const existingCard = dz.querySelector(`.player-card[data-uid="${uid}"]`);
        if (existingCard) {
          dz.removeChild(existingCard);
        }
      });
    }

    /******************************
     * Noņem spēlētāju no "playersContainer" (sākotnējā)
     ******************************/
    function removePlayerCardFromContainer(uid, container) {
      const existingCard = container.querySelector(`.player-card[data-uid="${uid}"]`);
      if (existingCard) {
        container.removeChild(existingCard);
      }
    }

    /******************************
     * Kad ievada punktus, pārbaudām, vai jārāda "Saglabāt"
     ******************************/
    function onScoreInput() {
      checkIfShowSaveButton();
    }

    function checkIfShowSaveButton() {
      const scoreInputs = teamsContainer.querySelectorAll(".team-score-input");
      let anyScore = false;
      scoreInputs.forEach(inp => {
        if (inp.value.trim() !== "") {
          anyScore = true;
        }
      });
      saveResultsBtn.style.display = anyScore ? "inline-block" : "none";
    }

    /******************************
     * "Saglabāt rezultātus" klikšķis
     ******************************/
    function onSaveResultsClick() {
      const teamBlocks = teamsContainer.querySelectorAll(".team-block");
      let calls = []; // saglabāsim "fetch" solījumus

      teamBlocks.forEach(block => {
        const scoreInput = block.querySelector(".team-score-input");
        const dropzone = block.querySelector(".dropzone");
        const score = scoreInput.value.trim();
        const cards = dropzone.querySelectorAll(".player-card");

        cards.forEach(card => {
          const uid = card.dataset.uid;
          // izsūtām GET parametru ?uid=..., activity=..., points=...
          // (Dinamisku rindu meklē servera puse, pamatojoties uz UID kolonu un activity)
          const url = GS_URL + `?uid=${encodeURIComponent(uid)}`
                        + `&activity=${encodeURIComponent(activitySelect.value)}`
                        + `&points=${encodeURIComponent(score)}`;

          calls.push(
            fetch(url).then(r => r.json()).then(resp => {
              if (!resp.success) {
                throw new Error(resp.error || "Save error");
              }
              return resp; // { success: true, ... }
            })
          );
        });
      });

      if (calls.length === 0) {
        alert("Nav spēlētāju, kam saglabāt rezultātus!");
        return;
      }

      saveResultsBtn.disabled = true;
      Promise.all(calls)
        .then(() => {
          alert("Rezultāti saglabāti veiksmīgi!");
        })
        .catch(err => {
          console.error("Kļūda saglabājot rezultātus:", err);
          alert("Kļūda saglabājot rezultātus.");
        })
        .finally(() => {
          saveResultsBtn.disabled = false;
        });
    }
  </script>
</body>
</html>
