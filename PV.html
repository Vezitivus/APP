<!DOCTYPE html>
<html lang="lv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>PV</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <style>
    :root{
      --bg:#f2f2f7; --card:#ffffff; --text:#111827; --muted:#6c6c70;
      --accent:#007aff; --ok:#34c759; --err:#ff3b30; --ring:#d1d1d6; --border:#e5e5ea;
      --radius:14px; --shadow:0 8px 28px rgba(17,24,39,.08);
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      -webkit-font-smoothing:antialiased;}
    .wrap{max-width:720px;margin:0 auto;padding:16px 16px calc(24px + env(safe-area-inset-bottom))}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
    .title{font-size:28px;font-weight:800;margin:0 0 10px}
    .muted{color:var(--muted)}
    .hidden{display:none !important}
    .topbar{
      position:sticky;top:0;z-index:5;
      background:rgba(242,242,247,.86);backdrop-filter:saturate(180%) blur(14px);
      border-bottom:1px solid var(--border); padding:12px 8px;margin:-8px 0 12px;
    }
    .topbar .big{font-size:22px;font-weight:800}
    input,textarea,button{
      width:100%;border-radius:12px;border:1px solid var(--ring);
      background:#fff;color:var(--text);padding:12px 14px;font-size:16px;outline:none;
    }
    textarea{min-height:84px;resize:vertical}
    .btn{cursor:pointer;border:none;font-weight:700;border-radius:12px;padding:12px 14px}
    .btn-primary{background:var(--accent);color:#fff}
    .btn-ok{background:var(--ok);color:#fff}
    .btn-err{background:var(--err);color:#fff}
    .btn-ghost{background:#fff;border:1px solid var(--ring);color:var(--text)}
    .list{display:grid;gap:10px}
    .task{display:flex;flex-direction:column;gap:8px;transition:opacity .15s ease, filter .15s ease}
    .badge{display:inline-block;padding:4px 8px;border:1px solid var(--ring);border-radius:10px;font-size:12px;margin-right:6px;background:#fff}
    .b-idle{background:#fff}
    .b-pending{background:#e7f0ff;border-color:#bcd3ff}
    .b-approved{background:#e7f9ee;border-color:#bfeccf}
    .b-rejected{background:#ffe9ea;border-color:#ffd0d3}
    .dim{opacity:.45; filter:grayscale(.25)}
    .dots{display:inline-flex;gap:6px;align-items:center;justify-content:center;margin:10px 0}
    .dot{width:8px;height:8px;border-radius:50%;background:#c7c7cc;animation:jump 1s infinite}
    .dot:nth-child(2){animation-delay:.15s}.dot:nth-child(3){animation-delay:.3s}
    @keyframes jump{0%,80%,100%{transform:translateY(0)}40%{transform:translateY(-6px)}}
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.25);display:flex;align-items:center;justify-content:center;padding:16px;z-index:50}
    .sheet{max-width:520px;width:100%;background:var(--card);border:1px solid var(--border);border-radius:18px;box-shadow:0 24px 48px rgba(0,0,0,.18);padding:16px;transform:scale(.94);opacity:0;animation:pop .16s cubic-bezier(.2,.7,.2,1) forwards}
    @keyframes pop{to{transform:scale(1);opacity:1}}
    /* MedaÄ¼as */
    #medal-overlay{position:fixed;inset:0;z-index:60;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.35);padding:16px}
    .coin-wrap{position:relative;width:min(90vw,520px);height:min(90vw,520px);display:flex;align-items:center;justify-content:center;perspective:1200px}
    .coin{width:70%; height:70%; border-radius:50%; position:relative; transform-style:preserve-3d; animation:spin 2.2s linear infinite; box-shadow:0 20px 60px rgba(0,0,0,.3);}
    .edge{position:absolute; inset:0; border-radius:50%; transform:translateZ(-12px);}
    .face{position:absolute; inset:0; border-radius:50%; display:flex;align-items:center;justify-content:center;font-weight:900; text-align:center; padding:24px; transform:translateZ(12px); -webkit-backface-visibility:hidden; backface-visibility:hidden; text-shadow:0 2px 6px rgba(0,0,0,.25);}
    .face.back{ transform:rotateY(180deg) translateZ(12px);}
    .gold{ background:radial-gradient(circle at 30% 30%, #fff7ba 0%, #f1c40f 35%, #b8860b 75%); }
    .silver{ background:radial-gradient(circle at 30% 30%, #ffffff 0%, #d7dee3 35%, #9aa4ad 75%); }
    .bronze{ background:radial-gradient(circle at 30% 30%, #ffdcb3 0%, #cd7f32 35%, #8a4b1f 75%); }
    .coin.gold .edge{ background:repeating-linear-gradient(90deg, rgba(120,90,0,.25) 0 2px, rgba(255,230,140,.25) 2px 4px); }
    .coin.silver .edge{ background:repeating-linear-gradient(90deg, rgba(60,60,60,.25) 0 2px, rgba(240,240,240,.25) 2px 4px); }
    .coin.bronze .edge{ background:repeating-linear-gradient(90deg, rgba(100,50,0,.25) 0 2px, rgba(255,200,140,.25) 2px 4px); }
    @keyframes spin{ from{ transform:rotateY(0deg); } to{ transform:rotateY(360deg);} }
    #plain-done{position:fixed; left:50%; bottom:24px; transform:translateX(-50%); background:#111827; color:#fff; padding:10px 14px; border-radius:12px; z-index:61; display:none; box-shadow:0 10px 30px rgba(0,0,0,.3)}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- 1) VÄrds -->
    <section id="v-start">
      <div class="card">
        <div class="title">Ievadi vÄrdu</div>
        <input id="name" placeholder="VÄrds" autocomplete="off" />
        <div style="height:10px"></div>
        <button id="btn-name" class="btn btn-primary">TurpinÄt</button>
      </div>
    </section>

    <!-- 2) 4 lauki -->
    <section id="v-form" class="hidden">
      <div class="topbar"><div class="big">4 lauki</div></div>
      <div class="card">
        <div class="list">
          <textarea id="f1" placeholder="AsociÄcija ar kuru kursa biedram tevi atpazÄ«t."></textarea>
          <textarea id="f2" placeholder="Labs darbs ko izdarÄ«t visam kursam pidÅ¾amballÄ«tes laikÄ."></textarea>
          <textarea id="f3" placeholder="Uzdevums pret mani"></textarea>
          <textarea id="f4" placeholder="Visa vakara likums"></textarea>
          <button id="btn-ready" class="btn btn-ok">Gatavs spÄ“lei</button>
        </div>
      </div>
    </section>

    <!-- 3) Lobby -->
    <section id="v-lobby" class="hidden">
      <div class="card" style="text-align:center">
        <div class="title" style="font-size:22px;margin-bottom:6px">GaidÄm pÄrÄ“josâ€¦</div>
        <div class="dots" aria-hidden="true"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
        <div class="muted" id="lobby-info">â€”</div>
        <div style="height:12px"></div>
        <button id="btn-edit" class="btn btn-ghost">Labot laukus</button>
      </div>
    </section>

    <!-- 4) SpÄ“le -->
    <section id="v-game" class="hidden">
      <div class="topbar"><div class="big">SpÄ“le</div></div>
      <div id="tasks" class="list"></div>
      <div id="author-like" class="card hidden">
        <div class="title" style="font-size:18px">Like savam likuma pildÄ«tÄjam</div>
        <div id="author-like-body" class="muted"></div>
        <div style="height:8px"></div>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <button id="btn-like" class="btn btn-ghost">â¤ï¸ Like</button>
          <button id="btn-bheart" class="btn btn-ghost">ğŸ’” Broken heart</button>
        </div>
      </div>
    </section>

    <!-- PaziÅ†ojums apstiprinÄÅ¡anai -->
    <div id="notify" class="overlay hidden" role="dialog" aria-modal="true">
      <div class="sheet">
        <div class="title" id="notif-title" style="font-size:22px">Apstiprini uzdevumu</div>
        <div id="notif-text" style="margin:6px 0 12px"></div>
        <div style="display:flex;gap:10px">
          <button id="btn-accept" class="btn btn-ok">ApstiprinÄt</button>
          <button id="btn-reject" class="btn btn-err">NoraidÄ«t</button>
        </div>
      </div>
    </div>

    <!-- MEDAÄ»U pÄrklÄjums -->
    <div id="medal-overlay">
      <div class="coin-wrap">
        <div id="coin" class="coin gold">
          <div class="edge"></div>
          <div class="face front"><span id="coin-text-front">Tu pirmais pabeidzi uzdevumu!</span></div>
          <div class="face back"><span id="coin-text-back">Tu pirmais pabeidzi uzdevumu!</span></div>
        </div>
      </div>
    </div>

    <!-- VienkÄrÅ¡s â€œpabeigtsâ€ paziÅ†ojums -->
    <div id="plain-done">Uzdevumi pabeigti! ğŸ‰</div>
  </div>

<script>
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbxRDcK7IfOIwDdbPZ9WWxPjmGzC7bE6Arj4BP6VdFXuoQh4sihgwChnMFvt0BHMNV-i/exec";

/* ---------- Klienta stÄvoklis ---------- */
const S = {
  id: localStorage.getItem('pv_playerId') || null,
  name: localStorage.getItem('pv_name') || '',
  currentTaskId: null,
  pulseTimer: null,     // 1s â€œdzÄ«vaisâ€ pulss
  metaVersion: 0,
  ruleRecipient: null,
  lastDoneFlag: localStorage.getItem('pv_lastDoneFlag') === '1',
  lastRank: Number(localStorage.getItem('pv_lastRank') || '0')
};

const $ = id => document.getElementById(id);
const show = id => { ['v-start','v-form','v-lobby','v-game'].forEach(v => $(v).classList.add('hidden')); $(id).classList.remove('hidden'); };
$('name').value = S.name || '';

async function api(action, payload={}) {
  const res = await fetch(WEBAPP_URL, { method:'POST', headers:{'Content-Type':'text/plain'}, body: JSON.stringify({action, ...payload}) });
  const txt = await res.text(); try { return JSON.parse(txt); } catch { return {ok:false,error:'Bad JSON',raw:txt}; }
}

/* ---------- 1) VÄrds ---------- */
async function onName() {
  const name = $('name').value.trim(); if (!name) { $('name').focus(); return; }
  const r = await api('upsertPlayer', { playerId:S.id, name });
  if (!r.ok) return alert(r.error||'KÄ¼Å«da');
  S.id = r.player.id; S.name = r.player.name;
  localStorage.setItem('pv_playerId', S.id);
  localStorage.setItem('pv_name', S.name);
  $('f3').placeholder = `Uzdevums pret ${S.name}`;
  show('v-form');
  ensurePulse();
}
$('btn-name').onclick = onName;
$('name').addEventListener('keydown', e=>{ if(e.key==='Enter') onName(); });

/* ---------- 2) SaglabÄ 4 laukus -> Lobby ---------- */
$('btn-ready').onclick = async ()=>{
  const association = $('f1').value.trim();
  const goodDeed   = $('f2').value.trim();
  const privateT   = $('f3').value.trim();
  const rule       = $('f4').value.trim();
  if (!association || !goodDeed || !privateT || !rule) return alert('Aizpildi visus 4 laukus');
  const r = await api('saveEntriesAndReady', { playerId:S.id, association, goodDeed, privateTask:privateT, rule });
  if (!r.ok) return alert(r.error||'KÄ¼Å«da');
  show('v-lobby'); // tÄlÄk pulse pats pÄrswitchos uz spÄ“li, kad allReady
};

/* ---------- SpÄ“le / Lobby atjaunoÅ¡ana ---------- */
async function openGame(){
  show('v-game');
  await refreshTasks();
  await refreshRuleRecipient();
  ensurePulse();
}

function badge(st){ return `badge ${st==='approved'?'b-approved':st==='pending'?'b-pending':st==='rejected'?'b-rejected':'b-idle'}`; }
function label(f){ return ({1:'AsociÄcija',2:'Labs darbs',3:'PrivÄtais',4:'Likums'})[f]||('#'+f); }
function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' }[m])); }

async function refreshTasks(){
  let r = await api('getMyTasks', { playerId:S.id });
  if (!r.ok) return;
  handleCompletionCue(r.allDone === true, Number(r.rank || 0));

  const tasks = (r.tasks||[]).sort((a,b)=>a.field-b.field);
  const box = $('tasks'); box.innerHTML='';
  tasks.forEach(t=>{
    let foot = '';
    if (t.status==='rejected' && t.decisionReady && t.rejectedCount>0) foot = `<div class="muted">NoraidÄ«ja: ${t.rejectedCount}</div>`;
    const isDim = (t.status==='approved' || t.status==='pending');
    const meta = t.field===3 ? ` Â· autors: ${escapeHtml(t.authorName||'')}` : '';
    const reactions = t.field===4 ? `<div class="muted">â¤ï¸ ${t.likes||0} &nbsp;&nbsp; ğŸ’” ${t.broken||0}</div>` : '';
    const el = document.createElement('div');
    el.className='card task' + (isDim ? ' dim' : '');
    el.innerHTML = `
      <div><span class="${badge(t.status)}">${t.status}</span> <span class="muted">${label(t.field)}${meta}</span></div>
      <div class="title" style="font-size:18px">${escapeHtml(t.text)}</div>
      ${ t.field===4 ? reactions :
        (t.status==='approved' ? `<div class="muted">âœ” ApstiprinÄts</div>` :
          `<div style="display:flex;justify-content:flex-end">
             <button data-f="${t.field}" class="btn btn-primary btn-send" ${t.status==='pending'?'disabled':''}>
               ${t.status==='pending'?'Gaida apstiprinÄjumu':'SÅ«tÄ«t uz apstiprinÄjumu'}
             </button>
           </div>`) }
      ${foot}
    `;
    box.appendChild(el);
  });

  document.querySelectorAll('.btn-send').forEach(b=>{
    b.onclick = async ()=>{
      const f = Number(b.getAttribute('data-f'));
      b.disabled = true; b.textContent = 'Gaida apstiprinÄjumu';
      await api('submitAttempt', { playerId:S.id, field:f });
      // optimistiski â€“ uzreiz atzÄ«mÄ“jam kÄ pending
      await refreshTasks();
    }
  });
}

/* ---- MedaÄ¼u & pabeigÅ¡anas paziÅ†ojumi ---- */
function handleCompletionCue(allDone, rank){
  const prevDone = S.lastDoneFlag;
  if (!prevDone && allDone){
    S.lastDoneFlag = true; localStorage.setItem('pv_lastDoneFlag','1');
    S.lastRank = rank || 0; localStorage.setItem('pv_lastRank', String(S.lastRank||0));
    if (rank===1 || rank===2 || rank===3){
      const cls = rank===1?'gold':rank===2?'silver':'bronze';
      const text = rank===1?'Tu pirmais pabeidzi uzdevumu!':rank===2?'Tu otrais pabeidzi uzdevumus!':'Tu treÅ¡ais pabeidzi uzdevumus!';
      showMedal(cls, text);
    } else showPlainDone();
  }
}
function showMedal(cls, text){
  const o = $('medal-overlay'), c=$('coin');
  c.classList.remove('gold','silver','bronze'); c.classList.add(cls);
  $('coin-text-front').textContent = text;
  $('coin-text-back').textContent = text;
  o.style.display='flex';
  setTimeout(()=>{ o.style.display='none'; }, 5000);
}
function showPlainDone(){
  const t=$('plain-done'); t.style.display='block';
  setTimeout(()=>{ t.style.display='none'; }, 5000);
}

/* ---- Reakcijas (â¤ï¸/ğŸ’”) un autora bloks ---- */
async function refreshRuleRecipient(){
  const r = await api('getInboxAndAuthored', { playerId:S.id });
  if (!r.ok) return;
  const authored = (r.authored||[]).filter(x=>x.field===4);
  if (!authored.length) { $('author-like').classList.add('hidden'); S.ruleRecipient=null; return; }
  const a = authored[0];
  S.ruleRecipient = { id:a.recipientId, name:a.recipientName, likes:a.likes||0, broken:a.broken||0 };
  $('author-like-body').textContent = `${a.recipientName} â€” â¤ï¸ ${a.likes||0} Â· ğŸ’” ${a.broken||0}`;
  $('author-like').classList.remove('hidden');
}
$('btn-like').onclick = async ()=>{
  if (!S.ruleRecipient) return;
  await api('likeRule', { playerId:S.id, toPlayerId:S.ruleRecipient.id });
  await refreshTasks(); await refreshRuleRecipient();
};
$('btn-bheart').onclick = async ()=>{
  if (!S.ruleRecipient) return;
  await api('brokenRule', { playerId:S.id, toPlayerId:S.ruleRecipient.id });
  await refreshTasks(); await refreshRuleRecipient();
};

/* ---- â€œInstantâ€ pulss: 1s, salÄ«dzina meta.version ---- */
function ensurePulse(){
  if (S.pulseTimer) return;
  S.pulseTimer = setInterval(async ()=>{
    if (!S.id) return;
    const p = await api('pulse', { playerId:S.id });
    if (!p.ok) return;
    // Lobby teksti
    if (p.stage==='lobby'){
      $('lobby-info').textContent = `DalÄ«bnieki ar vÄrdu: ${p.total} â€¢ PabeiguÅ¡i 4 laukus: ${p.filled}`;
      if (p.allReady) { await api('ensureAssignments', {}); await openGame(); return; }
      show('v-lobby');
    }
    // Ja versija mainÄ«jusies â€” atjaunojam skatÄ«jumus
    if ((p.version||0) !== S.metaVersion){
      S.metaVersion = p.version||0;
      if (p.stage==='game'){
        await refreshTasks();
        await refreshRuleRecipient();
      }
    }
  }, 1000);
}

/* ---- ApstiprinÄÅ¡anas paziÅ†ojumi ---- */
async function checkInboxOnce(){
  const r = await api('getInboxAndAuthored', { playerId:S.id });
  if (!r.ok) return;
  const inbox = r.inbox||[];
  if (!inbox.length) return;
  const it = inbox[0];
  S.currentTaskId = it.taskId;
  $('notif-title').textContent = 'KÄds izpildÄ«ja uzdevumu â€” apstiprini';
  $('notif-text').textContent = it.text;
  $('notify').classList.remove('hidden');
}
async function handleDecision(type){
  if (!S.currentTaskId) { $('notify').classList.add('hidden'); return; }
  $('btn-accept').disabled = true; $('btn-reject').disabled = true;
  await api(type, { playerId:S.id, taskId:S.currentTaskId });
  $('btn-accept').disabled = false; $('btn-reject').disabled = false;
  $('notify').classList.add('hidden'); S.currentTaskId=null;
  await refreshTasks(); await refreshRuleRecipient();
}
$('btn-accept').onclick = ()=>handleDecision('approve');
$('btn-reject').onclick = ()=>handleDecision('reject');

/* ---- Boot ---- */
(async function boot(){
  if (!S.id || !S.name) { show('v-start'); return; }
  ensurePulse();
  // vienreiz pÄrbaudÄm inbox, lai paziÅ†ojumi negaidÄ«tu lÄ«dz nÄkamajam versijas maiÅ†as pulsam
  setTimeout(checkInboxOnce, 600);
  // pÄrlÄ“ciens uz pareizo skatu atkarÄ«bÄ no stÄvokÄ¼a
  const lobby = await api('getLobby');
  if (lobby.ok && lobby.allReady){ await api('ensureAssignments', {}); return openGame(); }
  const my = await api('getMyTasks', { playerId:S.id });
  if (my.ok && (my.tasks||[]).length) return openGame();
  show('v-lobby');
})();
</script>
</body>
</html>
