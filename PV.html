<!DOCTYPE html>
<html lang="lv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>PV</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <style>
    :root{
      --bg:#f2f2f7; --card:#ffffff; --text:#111827; --muted:#6c6c70;
      --accent:#007aff; --ok:#34c759; --err:#ff3b30; --ring:#d1d1d6; --border:#e5e5ea;
      --radius:14px; --shadow:0 8px 28px rgba(17,24,39,.08);
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      -webkit-font-smoothing:antialiased;}
    .wrap{max-width:720px;margin:0 auto;padding:16px 16px calc(24px + env(safe-area-inset-bottom))}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
    .title{font-size:28px;font-weight:800;margin:0 0 10px}
    .muted{color:var(--muted)}
    .hidden{display:none !important}
    .topbar{
      position:sticky;top:0;z-index:5;
      background:rgba(242,242,247,.86);backdrop-filter:saturate(180%) blur(14px);
      border-bottom:1px solid var(--border); padding:12px 8px;margin:-8px 0 12px;
    }
    .topbar .big{font-size:22px;font-weight:800}
    input,textarea,button{
      width:100%;border-radius:12px;border:1px solid var(--ring);
      background:#fff;color:var(--text);padding:12px 14px;font-size:16px;outline:none;
    }
    textarea{min-height:84px;resize:vertical}
    .btn{cursor:pointer;border:none;font-weight:700;border-radius:12px;padding:12px 14px}
    .btn-primary{background:var(--accent);color:#fff}
    .btn-ok{background:var(--ok);color:#fff}
    .btn-err{background:var(--err);color:#fff}
    .btn-ghost{background:#fff;border:1px solid var(--ring);color:var(--text)}
    .list{display:grid;gap:10px}
    .task{display:flex;flex-direction:column;gap:8px;transition:opacity .15s ease, filter .15s ease}
    .badge{display:inline-block;padding:4px 8px;border:1px solid var(--ring);border-radius:10px;font-size:12px;margin-right:6px;background:#fff}
    .b-idle{background:#fff}
    .b-pending{background:#e7f0ff;border-color:#bcd3ff}
    .b-approved{background:#e7f9ee;border-color:#bfeccf}
    .b-rejected{background:#ffe9ea;border-color:#ffd0d3}
    .dim{opacity:.45; filter:grayscale(.25)}
    /* Pārklājums paziņojumiem */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.25);display:flex;align-items:center;justify-content:center;padding:16px;z-index:50}
    .sheet{max-width:520px;width:100%;background:var(--card);border:1px solid var(--border);border-radius:18px;box-shadow:0 24px 48px rgba(0,0,0,.18);padding:16px;transform:scale(.94);opacity:0;animation:pop .16s cubic-bezier(.2,.7,.2,1) forwards}
    @keyframes pop{to{transform:scale(1);opacity:1}}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- 1) Vārds -->
    <section id="v-start">
      <div class="card">
        <div class="title">Ievadi vārdu</div>
        <input id="name" placeholder="Vārds" autocomplete="off" />
        <div style="height:10px"></div>
        <button id="btn-name" class="btn btn-primary">Turpināt</button>
      </div>
    </section>

    <!-- 2) 4 lauki -->
    <section id="v-form" class="hidden">
      <div class="topbar"><div class="big">4 lauki</div></div>
      <div class="card">
        <div class="list">
          <textarea id="f1" placeholder="Asociācija (kā tevi atpazīt)"></textarea>
          <textarea id="f2" placeholder="Labs darbs (pirms / laikā)"></textarea>
          <textarea id="f3" placeholder="Privātais uzdevums pret mani"></textarea>
          <textarea id="f4" placeholder="Likums (mazs noteikums)"></textarea>
          <button id="btn-ready" class="btn btn-ok">Gatavs spēlei</button>
        </div>
      </div>
    </section>

    <!-- 3) Lobby -->
    <section id="v-lobby" class="hidden">
      <div class="card" style="text-align:center">
        <div class="title" style="font-size:22px;margin-bottom:6px">Gaidām pārējos…</div>
        <div class="muted" id="lobby-info">—</div>
        <div style="height:12px"></div>
        <button id="btn-edit" class="btn btn-ghost">Labot laukus</button>
      </div>
    </section>

    <!-- 4) Spēle -->
    <section id="v-game" class="hidden">
      <div class="topbar"><div class="big">Spēle</div></div>
      <div id="tasks" class="list"></div>
      <div id="author-like" class="card hidden">
        <div class="title" style="font-size:18px">Like savam likuma pildītājam</div>
        <div id="author-like-body" class="muted"></div>
        <div style="height:8px"></div>
        <button id="btn-like" class="btn btn-ghost">❤️ Like</button>
      </div>
    </section>

    <!-- Paziņojumu pārklājums (apstiprināšana) -->
    <div id="notify" class="overlay hidden" role="dialog" aria-modal="true">
      <div class="sheet">
        <div class="title" id="notif-title" style="font-size:22px">Apstiprini uzdevumu</div>
        <div id="notif-text" style="margin:6px 0 12px"></div>
        <div style="display:flex;gap:10px">
          <button id="btn-accept" class="btn btn-ok">Apstiprināt</button>
          <button id="btn-reject" class="btn btn-err">Noraidīt</button>
        </div>
      </div>
    </div>
  </div>

<script>
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbxRDcK7IfOIwDdbPZ9WWxPjmGzC7bE6Arj4BP6VdFXuoQh4sihgwChnMFvt0BHMNV-i/exec";

/* ---------- Klienta stāvoklis ---------- */
const S = {
  id: localStorage.getItem('pv_playerId') || null,
  name: localStorage.getItem('pv_name') || '',
  currentTaskId: null,
  pollTimer: null,
  ruleRecipient: null
};

const $ = id => document.getElementById(id);
const show = id => { ['v-start','v-form','v-lobby','v-game'].forEach(v => $(v).classList.add('hidden')); $(id).classList.remove('hidden'); };
$('name').value = S.name || '';

async function api(action, payload={}) {
  const res = await fetch(WEBAPP_URL, { method:'POST', headers:{'Content-Type':'text/plain'}, body: JSON.stringify({action, ...payload}) });
  const txt = await res.text(); try { return JSON.parse(txt); } catch { return {ok:false,error:'Bad JSON',raw:txt}; }
}

/* ---------- 1) Vārds ---------- */
async function onName() {
  const name = $('name').value.trim(); if (!name) { $('name').focus(); return; }
  const r = await api('upsertPlayer', { playerId:S.id, name });
  if (!r.ok) return alert(r.error||'Kļūda');
  S.id = r.player.id; S.name = r.player.name;
  localStorage.setItem('pv_playerId', S.id);
  localStorage.setItem('pv_name', S.name);
  $('f3').placeholder = `Privātais uzdevums pret ${S.name}`;
  show('v-form');
  ensureGlobalPolling();
}
$('btn-name').onclick = onName;
$('name').addEventListener('keydown', e=>{ if(e.key==='Enter') onName(); });

/* ---------- 2) Saglabā 4 laukus ---------- */
$('btn-ready').onclick = async ()=>{
  const association = $('f1').value.trim();
  const goodDeed   = $('f2').value.trim();
  const privateT   = $('f3').value.trim();
  const rule       = $('f4').value.trim();
  if (!association || !goodDeed || !privateT || !rule) return alert('Aizpildi visus 4 laukus');
  const r = await api('saveEntriesAndReady', { playerId:S.id, association, goodDeed, privateTask:privateT, rule });
  if (!r.ok) return alert(r.error||'Kļūda');
  show('v-lobby'); pollLobby();
};

/* ---------- Lobby ---------- */
$('btn-edit').onclick = ()=>{ show('v-form'); };
async function pollLobby(){
  const res = await api('getLobby');
  if (!res.ok) return setTimeout(pollLobby, 2000);
  $('lobby-info').textContent = `Dalībnieki: ${res.total} • Aizpildījuši: ${res.filled}`;
  if (res.allReady) { await api('ensureAssignments', {}); await openGame(); }
  else setTimeout(pollLobby, 1800);
}

/* ---------- Spēle ---------- */
async function openGame(){
  show('v-game');
  await refreshTasks();
  await refreshRuleRecipient();
  ensureGlobalPolling();
}
function badge(st){ return `badge ${st==='approved'?'b-approved':st==='pending'?'b-pending':st==='rejected'?'b-rejected':'b-idle'}`; }
function label(f){ return ({1:'Asociācija',2:'Labs darbs',3:'Privātais',4:'Likums'})[f]||('#'+f); }
function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' }[m])); }

async function refreshTasks(){
  let r = await api('getMyTasks', { playerId:S.id });
  if (r.ok && (!r.tasks || !r.tasks.length)) { await api('ensureAssignments', {}); r = await api('getMyTasks', { playerId:S.id }); }
  if (!r.ok) return;

  const tasks = (r.tasks||[]).sort((a,b)=>a.field-b.field);
  const box = $('tasks'); box.innerHTML='';
  tasks.forEach(t=>{
    let foot = '';
    if (t.status==='rejected' && t.decisionReady && t.rejectedCount>0) foot = `<div class="muted">Noraidīja: ${t.rejectedCount}</div>`;
    const isDim = (t.status==='approved' || t.status==='pending'); // pending arī blāvs
    const el = document.createElement('div');
    el.className='card task' + (isDim ? ' dim' : '');
    el.innerHTML = `
      <div><span class="${badge(t.status)}">${t.status}</span> <span class="muted">${label(t.field)}</span></div>
      <div class="title" style="font-size:18px">${escapeHtml(t.text)}</div>
      ${
        t.field===4
          ? `<div class="muted">❤️ ${t.likes||0}</div>`
          : (t.status==='approved'
              ? `<div class="muted">✔ Apstiprināts</div>`
              : `<div style="display:flex;justify-content:flex-end">
                   <button data-f="${t.field}" class="btn btn-primary btn-send" ${t.status==='pending'?'disabled':''}>
                     ${t.status==='pending'?'Gaida apstiprinājumu':'Sūtīt uz apstiprinājumu'}
                   </button>
                 </div>`
            )
      }
      ${foot}
    `;
    box.appendChild(el);
  });

  document.querySelectorAll('.btn-send').forEach(b=>{
    b.onclick = async ()=>{
      const f = Number(b.getAttribute('data-f'));
      b.disabled = true; b.textContent = 'Gaida apstiprinājumu';
      await api('submitAttempt', { playerId:S.id, field:f });
      await refreshTasks();
    }
  });
}

/* ---- Autora “Like” zona ---- */
async function refreshRuleRecipient(){
  const r = await api('getInboxAndAuthored', { playerId:S.id });
  if (!r.ok) return;
  const authored = (r.authored||[]).filter(x=>x.field===4);
  if (!authored.length) { $('author-like').classList.add('hidden'); S.ruleRecipient=null; return; }
  const a = authored[0];
  S.ruleRecipient = { id:a.recipientId, name:a.recipientName, likes:a.likes||0 };
  $('author-like-body').textContent = `${a.recipientName} — ❤️ ${a.likes||0}`;
  $('author-like').classList.remove('hidden');
}
$('btn-like').onclick = async ()=>{
  if (!S.ruleRecipient) return;
  const r = await api('likeRule', { playerId:S.id, toPlayerId:S.ruleRecipient.id });
  if (!r.ok) alert(r.error||'Kļūda');
  await refreshTasks(); await refreshRuleRecipient();
};

/* ---- Paziņojumu pārklājums (globāls) ---- */
function ensureGlobalPolling(){ if (S.pollTimer) return; S.pollTimer = setInterval(checkInbox, 2500); }
async function checkInbox(){
  if (!S.id) return;
  const r = await api('getInboxAndAuthored', { playerId:S.id });
  if (!r.ok) return;
  const inbox = r.inbox||[];
  if (!inbox.length) return;
  const it = inbox[0];
  S.currentTaskId = it.taskId;
  $('notif-title').textContent = 'Kāds izpildīja uzdevumu — apstiprini';
  $('notif-text').textContent = it.text;
  $('notify').classList.remove('hidden');
}
async function handleDecision(type){
  if (!S.currentTaskId) { $('notify').classList.add('hidden'); return; }
  $('btn-accept').disabled = true; $('btn-reject').disabled = true;
  await api(type, { playerId:S.id, taskId:S.currentTaskId }); // idempotenti
  $('btn-accept').disabled = false; $('btn-reject').disabled = false;
  $('notify').classList.add('hidden'); S.currentTaskId=null;
  await refreshTasks(); await refreshRuleRecipient();
}
$('btn-accept').onclick = ()=>handleDecision('approve');
$('btn-reject').onclick = ()=>handleDecision('reject');

/* ---- Boot ---- */
(async function boot(){
  if (!S.id || !S.name) { show('v-start'); return; }
  ensureGlobalPolling();
  const lobby = await api('getLobby');
  let my = await api('getMyTasks', { playerId:S.id });
  if (my.ok && (!my.tasks || !my.tasks.length) && lobby.ok && lobby.allReady) {
    await api('ensureAssignments', {}); my = await api('getMyTasks', { playerId:S.id });
  }
  if (my.ok && (my.tasks||[]).length) return openGame();
  if (lobby.ok && lobby.total>0 && lobby.filled<lobby.total) { show('v-lobby'); return pollLobby(); }
  show('v-form');
})();
</script>
</body>
</html>
