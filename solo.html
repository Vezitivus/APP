<!DOCTYPE html>
<html lang="lv">
<head>
  <meta charset="UTF-8">
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>SOLO GAMES</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; }
    body {
      margin:0; padding:16px;
      background:#000; color:#fff;
      font-family:-apple-system,BlinkMacSystemFont,"Helvetica Neue",Arial,sans-serif;
      display:flex; justify-content:center;
    }
    .container {
      width:100%; max-width:480px;
      background:#111; border-radius:12px;
      padding:24px; box-shadow:0 4px 20px rgba(0,0,0,0.5);
    }
    h1 {
      margin:0 0 24px;
      font-size:2.5rem; font-weight:bold;
      text-align:center; line-height:1.2;
    }
    .row { margin-bottom:20px; }
    select, input[type="number"], button {
      width:100%; padding:12px;
      font-size:1rem; border:none;
      border-radius:8px; background:#222;
      color:#fff; outline:none;
    }
    .players-grid {
      display:grid; grid-template-columns:1fr 1fr;
      gap:12px; margin-bottom:20px;
    }
    .player-column select { margin-bottom:8px; }
    button {
      padding:14px; font-size:1.1rem;
      background:#1a1a1a; cursor:pointer;
      transition:background-color .2s;
    }
    button:hover:not(:disabled) { background:#333; }
    button:disabled { opacity:0.6; cursor:default; }
    .hidden { display:none!important; }
  </style>
</head>
<body>
  <div class="container">
    <h1>SOLO GAMES</h1>

    <!-- 1) Spēļu izvēle -->
    <div class="row">
      <select id="gameSelect" disabled>
        <option>Ļauj ielādēt…</option>
      </select>
    </div>

    <!-- 2+3) Spēlētāji un punkti -->
    <div id="playersGrid" class="players-grid hidden">
      <div class="player-column">
        <select id="player1"><option>Spēlētājs 1</option></select>
        <input type="number" id="score1" placeholder="Punkti" min="0" disabled>
      </div>
      <div class="player-column">
        <select id="player2"><option>Spēlētājs 2</option></select>
        <input type="number" id="score2" placeholder="Punkti" min="0" disabled>
      </div>
    </div>

    <!-- 4) Nosūtīšanas poga -->
    <button id="submitBtn" class="hidden" disabled>Nosūtīt rezultātus</button>
  </div>

  <script>
    const gameSelect  = document.getElementById('gameSelect');
    const playersGrid = document.getElementById('playersGrid');
    const player1     = document.getElementById('player1');
    const player2     = document.getElementById('player2');
    const score1      = document.getElementById('score1');
    const score2      = document.getElementById('score2');
    const submitBtn   = document.getElementById('submitBtn');

    // 1) Ielādē spēļu nosaukumus no servera
    window.onload = () => {
      google.script.run
        .withSuccessHandler(headers => {
          gameSelect.innerHTML = '<option value="" disabled selected>Izvēlies spēli</option>';
          headers.forEach(name => {
            const o = document.createElement('option');
            o.value = o.textContent = name;
            gameSelect.appendChild(o);
          });
          gameSelect.disabled = false;
        })
        .getHeaders();
    };

    // 2) Kad izvēlas spēli → ielādē spēlētājus
    gameSelect.addEventListener('change', () => {
      google.script.run
        .withSuccessHandler(players => {
          [player1,player2].forEach(sel => {
            sel.innerHTML = '<option value="" disabled selected>Spēlētājs</option>';
            players.forEach(p => sel.appendChild(new Option(p,p)));
            sel.disabled = false;
          });
          score1.value = score2.value = '';
          score1.disabled = score2.disabled = true;
          submitBtn.disabled = true;
          submitBtn.classList.add('hidden');
          playersGrid.classList.remove('hidden');
        })
        .getPlayers(gameSelect.value);
    });

    // 3) Aktivizē punktu ievadi, kad abi spēlētāji atlasīti
    function checkPlayers() {
      if (player1.value && player2.value && player1.value !== player2.value) {
        score1.disabled = score2.disabled = false;
      } else {
        score1.disabled = score2.disabled = true;
        submitBtn.disabled = true;
        submitBtn.classList.add('hidden');
      }
    }
    player1.onchange = player2.onchange = checkPlayers;

    // 4) Parāda pogu, kad abi punkti ievadīti
    function checkScores() {
      if (score1.value !== '' && score2.value !== '') {
        submitBtn.disabled = false;
        submitBtn.classList.remove('hidden');
      } else {
        submitBtn.disabled = true;
        submitBtn.classList.add('hidden');
      }
    }
    score1.oninput = score2.oninput = checkScores;

    // 5) Nosūta rezultātu serverim
    submitBtn.onclick = () => {
      const s1 = +score1.value, s2 = +score2.value;
      google.script.run
        .withSuccessHandler(resp => {
          if (resp.status === 'success') {
            alert('Rezultāti saglabāti!');
            score1.value = score2.value = '';
            submitBtn.disabled = true;
            submitBtn.classList.add('hidden');
          } else {
            alert('Kļūda: ' + resp.message);
          }
        })
        .submitResult(
          gameSelect.value,
          s1 > s2 ? player1.value : player2.value,
          s1 > s2 ? player2.value : player1.value,
          Math.max(s1, s2),
          Math.min(s1, s2)
        );
    };
  </script>
</body>
</html>
