<!DOCTYPE html>
<html lang="lv">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>GameOn Tournament</title>
  <style>
    /* Mobilajam pielāgots dizains – samazināts fonts un kompaktāki izmeri */
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", Helvetica, Arial, sans-serif;
      margin: 0; padding: 0;
      background-color: #F2F2F7;
      color: #1C1C1E;
      font-size: 20px;
    }
    .container {
      width: 95%;
      max-width: 900px;
      margin: 20px auto;
      background: #FFFFFF;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      padding: 10px;
      box-sizing: border-box;
    }
    h1,h2 { font-weight: 600; color: #007AFF; margin-bottom: 8px; font-size: 24px; }
    h3 { font-weight: 600; color: #007AFF; margin: 12px 0 4px; font-size: 22px; }
    p { font-size: 20px; line-height: 1.4; }
    input, textarea {
      width: 100%; padding: 6px; font-size: 20px;
      border: 1px solid #C7C7CC; border-radius: 6px;
      margin-bottom: 8px; box-sizing: border-box;
    }
    button {
      font-size: 20px; padding: 6px 10px;
      background-color: #007AFF; color: #FFFFFF;
      border: none; border-radius: 6px;
      cursor: pointer; transition: background-color 0.2s;
      width: 100%; box-sizing: border-box; margin-bottom: 8px;
    }
    button:hover { background-color: #005BBB; }
    .tab-bar {
      position: fixed; bottom: 0; left: 0; right: 0;
      background-color: #FFFFFF; border-top: 1px solid #C7C7CC;
      display: flex; justify-content: space-around;
      padding: 6px 0; box-shadow: 0 -2px 5px rgba(0,0,0,0.1); z-index: 1000;
    }
    .tab-bar button {
      background: none; border: none; font-size: 18px; color: #007AFF;
      flex-grow: 1; text-align: center; padding: 4px 0;
    }
    .tab-bar button.active { font-weight: 600; }
    .section { display: none; }
    .section.active { display: block; }
    table { width: 100%; border-collapse: collapse; font-size: 18px; margin-bottom: 12px; }
    th, td {
      padding: 4px; border: 1px solid #C7C7CC; text-align: center; word-wrap: break-word;
    }
    th { background-color: #F2F2F7; font-weight: 600; }
  </style>
</head>
<body>
  <!-- Sākuma sadaļa -->
  <div class="container" id="startSection">
    <h1>GameOn – Turnīra Pārvaldība</h1>
    <p>Ievadi spēles nosaukumu, lai izveidotu jaunu turnīru vai pievienotos esošam.</p>
    <label for="gameNameInput">Spēles nosaukums:</label>
    <input type="text" id="gameNameInput" placeholder="piem. 'Rīga Cup 2025'">
    <button onclick="newGame()">Jauna Spēle</button>
    <button onclick="joinGame()">Pievienoties Spēlei</button>
    <div id="currentGameInfo" style="display:none; margin-top:8px;">
      <p><strong>Spēles ID:</strong> <span id="gameNameDisplay"></span></p>
      <button onclick="activateSection('inputSection')">Ievadi Komandas</button>
    </div>
  </div>
  
  <!-- Galvenais saturs -->
  <div class="container" id="mainContent" style="display:none;">
    <!-- Komandu Ievade -->
    <div class="section" id="inputSection">
      <h2>Komandu Ievade</h2>
      <p>Ievadi katru komandu jaunā rindā:</p>
      <textarea id="teamsInput" rows="6" placeholder="Team A&#10;Team B&#10;Team C"></textarea>
      <button onclick="saveTeams()">Saglabāt Komandas un Ģenerēt Turnīru</button>
    </div>
    
    <!-- Group A Section -->
    <div class="section" id="groupASection">
      <h2>Group A Schedule</h2>
      <div id="groupAContainer"></div>
    </div>
    
    <!-- Group B Section -->
    <div class="section" id="groupBSection">
      <h2>Group B Schedule</h2>
      <div id="groupBContainer"></div>
    </div>
    
    <!-- Standings Section -->
    <div class="section" id="standingsSection">
      <h2>Standings</h2>
      <h3>Group A Standings</h3>
      <div id="standingsAContainer"></div>
      <h3>Group B Standings</h3>
      <div id="standingsBContainer"></div>
    </div>
    
    <!-- Playoffs Section -->
    <div class="section" id="playoffsSection">
      <h2>Playoffs Bracket</h2>
      <div id="playoffsContainer"></div>
    </div>
  </div>
  
  <!-- Apakšējā navigācijas josla -->
  <div class="tab-bar" id="tabBar" style="display:none;">
    <button id="tabInput" onclick="activateSection('inputSection')">Ievade</button>
    <button id="tabGroupA" onclick="activateSection('groupASection')">Group A</button>
    <button id="tabGroupB" onclick="activateSection('groupBSection')">Group B</button>
    <button id="tabStandings" onclick="activateSection('standingsSection')">Standings</button>
    <button id="tabPlayoffs" onclick="activateSection('playoffsSection')">Playoffs</button>
  </div>
  
  <script>
    const scriptUrl = "https://script.google.com/macros/s/AKfycbzfBFIGVe5RhJh5Kgucv2K3ms2MIUMAd2haR6-WCqUkDEt6KJZMmootY5_R3FP9QSssZA/exec";
    let currentGameName = "";

    function newGame() {
      const name = document.getElementById("gameNameInput").value.trim();
      const params = new URLSearchParams({ action: "newGame" });
      if (name) params.append("userGameName", name);
      fetch(`${scriptUrl}?${params}`)
        .then(r => r.json())
        .then(d => {
          if (d.error) alert("Kļūda: " + d.error);
          else {
            currentGameName = d.gameName;
            document.getElementById("gameNameDisplay").innerText = d.gameName;
            document.getElementById("currentGameInfo").style.display = "block";
            document.getElementById("startSection").style.display = "none";
            document.getElementById("mainContent").style.display = "block";
            document.getElementById("tabBar").style.display = "flex";
            activateSection("inputSection");
          }
        })
        .catch(e => { console.error(e); alert("Kļūda jaunas spēles izveidē"); });
    }

    function joinGame() {
      const name = document.getElementById("gameNameInput").value.trim();
      if (!name) return alert("Lūdzu ievadi spēles nosaukumu!");
      const params = new URLSearchParams({ action: "joinGame", gameName: name });
      fetch(`${scriptUrl}?${params}`)
        .then(r => r.json())
        .then(d => {
          if (d.error) alert("Kļūda: " + d.error);
          else {
            currentGameName = d.gameName;
            document.getElementById("gameNameDisplay").innerText = d.gameName;
            document.getElementById("currentGameInfo").style.display = "block";
            document.getElementById("startSection").style.display = "none";
            document.getElementById("mainContent").style.display = "block";
            document.getElementById("tabBar").style.display = "flex";
            activateSection("inputSection");
          }
        })
        .catch(e => { console.error(e); alert("Kļūda pievienoties spēlei"); });
    }

    function activateSection(id) {
      document.querySelectorAll(".section").forEach(s => s.classList.remove("active"));
      document.getElementById(id).classList.add("active");
      document.querySelectorAll(".tab-bar button").forEach(b => b.classList.remove("active"));
      if (id === "inputSection")   document.getElementById("tabInput").classList.add("active");
      if (id === "groupASection")  document.getElementById("tabGroupA").classList.add("active");
      if (id === "groupBSection")  document.getElementById("tabGroupB").classList.add("active");
      if (id === "standingsSection") document.getElementById("tabStandings").classList.add("active");
      if (id === "playoffsSection")  document.getElementById("tabPlayoffs").classList.add("active");
      if (id === "groupASection")      loadGroupSchedule("A");
      if (id === "groupBSection")      loadGroupSchedule("B");
      if (id === "standingsSection")   loadStandings();
      if (id === "playoffsSection")    loadPlayoffs();
    }

    function saveTeams() {
      const teams = document.getElementById("teamsInput").value
        .split("\n").map(l => l.trim()).filter(l => l);
      if (!teams.length) return alert("Lūdzu ievadi vismaz vienu komandu!");
      if (!currentGameName) return alert("Nav izvēlēta spēle!");
      const params = new URLSearchParams({
        action: "saveTeams",
        gameName: currentGameName,
        teams: JSON.stringify(teams)
      });
      fetch(`${scriptUrl}?${params}`)
        .then(r => r.json())
        .then(d => {
          if (d.error) alert("Kļūda: " + d.error);
          else { alert("Turnīrs izveidots!"); activateSection("standingsSection"); }
        })
        .catch(e => { console.error(e); alert("Kļūda saglabājot komandas"); });
    }

    function loadGroupSchedule(group) {
      if (!currentGameName) return;
      const action = group === "A" ? "getGroupASchedule" : "getGroupBSchedule";
      const params = new URLSearchParams({ action, gameName: currentGameName });
      fetch(`${scriptUrl}?${params}`)
        .then(r => r.json())
        .then(data => displayGroupSchedule(group, data))
        .catch(e => { console.error(e); alert("Kļūda ielādējot datus"); });
    }

    function displayGroupSchedule(group, data) {
      let html = `<table>
        <tr><th>Match #</th><th>Team A</th><th>Team B</th>
            <th>Score A</th><th>Score B</th><th>Action</th></tr>`;
      data.rows.forEach(r => {
        const [m, tA, tB, sA, sB] = r;
        const dis = (sA !== "" && sB !== "") ? "disabled" : "";
        html += `<tr>
          <td>${m}</td><td>${tA}</td><td>${tB}</td>
          <td><input type="number" id="scoreA_${group}_${m}" value="${sA}" ${dis}></td>
          <td><input type="number" id="scoreB_${group}_${m}" value="${sB}" ${dis}></td>
          <td>${dis
            ? "ok"
            : `<button onclick="saveGroupScore('${group}',${m})">ok</button>`}
          </td>
        </tr>`;
      });
      html += `</table>`;
      document.getElementById(group === "A" ? "groupAContainer" : "groupBContainer").innerHTML = html;
    }

    function saveGroupScore(group, matchNumber) {
      const sA = document.getElementById(`scoreA_${group}_${matchNumber}`).value;
      const sB = document.getElementById(`scoreB_${group}_${matchNumber}`).value;
      if (!sA || !sB) return alert("Lūdzu aizpildi abas punktu vērtības!");
      const params = new URLSearchParams({
        action: "saveGroupScore",
        gameName: currentGameName,
        group, matchNumber, scoreA: sA, scoreB: sB
      });
      fetch(`${scriptUrl}?${params}`)
        .then(r => r.json())
        .then(d => {
          if (d.error) alert("Kļūda: " + d.error);
          else {
            alert("Punkti saglabāti!");
            loadGroupSchedule(group);
            loadStandings();
            loadPlayoffs();
          }
        })
        .catch(e => { console.error(e); alert("Kļūda saglabājot punktus"); });
    }

    function loadStandings() {
      if (!currentGameName) return Promise.resolve();
      const params = new URLSearchParams({ action: "standings", gameName: currentGameName });
      return fetch(`${scriptUrl}?${params}`)
        .then(r => r.json())
        .then(data => {
          // A
          let htmlA = `<table>
            <tr><th>Team</th><th>Games</th><th>Wins</th>
                <th>Losses</th><th>PF</th><th>PA</th></tr>`;
          data.standingsA.forEach(r => {
            htmlA += `<tr>
              <td>${r.Team}</td><td>${r.Games}</td><td>${r.Wins}</td>
              <td>${r.Losses}</td><td>${r["Points For"]}</td><td>${r["Points Against"]}</td>
            </tr>`;
          });
          htmlA += `</table>`;
          document.getElementById("standingsAContainer").innerHTML = htmlA;
          // B
          let htmlB = `<table>
            <tr><th>Team</th><th>Games</th><th>Wins</th>
                <th>Losses</th><th>PF</th><th>PA</th></tr>`;
          data.standingsB.forEach(r => {
            htmlB += `<tr>
              <td>${r.Team}</td><td>${r.Games}</td><td>${r.Wins}</td>
              <td>${r.Losses}</td><td>${r["Points For"]}</td><td>${r["Points Against"]}</td>
            </tr>`;
          });
          htmlB += `</table>`;
          document.getElementById("standingsBContainer").innerHTML = htmlB;
          return data.combinedStandings.map(r => r.Team);
        })
        .catch(e => { console.error(e); alert("Kļūda ielādējot standings"); });
    }

    function loadPlayoffs() {
      if (!currentGameName) return;
      // salīdzinām standings, pēc tam ģenerējam QF→SF→Final
      loadStandings().then(teams => {
        if (!teams || teams.length < 2) {
          document.getElementById("playoffsContainer").innerHTML = "<p>Nav pietiekami daudz komandu playoff</p>";
          return;
        }
        displayDynamicBracket(teams);
      });
    }

    function displayDynamicBracket(teams) {
      // izvēlam top N, N=2^k
      let n = 1;
      while (n * 2 <= teams.length) n *= 2;
      const bracket = teams.slice(0, n);
      // QF
      const qf = [];
      for (let i = 0; i < n/2; i++) {
        qf.push({
          match: `QF${i+1}`,
          team1: bracket[i],
          team2: bracket[n-1-i],
          score1: "", score2: "", winner: "", loser: ""
        });
      }
      // SF placeholders
      const sf = [
        { match:"SF1", team1:"", team2:"", score1:"", score2:"", winner:"", loser:"" },
        { match:"SF2", team1:"", team2:"", score1:"", score2:"", winner:"", loser:"" }
      ];
      // Final / 3rd
      const fin1 = [{ match:"Final1", team1:"", team2:"", score1:"", score2:"", winner:"", loser:"" }];
      const fin3 = [{ match:"Final2", team1:"", team2:"", score1:"", score2:"", winner:"", loser:"" }];

      let html = "";
      html += `<h3>Quarterfinals</h3>` + makeTable(qf);
      html += `<h3>Semifinals</h3>` + makeTable(sf);
      html += `<h3>Final (1st place)</h3>` + makeTable(fin1);
      html += `<h3>3rd Place Final</h3>` + makeTable(fin3);
      document.getElementById("playoffsContainer").innerHTML = html;
    }

    function makeTable(rows) {
      let html = `<table>
        <tr><th>Match</th><th>Team 1</th><th>Team 2</th>
            <th>Score 1</th><th>Score 2</th><th>Winner</th><th>Loser</th><th>Action</th></tr>`;
      rows.forEach(r => {
        const dis = (r.score1 !== "" && r.score2 !== "") ? "disabled" : "";
        html += `<tr>
          <td>${r.match}</td>
          <td><input id="t1_${r.match}" value="${r.team1}" style="width:100%;font-size:10px;"></td>
          <td><input id="t2_${r.match}" value="${r.team2}" style="width:100%;font-size:10px;"></td>
          <td><input type="number" id="s1_${r.match}" value="${r.score1}" ${dis} style="width:50px;"></td>
          <td><input type="number" id="s2_${r.match}" value="${r.score2}" ${dis} style="width:50px;"></td>
          <td>${r.winner}</td>
          <td>${r.loser}</td>
          <td>${dis
            ? "ok"
            : `<button onclick="savePlayoffScore('${r.match}')">ok</button>`}
          </td>
        </tr>`;
      });
      html += `</table>`;
      return html;
    }

    function savePlayoffScore(matchId) {
      const score1 = document.getElementById(`s1_${matchId}`).value;
      const score2 = document.getElementById(`s2_${matchId}`).value;
      const team1  = document.getElementById(`t1_${matchId}`).value;
      const team2  = document.getElementById(`t2_${matchId}`).value;
      if (score1 === "" || score2 === "") return alert("Lūdzu ievadi abas punktu vērtības!");
      const params = new URLSearchParams({
        action: "savePlayoffScore",
        gameName: currentGameName,
        matchId,
        team1, team2,
        score1, score2
      });
      fetch(`${scriptUrl}?${params}`)
        .then(r => r.json())
        .then(d => {
          if (d.error) alert("Kļūda: " + d.error);
          else {
            alert("Punkti saglabāti!");
            loadPlayoffs();
          }
        })
        .catch(e => { console.error(e); alert("Kļūda saglabājot playoff punktus"); });
    }

    window.onload = () => { activateSection("inputSection"); };
  </script>
</body>
</html>
