<!doctype html>
<html lang="lv">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>TurnÄ«ru AplikÄcija â€” Pro Liquid UI</title>
<meta name="color-scheme" content="light dark" />
<style>
  :root{
    --bg:#0b0f14; --text:#e6e9ef; --muted:#9aa4b2;
    --card:rgba(18,24,38,.55); --border:rgba(255,255,255,.08); --ring:#6f7dd62b;
    --accent:#7c5cff; --accent2:#45a2ff; --gold:#f4c542; --ok:#19c37d; --bad:#ff5c7a;
    --radius:16px; --shadow:0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.05);
    --font:ui-sans-serif,-apple-system,"SF Pro Text","Inter","Segoe UI",Roboto,Arial; --space:clamp(10px,2vw,18px);
    --std-w-num: clamp(30px, 7vw, 56px);
  }
  @media (prefers-color-scheme:light){
    :root{ --bg:#f7f8fc; --text:#0f172a; --muted:#4b5568; --card:rgba(255,255,255,.82); --border:rgba(15,23,42,.10);
           --ring:#7c8dd41c; --shadow:0 12px 30px rgba(18,20,40,.08), inset 0 1px 0 rgba(255,255,255,.55)}
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;color:var(--text);font-family:var(--font);background:var(--bg);
    background:
      radial-gradient(1200px 800px at 120% -10%, color-mix(in oklab, var(--accent) 30%, transparent), transparent 60%),
      radial-gradient(900px 600px at -30% 20%, color-mix(in oklab, var(--accent2) 28%, transparent), transparent 60%),
      radial-gradient(600px 500px at 80% 110%, color-mix(in oklab, #19c37d 26%, transparent), transparent 60%);
  }

  header{
    position:sticky;top:0;z-index:20;backdrop-filter:saturate(140%) blur(12px);
    background:linear-gradient(180deg, rgba(0,0,0,.0), rgba(0,0,0,.05)), var(--card);
    border-bottom:1px solid var(--border);
  }
  .bar{max-width:1200px;margin:0 auto;padding:12px clamp(14px,3vw,24px);display:flex;gap:12px;align-items:center;justify-content:space-between}
  .brand{display:flex;gap:12px;align-items:center;font-weight:900;letter-spacing:.2px}
  .dot{width:14px;height:14px;border-radius:50%;
       background:radial-gradient(12px 12px at 20% 20%, #fff8, #0000), linear-gradient(135deg,var(--accent),var(--accent2))}
  .wrap{max-width:1200px;margin:clamp(10px,2vw,20px) auto clamp(60px,7vw,96px); padding:0 clamp(14px,3vw,24px);display:grid;gap:var(--space)}

  /* non-intrusive notice (no alerts) */
  .notice{max-width:1200px;margin:0 auto 10px;padding:0 clamp(14px,3vw,24px)}
  .notice > div{
    display:flex;align-items:center;justify-content:space-between;gap:12px;
    padding:10px 12px;border-radius:14px;border:1px solid var(--border);
    background:color-mix(in oklab, var(--card) 92%, rgba(0,0,0,.18));
    box-shadow:0 20px 60px rgba(0,0,0,.25)
  }
  .notice button{border:1px solid var(--border);background:transparent;color:var(--text);border-radius:999px;padding:6px 10px;cursor:pointer}

  .panel{
    background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);
    padding:clamp(12px,2.6vw,20px); transition:transform .12s ease, box-shadow .25s ease;
  }
  h2{margin:0 0 8px;font-size:clamp(18px,2.6vw,22px)}
  h3{margin:0 0 8px;font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.12em}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .muted{color:var(--muted);font-size:13px}
  .tnum{font-variant-numeric:tabular-nums}

  input,textarea,select{
    width:100%;background:rgba(255,255,255,.02);color:var(--text);
    border:1px solid var(--border);border-radius:12px;padding:12px 12px;
    transition:border .2s ease, box-shadow .2s ease, transform .08s ease;
    -webkit-tap-highlight-color: transparent;
  }
  input:focus,textarea:focus,select:focus{outline:none;border-color:color-mix(in oklab, var(--accent) 45%, var(--border));box-shadow:0 0 0 6px var(--ring)}

  .btn{
    appearance:none;border:1px solid var(--border);
    background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(0,0,0,.08));
    color:var(--text);border-radius:999px;padding:11px 16px;cursor:pointer;
    -webkit-tap-highlight-color:transparent; touch-action:manipulation; user-select:none; -webkit-user-select:none;
  }
  .btn--accent{border:none;background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff}
  .btn--gold{border:none;background:linear-gradient(135deg,var(--gold),#ffd569);color:#1a1a1a}
  .btn:active{transform:translateY(1px)}

  /* ===== TEAM LIST (setup) ===== */
  .teams-box{display:grid;gap:10px}
  .teams-list{display:grid;gap:8px}
  .team-row{
    display:flex;align-items:center;justify-content:space-between;gap:10px;
    padding:10px 12px;border-radius:14px;border:1px solid var(--border);
    background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(0,0,0,.10));
  }
  .team-left{display:flex;align-items:center;gap:10px;min-width:0}
  .team-name{font-weight:900;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  .team-actions{display:flex;gap:8px;flex:0 0 auto}
  .icon-btn{
    border:1px solid var(--border);background:rgba(255,255,255,.02);color:var(--text);
    border-radius:999px;padding:8px 10px;cursor:pointer
  }
  .icon-btn[disabled]{opacity:.45;cursor:not-allowed}

  /* ===== Avatars ===== */
  .avatar{
    width:30px;height:30px;border-radius:10px;overflow:hidden;flex:0 0 auto;
    border:1px solid rgba(255,255,255,.10);
    background:radial-gradient(14px 14px at 30% 30%, rgba(255,255,255,.30), transparent 55%),
               linear-gradient(135deg, rgba(124,92,255,.95), rgba(69,162,255,.85));
    display:grid;place-items:center;font-weight:1000;color:#fff;font-size:12px;letter-spacing:.06em;
    box-shadow:0 10px 26px rgba(0,0,0,.25);
  }
  .avatar img{width:100%;height:100%;object-fit:cover;display:block}
  .avatar.alt{
    background:radial-gradient(14px 14px at 30% 30%, rgba(255,255,255,.30), transparent 55%),
               linear-gradient(135deg, rgba(99,102,241,.95), rgba(168,85,247,.80));
  }

  /* ===== GROUPS â€” PROFESSIONAL (less frames, smaller fonts) ===== */
  .group-grid{display:grid;gap:var(--space);grid-template-columns:repeat(auto-fit,minmax(360px,1fr))}
  .group-head{
    display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;margin-bottom:10px;
  }
  .g-left{display:flex;align-items:center;gap:10px;min-width:0}
  .gid{
    width:34px;height:34px;border-radius:12px;display:grid;place-items:center;
    font-weight:1000;color:#fff;flex:0 0 auto;
    background:radial-gradient(14px 14px at 25% 25%, rgba(255,255,255,.35), transparent 55%),
               linear-gradient(135deg,var(--accent),var(--accent2));
    box-shadow:0 14px 30px rgba(0,0,0,.25);
  }
  .g-title{font-weight:1000;font-size:18px;letter-spacing:.2px;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  .g-sub{font-size:12px;color:var(--muted)}
  .matches{display:grid;gap:10px}

  .match-row{
    border:1px solid var(--border);
    border-radius:18px;
    padding:10px 12px;
    background:
      radial-gradient(220px 120px at 18% 40%, rgba(255,255,255,.05), transparent 60%),
      linear-gradient(180deg, rgba(255,255,255,.02), rgba(0,0,0,.14));
    box-shadow:0 16px 50px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.04);
    cursor:pointer;
    -webkit-tap-highlight-color:transparent;
    touch-action:manipulation;
    transition:transform .12s ease, border-color .2s ease;
  }
  .match-row:hover{transform:translateY(-1px);border-color:color-mix(in oklab, var(--accent) 18%, var(--border))}
  .match-row:active{transform:translateY(1px)}
  .match-row.disabled{opacity:.45;cursor:default}
  .mr{
    display:grid;
    grid-template-columns:44px 1fr 132px 1fr;
    gap:12px;
    align-items:center;
  }
  .mr-r{
    text-align:center;
    font-weight:1000;
    color:color-mix(in oklab, var(--text) 85%, var(--muted));
    font-size:13px;
    letter-spacing:.06em;
  }
  .mr-team{display:flex;align-items:center;gap:10px;min-width:0}
  .mr-team.away{justify-content:flex-end}
  .mr-name{
    min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
    font-weight:1000;
    font-size:clamp(14px, 2.0vw, 17px);
    letter-spacing:.01em;
  }
  .mr-score{
    height:38px;
    border-radius:999px;
    display:flex;
    align-items:center;
    justify-content:center;
    gap:10px;
    font-weight:1000;
    letter-spacing:.04em;
    border:1px solid color-mix(in oklab, var(--ok) 35%, rgba(255,255,255,.06));
    background:
      radial-gradient(140px 80px at 25% 25%, rgba(255,255,255,.12), transparent 60%),
      linear-gradient(135deg, color-mix(in oklab, var(--ok) 28%, rgba(0,0,0,.20)), rgba(0,0,0,.26));
    box-shadow:0 14px 40px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.08);
    font-size:18px;
  }
  .mr-ot{
    font-size:12px;
    font-weight:1000;
    padding:5px 9px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.10);
    color:color-mix(in oklab, var(--gold) 90%, #fff);
    background:rgba(0,0,0,.18);
    display:none;
  }
  .mr-ot.on{display:inline-flex}

  @media (max-width:520px){
    .mr{grid-template-columns:40px 1fr 118px 1fr;gap:10px}
    .mr-score{font-size:16px}
    .avatar{width:28px;height:28px}
  }

  /* ===== STANDINGS ===== */
  #standingsHost{display:grid;grid-template-columns:1fr;gap:var(--space);align-items:start}
  #standingsHost > .panel{min-width:0}
  .standings-table{table-layout:fixed;width:100%;border-collapse:separate;border-spacing:0 8px}
  .standings-table th,.standings-table td{padding:8px 10px;overflow:hidden}
  .standings-table thead th{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.12em}
  .standings-table tbody tr{background:linear-gradient(180deg,transparent, color-mix(in oklab, var(--card) 88%, transparent))}
  .name-nowrap{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;display:block}

  /* ===== Bracket ===== */
  .bracket{display:grid;gap:var(--space);grid-template-columns:repeat(3, minmax(260px,1fr))}
  .round{display:grid;gap:var(--space)}
  .match{border:1px solid var(--border);border-radius:14px;padding:12px;background:color-mix(in oklab, var(--card) 94%, transparent)}
  .team{display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:center;padding:8px;border-radius:10px}
  .team.win{outline:2px solid color-mix(in oklab, var(--ok) 45%, transparent);outline-offset:-2px}
  .status{font-size:12px;color:var(--muted);margin-bottom:6px}
  .score-in{width:clamp(44px, 11vw, 62px);text-align:center;padding:8px 6px;border-radius:10px;border:1px solid var(--border);background:rgba(255,255,255,.03);color:var(--text)}

  /* compact checkbox */
  .chk{appearance:none;width:16px;height:16px;border:1px solid var(--border);border-radius:4px;background:rgba(255,255,255,.02);display:inline-block;position:relative;vertical-align:middle}
  .chk:checked{background:linear-gradient(135deg,var(--accent),var(--accent2));border-color:transparent}
  .chk:checked::after{content:'âœ“';position:absolute;inset:0;font-size:12px;color:#fff;display:flex;align-items:center;justify-content:center}

  /* ===== Generic modal (team + match) ===== */
  .backdrop{
    position:fixed; inset:0;
    background:rgba(0,0,0,.62);
    backdrop-filter: blur(10px);
    opacity:0; visibility:hidden; pointer-events:none;
    transition:opacity .22s cubic-bezier(.2,.8,.2,1);
    z-index:90;
  }
  .backdrop.open{opacity:1;visibility:visible;pointer-events:auto}

  .modal{
    position:fixed; left:50%; top:50%;
    transform:translate(-50%,-50%) scale(.985);
    width:min(560px, calc(100% - 24px));
    border-radius:22px;
    background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(0,0,0,.18)), var(--card);
    border:1px solid var(--border);
    box-shadow:0 40px 120px rgba(0,0,0,.55), inset 0 1px 0 rgba(255,255,255,.06);
    backdrop-filter: blur(14px) saturate(150%);
    opacity:0; visibility:hidden; pointer-events:none;
    transition: transform .24s cubic-bezier(.2,.8,.2,1), opacity .24s cubic-bezier(.2,.8,.2,1);
    z-index:100;
    overflow:hidden;
  }
  .modal.open{opacity:1;visibility:visible;pointer-events:auto;transform:translate(-50%,-50%) scale(1)}

  .m-head{
    display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
    padding:14px 16px; border-bottom:1px solid var(--border);
    background:color-mix(in oklab, var(--card) 96%, transparent)
  }
  .m-title{font-weight:1000;letter-spacing:.02em;font-size:16px}
  .m-sub{margin-top:6px;font-size:12px;color:var(--muted);line-height:1.25}
  .m-body{padding:14px 16px 16px;display:grid;gap:12px}
  .m-actions{display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap}
  .m-actions .btn{min-width:140px}

  /* TEAM modal specifics */
  .team-form{display:grid;gap:12px}
  .photo-row{display:flex;gap:12px;align-items:center}
  .photo-lg{
    width:58px;height:58px;border-radius:18px;overflow:hidden;flex:0 0 auto;
    border:1px solid rgba(255,255,255,.12);
    background:radial-gradient(18px 18px at 30% 30%, rgba(255,255,255,.28), transparent 55%),
               linear-gradient(135deg, rgba(124,92,255,.95), rgba(69,162,255,.85));
    display:grid;place-items:center;color:#fff;font-weight:1000;
    box-shadow:0 18px 44px rgba(0,0,0,.28);
  }
  .photo-lg img{width:100%;height:100%;object-fit:cover;display:block}
  .file-hide{display:none}

  /* MATCH modal keypad */
  .mm-err{
    width:100%;padding:10px 12px;border-radius:14px;
    border:1px solid color-mix(in oklab, var(--bad) 30%, var(--border));
    background:color-mix(in oklab, var(--bad) 12%, rgba(0,0,0,.10));
    color:color-mix(in oklab, var(--text) 92%, var(--bad));
    font-weight:900;display:none;
  }
  .mm-err.show{display:block}

  .mm-scorebox{
    border:1px solid var(--border);
    border-radius:18px;
    background:rgba(255,255,255,.03);
    padding:12px;
    display:grid; gap:10px;
  }
  .mm-row{
    display:grid; grid-template-columns:1fr min-content 1fr;
    gap:10px; align-items:stretch;
  }
  .mm-side{
    border:1px solid var(--border);
    background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(0,0,0,.10));
    border-radius:16px;
    padding:12px;
    cursor:pointer;
    user-select:none; -webkit-user-select:none;
    display:grid; gap:8px;
    box-shadow:0 10px 24px rgba(0,0,0,.22), inset 0 1px 0 rgba(255,255,255,.04);
  }
  .mm-side.active{
    border-color:color-mix(in oklab, var(--accent) 45%, var(--border));
    box-shadow:0 0 0 6px var(--ring), 0 12px 30px rgba(0,0,0,.28), inset 0 1px 0 rgba(255,255,255,.04);
  }
  .mm-team{font-weight:900;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  .mm-val{
    text-align:center;
    font-size:clamp(44px, 10vw, 62px);
    font-weight:1000;
    letter-spacing:.02em;
    line-height:1;
    background:linear-gradient(135deg, var(--accent), var(--accent2));
    -webkit-background-clip:text; background-clip:text;
    color:transparent;
    text-shadow:0 18px 44px rgba(0,0,0,.30);
  }
  .mm-mid{display:grid;place-items:center;font-weight:1000;opacity:.6;font-size:22px}
  .mm-meta{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
  .mm-toggle{
    display:inline-flex;align-items:center;gap:10px;
    padding:10px 12px;border:1px solid var(--border);border-radius:999px;
    background:rgba(255,255,255,.02);
    user-select:none; -webkit-user-select:none;
  }
  .switch{position:relative;width:44px;height:26px;border-radius:999px;border:1px solid var(--border);background:rgba(255,255,255,.04)}
  .switch::after{
    content:"";position:absolute;top:3px;left:3px;width:20px;height:20px;border-radius:50%;
    background:rgba(255,255,255,.85);transition:transform .18s cubic-bezier(.2,.8,.2,1);box-shadow:0 10px 18px rgba(0,0,0,.25)
  }
  .mm-toggle input{display:none}
  .mm-toggle input:checked + .switch{border-color:transparent;background:linear-gradient(135deg, var(--accent), var(--accent2))}
  .mm-toggle input:checked + .switch::after{transform:translateX(18px)}
  .mm-toggle b{font-weight:1000}

  .mm-pad{display:grid;grid-template-columns:repeat(3, 1fr);gap:10px}
  .pad-btn{
    appearance:none;border:1px solid var(--border);
    background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.12));
    color:var(--text);border-radius:16px;
    padding:14px 12px;font-size:18px;font-weight:1000;cursor:pointer;
    touch-action:manipulation;-webkit-tap-highlight-color:transparent;user-select:none;
    box-shadow:0 12px 28px rgba(0,0,0,.28), inset 0 1px 0 rgba(255,255,255,.06);
  }
  .pad-btn:active{transform:translateY(1px)}
  .pad-btn--sub{font-size:14px;font-weight:900;color:color-mix(in oklab, var(--text) 80%, var(--muted))}
</style>
</head>
<body>
<header>
  <div class="bar">
    <div class="brand">
      <span class="dot"></span>
      <span id="brandTitle">TurnÄ«ru AplikÄcija</span>
    </div>
    <div class="row">
      <button type="button" class="btn" id="exportBtn">EksportÄ“t</button>
      <button type="button" class="btn" id="importBtn">ImportÄ“t</button>
      <button type="button" class="btn" id="resetBtn">NotÄ«rÄ«t</button>
      <button type="button" class="btn" id="soundBtn"><span id="soundIcon">ğŸ”Š</span></button>
    </div>
  </div>
  <div class="notice" id="notice" hidden>
    <div>
      <span id="noticeText"></span>
      <button type="button" id="noticeClose">OK</button>
    </div>
  </div>
</header>

<main class="wrap">
  <!-- SETUP -->
  <section class="panel" id="setupPanel">
    <div class="row" style="justify-content:space-between">
      <h2>1) Komandas</h2>
    </div>

    <div class="row" style="gap:var(--space); align-items:flex-start">
      <div style="flex:2; min-width:280px">
        <input id="tName" placeholder="TurnÄ«ra nosaukums (neobligÄts)"/>
        <div style="height:10px"></div>

        <div class="teams-box">
          <div class="row" style="justify-content:space-between">
            <div class="muted"><span class="tnum" id="teamsCount">0</span> komandas</div>
            <button type="button" class="btn btn--accent" id="addTeamBtn">Pievienot komandu</button>
          </div>
          <div id="teamsList" class="teams-list"></div>
        </div>
      </div>

      <div style="flex:1; min-width:240px">
        <label class="muted" for="groupStrategy">Grupu skaits</label>
        <select id="groupStrategy">
          <option value="auto" selected>AutomÄtiski (2/4/6; â‰¤6 â†’ 1 grupa)</option>
          <option value="n1">1 grupa (tikai ja â‰¤6 kom.)</option>
          <option value="n2">2 grupas</option>
          <option value="n4">4 grupas</option>
          <option value="n6">6 grupas</option>
        </select>
        <div style="height:10px"></div>
        <button type="button" class="btn btn--accent" id="genGroups" style="width:100%">Ä¢enerÄ“t grupas</button>
      </div>
    </div>
  </section>

  <!-- GROUPS -->
  <section class="panel" id="groupsPanel" hidden>
    <div class="row" style="justify-content:space-between; align-items:baseline">
      <h2>2) Grupas</h2>
    </div>
    <div id="groupsHost" class="group-grid"></div>
  </section>

  <!-- STANDINGS -->
  <section class="panel" id="standingsPanel" hidden>
    <h2>3) StÄvÄ“jums</h2>
    <div id="standingsHost" class="grid"></div>
  </section>

  <!-- PLAYOFF -->
  <section class="panel" id="playoffPanel" hidden>
    <div class="row" style="justify-content:space-between;align-items:center">
      <h2>4) Playoff</h2>
      <button type="button" class="btn" id="buildBracket">Ä¢enerÄ“t Bracket</button>
    </div>

    <div class="bracket" style="margin-top:var(--space)">
      <div class="round" id="qfCol"><h3>CeturtdaÄ¼finÄli</h3></div>
      <div class="round" id="sfCol"><h3>PusfinÄli</h3></div>
      <div class="round" id="finCol"><h3>FinÄls & 3. vieta</h3></div>
    </div>

    <div class="row" style="margin-top:12px">
      <button type="button" class="btn btn--gold" id="overallBtn" disabled>Kopsavilkums</button>
      <button type="button" class="btn" id="downloadPdfBtn" disabled>LejupielÄdÄ“t PDF</button>
    </div>

    <div id="statsPanel" class="grid" hidden style="margin-top:var(--space)">
      <h2>5) Kopsavilkums</h2>
      <div id="awards" class="awards"></div>
      <div class="panel" id="teamStatsPanel">
        <h3>Komandu kopstatistika</h3>
        <div id="teamStatsHost"></div>
      </div>
    </div>
  </section>
</main>

<!-- TEAM MODAL -->
<div id="teamBackdrop" class="backdrop"></div>
<div id="teamModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="teamTitle" aria-hidden="true">
  <div class="m-head">
    <div>
      <div class="m-title" id="teamTitle">Komanda</div>
      <div class="m-sub" id="teamSub">Ievadi nosaukumu un (ja gribi) pievieno attÄ“lu.</div>
    </div>
    <button type="button" class="btn" id="teamCloseBtn" aria-label="AizvÄ“rt">âœ•</button>
  </div>
  <div class="m-body">
    <div class="team-form">
      <div class="photo-row">
        <div class="photo-lg" id="teamPhotoPreview">?</div>
        <div style="flex:1;min-width:0">
          <input id="teamNameInput" placeholder="Komandas nosaukums" />
          <div class="row" style="margin-top:10px;justify-content:flex-start">
            <input type="file" id="teamFile" class="file-hide" accept="image/*" />
            <button type="button" class="btn" id="teamPickPhotoBtn">IzvÄ“lÄ“ties attÄ“lu</button>
            <button type="button" class="btn" id="teamRemovePhotoBtn">NoÅ†emt attÄ“lu</button>
          </div>
        </div>
      </div>
    </div>

    <div class="m-actions">
      <button type="button" class="btn" id="teamDeleteBtn">DzÄ“st</button>
      <button type="button" class="btn" id="teamSaveNextBtn">SaglabÄt & nÄkamÄ</button>
      <button type="button" class="btn btn--accent" id="teamSaveDoneBtn">SaglabÄt</button>
    </div>
  </div>
</div>

<!-- MATCH MODAL -->
<div id="mmBackdrop" class="backdrop"></div>
<div id="mm" class="modal" role="dialog" aria-modal="true" aria-labelledby="mmTitle" aria-hidden="true">
  <div class="m-head">
    <div>
      <div class="m-title" id="mmTitle">Ievadi rezultÄtu</div>
      <div class="m-sub" id="mmSub">â€”</div>
    </div>
    <button type="button" class="btn" id="mmCloseBtn" aria-label="AizvÄ“rt">âœ•</button>
  </div>

  <div class="m-body">
    <div class="mm-scorebox">
      <div class="mm-row">
        <div class="mm-side active" id="mmHomeBtn" role="button" tabindex="0">
          <div class="mm-team" id="mmHomeName">â€”</div>
          <div class="mm-val tnum" id="mmHomeVal">â€”</div>
        </div>
        <div class="mm-mid">:</div>
        <div class="mm-side" id="mmAwayBtn" role="button" tabindex="0">
          <div class="mm-team" id="mmAwayName">â€”</div>
          <div class="mm-val tnum" id="mmAwayVal">â€”</div>
        </div>
      </div>

      <div class="mm-meta">
        <label class="mm-toggle">
          <input type="checkbox" id="mmOt" />
          <span class="switch" aria-hidden="true"></span>
          <span>OT</span>
          <b class="tnum" id="mmOtHint"></b>
        </label>
      </div>

      <div class="mm-err" id="mmErr"></div>
    </div>

    <div class="mm-pad" id="mmPad">
      <button type="button" class="pad-btn" data-k="1">1</button>
      <button type="button" class="pad-btn" data-k="2">2</button>
      <button type="button" class="pad-btn" data-k="3">3</button>
      <button type="button" class="pad-btn" data-k="4">4</button>
      <button type="button" class="pad-btn" data-k="5">5</button>
      <button type="button" class="pad-btn" data-k="6">6</button>
      <button type="button" class="pad-btn" data-k="7">7</button>
      <button type="button" class="pad-btn" data-k="8">8</button>
      <button type="button" class="pad-btn" data-k="9">9</button>
      <button type="button" class="pad-btn pad-btn--sub" data-k="clr">Clear</button>
      <button type="button" class="pad-btn" data-k="0">0</button>
      <button type="button" class="pad-btn pad-btn--sub" data-k="bs">âŒ«</button>
    </div>

    <div class="m-actions">
      <button type="button" class="btn" id="mmResetMatchBtn">NotÄ«rÄ«t spÄ“li</button>
      <button type="button" class="btn btn--accent" id="mmSaveBtn">SaglabÄt</button>
    </div>
  </div>
</div>

<!-- PDF libs -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js" crossorigin="anonymous"></script>

<script>
/* ===== Util ===== */
const $=(s,r=document)=>r.querySelector(s), $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
const uid=()=>Math.random().toString(36).slice(2,9);
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a}
const todayStamp = ()=> new Date().toISOString().slice(0,10);
const slugify = s => (s||'').toLowerCase().normalize('NFKD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'').slice(0,80)||'tournament';

/* ===== Notice (no alerts) ===== */
function notice(msg){
  const wrap=$('#notice'); const txt=$('#noticeText');
  txt.textContent = msg;
  wrap.hidden=false;
  clearTimeout(notice._t);
  notice._t=setTimeout(()=>{wrap.hidden=true}, 2600);
}
$('#noticeClose').addEventListener('click', ()=>$('#notice').hidden=true);

/* ===== Storage ===== */
const STORAGE_KEY='tournament_state_pro_v12';
function saveState(s){ localStorage.setItem(STORAGE_KEY, JSON.stringify(s)); }
function loadState(){ try{return JSON.parse(localStorage.getItem(STORAGE_KEY)||'null')}catch{return null} }
function clearState(){ localStorage.removeItem(STORAGE_KEY); }
const SOUND_PREF_KEY='tournament_sound_on';

/* ===== Sounds ===== */
let audioCtx=null; let soundOn=(localStorage.getItem(SOUND_PREF_KEY)!=='0');
const ensureCtx=()=>{ if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)() };
function beep({freq=440,type='sine',dur=0.08,gain=0.05,a=0.005,r=0.06}={}){ if(!soundOn) return; ensureCtx();
  const now=audioCtx.currentTime, o=audioCtx.createOscillator(), g=audioCtx.createGain();
  o.type=type; o.frequency.setValueAtTime(freq,now); g.gain.setValueAtTime(0,now);
  g.gain.linearRampToValueAtTime(gain,now+a); g.gain.exponentialRampToValueAtTime(0.0001,now+a+dur+r);
  o.connect(g); g.connect(audioCtx.destination); o.start(now); o.stop(now+a+dur+r+0.02);
}
const sfx={ click:()=>beep({freq:280,type:'triangle',dur:0.05,gain:0.06}),
            score:()=>{beep({freq:420,type:'square',dur:0.06,gain:0.06}); setTimeout(()=>beep({freq:590,type:'square',dur:0.06,gain:0.05}),70)},
            success:()=>{beep({freq:450,type:'sine',dur:0.07,gain:0.06}); setTimeout(()=>beep({freq:650,type:'sine',dur:0.09,gain:0.05}),90)} };
$('#soundBtn').addEventListener('click',()=>{ soundOn=!soundOn; localStorage.setItem(SOUND_PREF_KEY,soundOn?'1':'0'); $('#soundIcon').textContent=soundOn?'ğŸ”Š':'ğŸ”‡'; sfx.click(); });

/* ===== State ===== */
let state={ name:'', teams:[], groups:[], standings:{}, bracket:null, overall:null };

/* ===== Avatars ===== */
function initials(name){
  const parts=(name||'').trim().split(/\s+/).filter(Boolean);
  const a=parts[0]?.[0]||'?';
  const b=parts[1]?.[0]||'';
  return (a+b).toUpperCase();
}
function avatarHTML(team, alt=false){
  const cls = alt ? 'avatar alt' : 'avatar';
  if(team?.imageUrl){
    return `<span class="${cls}"><img src="${team.imageUrl}" alt=""></span>`;
  }
  return `<span class="${cls}">${initials(team?.name||'?')}</span>`;
}

/* ===== Image compress â†’ dataURL (persist in localStorage) ===== */
async function fileToDataUrl(file, max=256, quality=0.82){
  const img = await new Promise((res, rej)=>{
    const i=new Image();
    i.onload=()=>res(i);
    i.onerror=rej;
    i.src=URL.createObjectURL(file);
  });
  const w=img.naturalWidth, h=img.naturalHeight;
  const scale = Math.min(1, max / Math.max(w,h));
  const cw = Math.max(1, Math.round(w*scale));
  const ch = Math.max(1, Math.round(h*scale));
  const c=document.createElement('canvas');
  c.width=cw; c.height=ch;
  const ctx=c.getContext('2d',{alpha:false});
  ctx.drawImage(img, 0, 0, cw, ch);
  // JPEG to reduce size
  const out=c.toDataURL('image/jpeg', quality);
  URL.revokeObjectURL(img.src);
  return out;
}

/* ===== Team Modal ===== */
let teamDraft=null; // {mode:'add'|'edit', id, imageUrl}
function teamModalOpen(mode, id=null){
  teamDraft={mode, id, imageUrl:null};

  const isEdit = mode==='edit';
  const t = isEdit ? state.teams.find(x=>x.id===id) : null;

  $('#teamTitle').textContent = isEdit ? 'RediÄ£Ä“t komandu' : 'Pievienot komandu';
  $('#teamSub').textContent   = isEdit ? 'Maini nosaukumu/attÄ“lu. (Komandu skaitu pÄ“c grupu Ä£enerÄ“Å¡anas nemaini.)' : 'Ievadi nosaukumu un (ja gribi) pievieno attÄ“lu.';
  $('#teamNameInput').value   = t?.name || '';
  teamDraft.imageUrl          = t?.imageUrl || null;
  renderTeamPreview();

  // buttons
  const canDelete = isEdit && !state.groups?.length; // droÅ¡i dzÄ“st tikai pirms Ä£enerÄ“Å¡anas
  $('#teamDeleteBtn').disabled = !canDelete;
  $('#teamDeleteBtn').style.display = isEdit ? 'inline-flex' : 'none';

  $('#teamSaveNextBtn').style.display = isEdit ? 'none' : 'inline-flex';
  $('#teamSaveDoneBtn').textContent   = isEdit ? 'SaglabÄt' : 'Pabeigt';

  $('#teamBackdrop').classList.add('open');
  $('#teamModal').classList.add('open');
  $('#teamModal').setAttribute('aria-hidden','false');

  setTimeout(()=>$('#teamNameInput').focus(), 40);
}
function teamModalClose(){
  $('#teamBackdrop').classList.remove('open');
  $('#teamModal').classList.remove('open');
  $('#teamModal').setAttribute('aria-hidden','true');
  teamDraft=null;
  $('#teamFile').value='';
}
function renderTeamPreview(){
  const box=$('#teamPhotoPreview');
  const name=$('#teamNameInput').value.trim() || '??';
  if(teamDraft?.imageUrl){
    box.innerHTML = `<img src="${teamDraft.imageUrl}" alt="">`;
  }else{
    box.textContent = initials(name);
  }
}
$('#teamBackdrop').addEventListener('click', ()=>{ teamModalClose(); sfx.click(); });
$('#teamCloseBtn').addEventListener('click', ()=>{ teamModalClose(); sfx.click(); });

$('#teamPickPhotoBtn').addEventListener('click', ()=>$('#teamFile').click());
$('#teamRemovePhotoBtn').addEventListener('click', ()=>{
  teamDraft.imageUrl=null;
  renderTeamPreview();
  sfx.click();
});
$('#teamNameInput').addEventListener('input', ()=>renderTeamPreview());

$('#teamFile').addEventListener('change', async ()=>{
  const f=$('#teamFile').files[0];
  if(!f) return;
  try{
    teamDraft.imageUrl = await fileToDataUrl(f, 256, 0.82);
    renderTeamPreview();
    sfx.success();
  }catch{
    notice('NeizdevÄs ielÄdÄ“t attÄ“lu.');
  }
});

function teamValidateName(){
  const name=$('#teamNameInput').value.trim();
  if(!name){ notice('Ievadi komandas nosaukumu.'); return null; }
  return name;
}
function teamSave(applyMode){
  const name=teamValidateName();
  if(!name) return false;

  if(teamDraft.mode==='add'){
    if(state.groups?.length){ notice('Komandu skaitu pÄ“c grupu Ä£enerÄ“Å¡anas nemaini. NotÄ«ri turnÄ«ru, ja vajag mainÄ«t komandas.'); return false; }
    state.teams.push({id:uid(), name, imageUrl:teamDraft.imageUrl});
  }else{
    const t=state.teams.find(x=>x.id===teamDraft.id);
    if(t){
      t.name=name;
      t.imageUrl=teamDraft.imageUrl;
      // ja jau ir grupas â€” pÄrrÄ“Ä·inam standings (nosaukums mainÄs)
      if(state.groups?.length){
        state.standings=computeStandings(state.groups, Object.fromEntries(state.teams.map(t=>[t.id,t])));
      }
    }
  }
  saveState(state);
  renderTeamsList();
  if(state.groups?.length){ renderGroups(); renderStandings(); renderBracket(); }
  sfx.success();

  if(applyMode==='next'){
    // clear for next team
    $('#teamNameInput').value='';
    teamDraft.imageUrl=null;
    renderTeamPreview();
    $('#teamNameInput').focus();
  }else{
    teamModalClose();
  }
  return true;
}
$('#teamSaveNextBtn').addEventListener('click', ()=>teamSave('next'));
$('#teamSaveDoneBtn').addEventListener('click', ()=>{
  if(teamDraft?.mode==='add'){
    // pabeigt: ja lauks tukÅ¡s â€” vienkÄrÅ¡i aizver (lai nav uzspieÅ¡anas)
    const name=$('#teamNameInput').value.trim();
    if(!name){ teamModalClose(); sfx.click(); return; }
  }
  teamSave('done');
});

$('#teamDeleteBtn').addEventListener('click', ()=>{
  if(!teamDraft || teamDraft.mode!=='edit') return;
  if(state.groups?.length){ notice('DzÄ“Å¡ana pÄ“c grupu Ä£enerÄ“Å¡anas nav atÄ¼auta.'); return; }
  state.teams = state.teams.filter(t=>t.id!==teamDraft.id);
  saveState(state);
  renderTeamsList();
  teamModalClose();
  sfx.click();
});

$('#addTeamBtn').addEventListener('click', ()=>{
  if(state.groups?.length){
    notice('Komandu pievienoÅ¡ana pÄ“c grupu Ä£enerÄ“Å¡anas nav atÄ¼auta. NotÄ«ri turnÄ«ru, ja vajag mainÄ«t komandas.');
    return;
  }
  teamModalOpen('add');
  sfx.click();
});

function renderTeamsList(){
  const host=$('#teamsList');
  host.innerHTML='';
  $('#teamsCount').textContent = state.teams.length;

  const lockCount = !!state.groups?.length;

  state.teams.forEach(t=>{
    const row=document.createElement('div');
    row.className='team-row';
    row.innerHTML=`
      <div class="team-left">
        ${avatarHTML(t,false)}
        <div class="team-name">${t.name}</div>
      </div>
      <div class="team-actions">
        <button type="button" class="icon-btn" data-act="edit" title="RediÄ£Ä“t">âœ</button>
        <button type="button" class="icon-btn" data-act="del" title="DzÄ“st" ${lockCount?'disabled':''}>ğŸ—‘</button>
      </div>
    `;
    row.querySelector('[data-act="edit"]').addEventListener('click', ()=>{
      teamModalOpen('edit', t.id); sfx.click();
    });
    row.querySelector('[data-act="del"]').addEventListener('click', ()=>{
      if(lockCount){ notice('DzÄ“Å¡ana pÄ“c grupu Ä£enerÄ“Å¡anas nav atÄ¼auta.'); return; }
      state.teams = state.teams.filter(x=>x.id!==t.id);
      saveState(state);
      renderTeamsList();
      sfx.click();
    });
    host.appendChild(row);
  });

  updateGroupOptions();
}

/* ===== Grouping / fixtures ===== */
function deriveGroupCount(n,str){
  const allowed=[2,4,6];
  if(str==='n1') return (n<=6)?1:deriveGroupCount(n,'auto');
  if(str==='auto' && n<=6) return 1;
  if(str?.startsWith('n')){
    const req=+str.slice(1);
    if(req===1 && n<=6) return 1;
    if(allowed.includes(req)) return Math.min(req,n);
  }
  if(n<=6) return 1;
  const target=Math.round(n/4); let best=2;
  for(const k of allowed){
    if(k>n) continue;
    const dK=Math.abs(k-target), dB=Math.abs(best-target);
    if(dK<dB||(dK===dB&&k>best)) best=k;
  }
  return best;
}
function makeGroups(teams,str='auto'){
  const n=teams.length; if(n<2) return [];
  const gCount=deriveGroupCount(n,str), shuffled=shuffle([...teams]);
  const groups=Array.from({length:gCount},(_,i)=>({id:String.fromCharCode(65+i),teams:[],matches:[]}));
  shuffled.forEach((t,i)=>groups[i%gCount].teams.push(t.id));
  groups.forEach(g=>{
    g.matches=generateRR(g.teams).map(m=>({id:uid(),round:m.round,home:m.home,away:m.away,hs:null,as:null,ot:false}));
  });
  return groups;
}
function generateRR(teamIds){
  const t=[...teamIds]; if(t.length%2===1) t.push(null);
  const n=t.length, rounds=n-1, half=n/2, fx=[];
  for(let r=0;r<rounds;r++){
    for(let i=0;i<half;i++){
      const a=t[i], b=t[n-1-i];
      if(a!==null && b!==null){
        const swap=(r%2===0)===(i%2===0);
        fx.push({round:r+1,home:swap?a:b,away:swap?b:a});
      }
    }
    const fixed=t[0], rest=t.slice(1);
    rest.unshift(rest.pop());
    t.splice(0,t.length,fixed,...rest);
  }
  return fx;
}

/* ===== Scoring & standings ===== */
function isScored(m){ return Number.isFinite(m.hs)&&Number.isFinite(m.as)&&m.hs!==m.as }
function computeStandings(groups,map){
  const out={};
  for(const g of groups){
    const table=g.teams.map(id=>({teamId:id,name:map[id].name,played:0,w:0,l:0,gf:0,ga:0,gd:0,pts:0}));
    const idx=Object.fromEntries(table.map((r,i)=>[r.teamId,i]));
    for(const m of g.matches){
      if(!isScored(m)) continue;
      const A=table[idx[m.home]], B=table[idx[m.away]];
      A.played++; B.played++;
      A.gf+=m.hs; A.ga+=m.as; A.gd=A.gf-A.ga;
      B.gf+=m.as; B.ga+=m.hs; B.gd=B.gf-B.ga;
      if(m.hs>m.as){
        A.w++; B.l++;
        if(m.ot){A.pts+=2; B.pts+=1}else{A.pts+=3}
      }else{
        B.w++; A.l++;
        if(m.ot){B.pts+=2; A.pts+=1}else{B.pts+=3}
      }
    }
    table.sort((a,b)=> (b.pts-a.pts)||(b.gd-a.gd)||(b.gf-a.gf)||a.name.localeCompare(b.name));
    out[g.id]=table;
  }
  return out;
}

/* ===== Bracket ===== */
function buildBracketFromStandings(st){
  const gids=Object.keys(st).sort(), c=gids.length;
  const topN=(gid,n)=>{ const arr=st[gid]||[]; const out=[]; for(let i=0;i<n;i++) out.push(arr[i]?.teamId ?? null); return out; }
  const pad=(a,n)=>{const k=[...a];while(k.length<n)k.push(null);return k}
  const mk=(pairs)=>({ qf:pairs.map(p=>({id:uid(),home:p.home,away:p.away,hs:null,as:null,ot:false})),
                       sf:[{id:uid(),home:null,away:null,hs:null,as:null,ot:false},{id:uid(),home:null,away:null,hs:null,as:null,ot:false}],
                       fin:[{id:uid(),home:null,away:null,hs:null,as:null,ot:false}],
                       third:[{id:uid(),home:null,away:null,hs:null,as:null,ot:false}] });
  if(c===2){
    const [A,B]=gids; const A4=pad(topN(A,4),4), B4=pad(topN(B,4),4);
    return mk([{home:A4[0],away:B4[3]},{home:A4[1],away:B4[2]},{home:B4[0],away:A4[3]},{home:B4[1],away:A4[2]}]);
  }
  if(c===4){
    const [A,B,C,D]=gids;
    const A2=pad(topN(A,2),2),B2=pad(topN(B,2),2),C2=pad(topN(C,2),2),D2=pad(topN(D,2),2);
    return mk([{home:A2[0],away:B2[1]},{home:B2[0],away:A2[1]},{home:C2[0],away:D2[1]},{home:D2[0],away:C2[1]}]);
  }
  if(c===6){
    const rank=(a,b)=> (b?.pts||0)-(a?.pts||0)||(b?.gd||0)-(a?.gd||0)||(b?.gf||0)-(a?.gf||0)||(a?.name||'').localeCompare(b?.name||'');
    const firsts=gids.map(g=>st[g][0]&&{...st[g][0],gid:g}).filter(Boolean);
    const seconds=gids.map(g=>st[g][1]&&{...st[g][1],gid:g}).filter(Boolean).sort(rank);
    const q=[...firsts, ...seconds.slice(0,2)];
    while(q.length<8) q.push({teamId:null});
    q.sort(rank);
    const s=q.map(x=>x.teamId??null);
    return mk([{home:s[0],away:s[7]},{home:s[1],away:s[6]},{home:s[2],away:s[5]},{home:s[3],away:s[4]}]);
  }
  const all=[]; for(const g of gids) all.push(...(st[g]||[]));
  all.sort((a,b)=> (b.
