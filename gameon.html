<!doctype html>
<html lang="lv">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Turnīru Aplikācija — Grupas + Playoff + Sheets Sync</title>
<meta name="color-scheme" content="light dark" />
<style>
  :root{
    --bg:#0b0f14; --card:#121826ee; --text:#e6e9ef; --muted:#9aa4b2; --ring:#2a3250;
    --accent:#7c5cff; --ok:#19c37d; --danger:#ff5d5d; --radius:14px; --gap:18px;
    --shadow:0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.04);
    --font:ui-sans-serif,-apple-system,"SF Pro Text","Inter","Segoe UI",Roboto,Arial;
  }
  @media(prefers-color-scheme:light){
    :root{ --bg:#f7f8fb; --card:#ffffff; --text:#0f172a; --muted:#51607a; --ring:#dfe2f2; --shadow:0 10px 30px rgba(10,20,40,.08) }
  }
  html,body{height:100%} body{margin:0;background:var(--bg);color:var(--text);font-family:var(--font)}
  header{position:sticky;top:0;z-index:5;background:var(--card);border-bottom:1px solid var(--ring);backdrop-filter:saturate(120%) blur(8px)}
  .bar{max-width:1200px;margin:0 auto;padding:12px 20px;display:flex;gap:12px;align-items:center;justify-content:space-between}
  .brand{display:flex;gap:10px;align-items:center;font-weight:800}
  .dot{width:14px;height:14px;border-radius:50%;background:linear-gradient(135deg,var(--accent),#45a2ff)}
  .btn{appearance:none;border:1px solid var(--ring);background:var(--card);box-shadow:var(--shadow);
    color:var(--text);border-radius:999px;padding:9px 14px;cursor:pointer}
  .btn--accent{border:none;background:linear-gradient(135deg,var(--accent),#45a2ff);color:#fff}
  .wrap{max-width:1200px;margin:20px auto;padding:0 20px 60px}
  .panel{background:var(--card);border:1px solid var(--ring);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
  .grid{display:grid;gap:var(--gap)}
  .grid.cols-2{grid-template-columns:1.2fr .8fr}
  .grid.cols-3{grid-template-columns:1fr 1fr 1fr}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  input,textarea,select{width:100%;background:transparent;color:var(--text);border:1px solid var(--ring);
    border-radius:10px;padding:10px}
  .muted{color:var(--muted);font-size:13px}
  h2{margin:0 0 8px;font-size:18px}
  h3{margin:6px 0 6px;font-size:15px;color:var(--muted);text-transform:uppercase;letter-spacing:.12em}
  .pill{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border:1px solid var(--ring);border-radius:999px}
  /* Tables */
  table{width:100%;border-collapse:separate;border-spacing:0 8px}
  th,td{text-align:left;padding:10px 12px}
  thead th{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.12em}
  tbody tr{background:linear-gradient(180deg,transparent, color-mix(in oklab, var(--card) 85%, transparent));}
  tbody td:first-child{border-radius:10px 0 0 10px}
  tbody td:last-child{border-radius:0 10px 10px 0}
  .score-in{width:52px;text-align:center}
  /* Bracket */
  .bracket{position:relative;display:grid;gap:var(--gap);grid-template-columns:1fr 1fr 1fr}
  .round{display:grid;gap:var(--gap)}
  .match{border:1px solid var(--ring);border-radius:12px;padding:12px;background:color-mix(in oklab, var(--card) 94%, transparent)}
  .team{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center;padding:8px;border-radius:8px}
  .team.win{outline:2px solid color-mix(in oklab, var(--ok) 40%, transparent);outline-offset:-2px}
  .team .name{font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  .team .seed{font-weight:800;font-size:12px;padding:3px 8px;border:1px solid var(--ring);border-radius:999px}
  .team .score{font-weight:800;border:1px solid var(--ring);border-radius:8px;padding:4px 8px;min-width:36px;text-align:center}
  .status{font-size:12px;color:var(--muted)}
  .links{position:absolute;inset:0;pointer-events:none}
  @media(max-width:980px){.grid.cols-2{grid-template-columns:1fr}.bracket{grid-template-columns:repeat(3,min(86vw,420px));overflow:auto}}
</style>
</head>
<body>
<header>
  <div class="bar">
    <div class="brand"><span class="dot"></span>Turnīru Aplikācija</div>
    <div class="row">
      <button class="btn" id="exportBtn">Eksportēt</button>
      <button class="btn" id="importBtn">Importēt</button>
      <button class="btn" id="resetBtn">Notīrīt</button>
    </div>
  </div>
</header>

<main class="wrap grid cols-2">
  <!-- SETUP -->
  <section class="panel grid" id="setupPanel">
    <div class="grid">
      <h2>1) Ievadi komandas</h2>
      <div class="row">
        <input id="tName" placeholder="Turnīra nosaukums (neobligāts)" />
      </div>
      <div class="row">
        <textarea id="teamsInput" rows="10" placeholder="Katru komandu jaunā rindā..."></textarea>
      </div>
      <div class="row">
        <select id="groupStrategy">
          <option value="auto" selected>Automātiski: ~4 komandas grupā</option>
          <option value="n2">2 grupas</option>
          <option value="n3">3 grupas</option>
          <option value="n4">4 grupas</option>
          <option value="n5">5 grupas</option>
          <option value="n6">6 grupas</option>
          <option value="n7">7 grupas</option>
          <option value="n8">8 grupas</option>
        </select>
        <button class="btn btn--accent" id="genGroups">Ģenerēt grupas</button>
      </div>
      <p class="muted">Dati glabājas lokāli (localStorage) un fonā tiek sūtīti uz Google Sheets (ja iestatīts <code>SYNC_ENDPOINT</code>).</p>
    </div>

    <div id="groupsPanel" class="grid" hidden>
      <h2>2) Grupas & kalendārs</h2>
      <div id="groupsHost" class="grid cols-3"></div>
    </div>

    <div id="standingsPanel" class="grid" hidden>
      <h2>3) Stāvējumus (Standings)</h2>
      <div id="standingsHost" class="grid cols-3"></div>
    </div>

    <div id="playoffPanel" class="grid" hidden>
      <div class="row" style="justify-content:space-between">
        <h2>4) Playoff (no Quarterfinals)</h2>
        <button class="btn btn--accent" id="buildBracket">Ģenerēt Bracket</button>
      </div>
      <div class="bracket">
        <div class="round" id="qfCol"><h3>Ceturtdaļfināli</h3></div>
        <div class="round" id="sfCol"><h3>Pusfināli</h3></div>
        <div class="round" id="finCol"><h3>Fināls</h3></div>
        <svg class="links" id="linkLayer"></svg>
      </div>
    </div>
  </section>

  <!-- INFO -->
  <aside class="panel">
    <h2>Noteikumi & Parametri</h2>
    <ul>
      <li>Grupu spēles: pilns <b>round-robin</b> katrā grupā.</li>
      <li>Punkti: uzvara 3p, neizšķirts 1p, zaudējums 0p.</li>
      <li>Ranga kritēriji: Punkti → Vārtu starpība (GD) → Gūti (GF) → Alfabēts.</li>
      <li>Playoff: atlasām <b>8 labākās</b> komandas pēc ranga (vispirms 1. vietas, tad 2., u.t.t.). Ja nepietiek, pievieno <i>BYE</i>.</li>
      <li>Bracketa pāri: top4 sēklas vs bottom4 (1–8, 2–7, 3–6, 4–5).</li>
    </ul>
    <p class="muted">Ievieto savu Google Apps Script Web App URL konstantē <code>SYNC_ENDPOINT</code> zemāk esošajā skriptā.</p>
  </aside>
</main>

<script>
/* ======================= SYNC CONFIG ======================= */
/** ←←← Ievieto šeit savu Google Apps Script / Web App URL (no iepriekšējā koda) */
const SYNC_ENDPOINT = ''; // piem.: 'https://script.google.com/macros/s/AKfycb.../exec'
const SYNC_ENABLED  = !!SYNC_ENDPOINT;

/* ======================= UTIL ======================= */
const $ = (sel, root=document)=>root.querySelector(sel);
const $$ = (sel, root=document)=>Array.from(root.querySelectorAll(sel));
const uid = ()=>Math.random().toString(36).slice(2,9);
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } return a }
function deepClone(x){ return JSON.parse(JSON.stringify(x)); }

/* ======================= STORAGE (localStorage only) ======================= */
const STORAGE_KEY='tournament_state_v2';
function saveState(state){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  // fonā – snapshot minimālai atskaitei
  Sync.push({type:'STATE_SAVE', summary: {
    name: state.name,
    teamCount: state.teams.length,
    groupCount: state.groups.length,
    hasBracket: !!state.bracket
  }});
}
function loadState(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if(!raw) return null;
  try { return JSON.parse(raw) } catch { return null }
}
function clearState(){
  localStorage.removeItem(STORAGE_KEY);
}

/* ======================= CLIENT ID ======================= */
function getClientId(){
  let id = localStorage.getItem('tournament_client_id');
  if(!id){
    id = (crypto.randomUUID?.() ?? ('c_'+uid()));
    localStorage.setItem('tournament_client_id', id);
  }
  return id;
}

/* ======================= SYNC QUEUE ======================= */
const Sync = {
  key: 'tournament_sync_queue_v1',
  queue: [],
  timer: null,
  busy: false,
  init(){
    try{ this.queue = JSON.parse(localStorage.getItem(this.key) || '[]') }catch{ this.queue = [] }
    // auto flush uzreiz, ja ir savienojums
    if (SYNC_ENABLED && navigator.onLine) this.schedule(300);
    // notikumi
    window.addEventListener('online', ()=>this.schedule(0));
    document.addEventListener('visibilitychange', ()=>{
      if(document.visibilityState==='hidden') this.flush({beacon:true});
      else this.schedule(200);
    });
    window.addEventListener('beforeunload', ()=>this.flush({beacon:true}));
  },
  persist(){ localStorage.setItem(this.key, JSON.stringify(this.queue)) },
  push(event){
    if(!SYNC_ENABLED) return; // ja nav endpointa — neko
    this.queue.push({ t:Date.now(), client:getClientId(), event });
    this.persist();
    this.schedule(400);
  },
  schedule(ms=400){
    if(!SYNC_ENABLED) return;
    clearTimeout(this.timer);
    this.timer = setTimeout(()=>this.flush().catch(()=>{}), ms);
  },
  async flush({beacon=false}={}){
    if(!SYNC_ENABLED || !this.queue.length) return;
    const batch = this.queue.slice(0, 50); // porcijās
    const payload = JSON.stringify({ client:getClientId(), ua:navigator.userAgent, batch });
    try{
      if(beacon && navigator.sendBeacon){
        const ok = navigator.sendBeacon(SYNC_ENDPOINT, new Blob([payload], {type:'application/json'}));
        if(ok){ this.queue.splice(0, batch.length); this.persist(); }
        return;
      }
      const res = await fetch(SYNC_ENDPOINT, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: payload,
        mode:'cors', // ja GAS neatļauj CORS, skat. catch -> no-cors
        keepalive: true
      });
      if(res.ok){
        this.queue.splice(0, batch.length); this.persist();
      } else {
        // neatmetam — mēģināsim vēlāk
      }
    }catch(e){
      // fallback bez CORS atbildes nolasīšanas
      try{ await fetch(SYNC_ENDPOINT, { method:'POST', body: payload, mode:'no-cors', keepalive:true }); }
      catch(_){}
      // neatkarīgi no rezultāta — paturam rindā, mēģināsim vēlreiz
    }finally{
      if(this.queue.length) this.schedule(1500);
    }
  }
};
Sync.init();

/* ======================= STATE ======================= */
let state = {
  name: '',
  teams: [],           // [{id,name}]
  groups: [],          // [{id:'A', teams:[ids], matches:[{id,round,home,away,hs,as}]}]
  standings: {},       // { A:[{teamId,pts,gd,gf,ga,played,w,d,l}], ... }
  bracket: null        // { qf:[{home,away,hs,as}], sf:[...], fin:[...] }
};

/* ======================= GROUPING ======================= */
function deriveGroupCount(n, strategy){
  if(strategy==='auto'){
    const guess = Math.max(2, Math.round(n/4));
    return Math.min(8, Math.max(1, Math.min(guess, n)));
  }
  const fixed = Number(strategy.slice(1));
  return Math.min(fixed, n) || 2;
}

function makeGroups(teams, strategy='auto'){
  const n = teams.length;
  if(n<2) return [];
  const gCount = deriveGroupCount(n, strategy);
  const shuffled = shuffle([...teams]);
  const groups = Array.from({length:gCount}, (_,i)=>({ id:String.fromCharCode(65+i), teams:[], matches:[] }));
  shuffled.forEach((t,i)=> groups[i%gCount].teams.push(t.id));
  groups.forEach(g=>{
    g.matches = generateRoundRobin(g.teams).map(m=>({ id: uid(), round:m.round, home:m.home, away:m.away, hs:null, as:null }));
  });
  // sync: grupu izveide
  Sync.push({type:'GROUPS_INIT', groups: groups.map(g=>({id:g.id, teamCount:g.teams.length, matchCount:g.matches.length}))});
  return groups;
}

// Berger rotation
function generateRoundRobin(teamIds){
  const teams = [...teamIds];
  const isOdd = teams.length%2===1;
  if(isOdd) teams.push(null);
  const n = teams.length, rounds = n-1, half = n/2;
  const fixtures = [];
  for(let r=0;r<rounds;r++){
    for(let i=0;i<half;i++){
      const t1 = teams[i], t2 = teams[n-1-i];
      if(t1!==null && t2!==null){
        const swap = (r%2===0)===(i%2===0);
        fixtures.push({ round:r+1, home: swap?t1:t2, away: swap?t2:t1 });
      }
    }
    const fixed = teams[0], rest = teams.slice(1);
    rest.unshift(rest.pop()); teams.splice(0,teams.length, fixed, ...rest);
  }
  return fixtures;
}

/* ======================= STANDINGS ======================= */
function computeStandings(groups, teamsMap){
  const standings = {};
  for(const g of groups){
    const table = g.teams.map(id=>({
      teamId:id, name:teamsMap[id].name, played:0, w:0,d:0,l:0, gf:0,ga:0, gd:0, pts:0
    }));
    const idx = Object.fromEntries(table.map((r,i)=>[r.teamId,i]));
    for(const m of g.matches){
      if(m.hs==null || m.as==null) continue;
      const A = table[idx[m.home]], B = table[idx[m.away]];
      A.played++; B.played++;
      A.gf += m.hs; A.ga += m.as; A.gd = A.gf - A.ga;
      B.gf += m.as; B.ga += m.hs; B.gd = B.gf - B.ga;
      if(m.hs>m.as){ A.w++; B.l++; A.pts+=3 }
      else if(m.hs<m.as){ B.w++; A.l++; B.pts+=3 }
      else { A.d++; B.d++; A.pts+=1; B.pts+=1 }
    }
    table.sort((a,b)=>{
      if(b.pts!==a.pts) return b.pts-a.pts;
      if(b.gd!==a.gd) return b.gd-a.gd;
      if(b.gf!==a.gf) return b.gf-a.gf;
      return a.name.localeCompare(b.name);
    });
    standings[g.id]=table;
  }
  return standings;
}

/* ======================= BRACKET ======================= */
function buildBracketFromStandings(standings){
  const ranks = [];
  const groups = Object.keys(standings).sort();
  let layer=0;
  while(ranks.length<8){
    let added=false;
    for(const gid of groups){
      const row = standings[gid][layer];
      if(row){ ranks.push({ ...row, group:gid, rank:layer+1 }); added=true; if(ranks.length===8) break; }
    }
    if(!added) break;
    layer++;
  }
  while(ranks.length<8){
    ranks.push({ teamId:null, name:'BYE', pts:0, gd:0, gf:0, group:'-', rank:99 });
  }
  ranks.sort((a,b)=>{
    if(a.teamId===null && b.teamId!==null) return 1;
    if(b.teamId===null && a.teamId!==null) return -1;
    if(a.rank!==b.rank) return a.rank-b.rank;
    if(b.pts!==a.pts) return b.pts-a.pts;
    if(b.gd!==a.gd) return b.gd-a.gd;
    if(b.gf!==a.gf) return b.gf-a.gf;
    return a.name.localeCompare(b.name);
  });
  const seedsTop = ranks.slice(0,4);
  const seedsBot = ranks.slice(4,8).reverse();
  const qf = [];
  for(let i=0;i<4;i++){
    const h = seedsTop[i]||{name:'BYE'};
    const a = seedsBot[i]||{name:'BYE'};
    qf.push({ id:uid(), home:h.teamId, away:a.teamId, hs:null, as:null, hName:h.name, aName:a.name });
  }
  Sync.push({type:'BRACKET_INIT', qfPairs: qf.map(m=>({homeName:hNameOf(m), awayName:aNameOf(m)}))});
  return { qf, sf:[{id:uid(),home:null,away:null,hs:null,as:null},{id:uid(),home:null,away:null,hs:null,as:null}], fin:[{id:uid(),home:null,away:null,hs:null,as:null}] };
}
function nameOf(id, teamsMap){ return id ? teamsMap[id]?.name||'?' : 'BYE' }
const hNameOf = m => m.hName ?? 'BYE';
const aNameOf = m => m.aName ?? 'BYE';

function propagateBracket(br, teamsMap){
  const winnersQF = br.qf.map(m=> pickWinner(m,teamsMap) );
  br.sf[0].home = winnersQF[0]; br.sf[0].away = winnersQF[3];
  br.sf[1].home = winnersQF[1]; br.sf[1].away = winnersQF[2];
  const winnersSF = br.sf.map(m=> pickWinner(m,teamsMap));
  br.fin[0].home = winnersSF[0]; br.fin[0].away = winnersSF[1];
}
function pickWinner(m, teamsMap){
  if(!m) return null;
  if(m.home && !m.away) return m.home;
  if(!m.home && m.away) return m.away;
  if(!m.home && !m.away) return null;
  if(Number.isFinite(m.hs) && Number.isFinite(m.as)){
    if(m.hs>m.as) return m.home;
    if(m.as>m.hs) return m.away;
    return m.home; // tie-break: mājinieki
  }
  return null;
}

/* ======================= RENDER ======================= */
function renderGroups(){
  const host = $('#groupsHost'); host.innerHTML='';
  const teamsMap = Object.fromEntries(state.teams.map(t=>[t.id,t]));
  state.groups.forEach(g=>{
    const wrap = document.createElement('div'); wrap.className='panel';
    wrap.innerHTML = `<h3>Grupa ${g.id}</h3><div class="muted">${g.teams.length} komandas • ${new Set(g.matches.map(m=>m.round)).size} kārtas</div>`;
    const tbl = document.createElement('table');
    tbl.innerHTML = `
      <thead><tr><th>R</th><th>Mājinieki</th><th></th><th>Viesi</th><th>Rez.</th></tr></thead>
      <tbody></tbody>
    `;
    const body = $('tbody', tbl);
    g.matches.forEach((m)=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td>${m.round}</td>
        <td>${teamsMap[m.home].name}</td>
        <td class="muted">vs</td>
        <td>${teamsMap[m.away].name}</td>
        <td>
          <input class="score-in" type="number" min="0" inputmode="numeric" value="${m.hs??''}" data-g="${g.id}" data-mid="${m.id}" data-side="hs" />
          :
          <input class="score-in" type="number" min="0" inputmode="numeric" value="${m.as??''}" data-g="${g.id}" data-mid="${m.id}" data-side="as" />
        </td>`;
      body.appendChild(tr);
    });
    wrap.appendChild(tbl);
    host.appendChild(wrap);
  });
  $('#groupsPanel').hidden = state.groups.length===0;

  // Input handlers
  $$('#groupsHost .score-in').forEach(inp=>{
    inp.addEventListener('change', ()=>{
      const gId = inp.dataset.g, mId=inp.dataset.mid, side=inp.dataset.side;
      const g = state.groups.find(x=>x.id===gId);
      const m = g.matches.find(x=>x.id===mId);
      const val = inp.value==='' ? null : Math.max(0, parseInt(inp.value,10));
      m[side] = Number.isFinite(val) ? val : null;
      // sync: katra rezultāta ievade
      Sync.push({type:'GROUP_SCORE', groupId:gId, matchId:mId, side, value:m[side]});
      state.standings = computeStandings(state.groups, Object.fromEntries(state.teams.map(t=>[t.id,t])));
      saveState(state);
      renderStandings();
    });
  });
}

function renderStandings(){
  const host = $('#standingsHost'); host.innerHTML='';
  const st = state.standings || {};
  const groups = Object.keys(st).sort();
  groups.forEach(gid=>{
    const wrap = document.createElement('div'); wrap.className='panel';
    wrap.innerHTML = `<h3>Grupa ${gid} — Stāvējums</h3>`;
    const tbl = document.createElement('table');
    tbl.innerHTML = `
      <thead><tr><th>#</th><th>Komanda</th><th>Sp</th><th>U</th><th>N</th><th>Z</th><th>GF</th><th>GA</th><th>GD</th><th>P</th></tr></thead>
      <tbody></tbody>`;
    const body = $('tbody', tbl);
    st[gid].forEach((r,i)=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${i+1}</td><td>${r.name}</td><td>${r.played}</td><td>${r.w}</td><td>${r.d}</td><td>${r.l}</td><td>${r.gf}</td><td>${r.ga}</td><td>${r.gd}</td><td><b>${r.pts}</b></td>`;
      body.appendChild(tr);
    });
    wrap.appendChild(tbl);
    host.appendChild(wrap);
  });
  $('#standingsPanel').hidden = groups.length===0;
}

function winnerClass(m, side){
  if(m.home && !m.away) return side==='home'?'win':'';
  if(!m.home && m.away) return side==='away'?'win':'';
  if(Number.isFinite(m.hs) && Number.isFinite(m.as)){
    if(m.hs>m.as && side==='home') return 'win';
    if(m.as>m.hs && side==='away') return 'win';
  }
  return '';
}

function renderBracket(){
  const teamsMap = Object.fromEntries(state.teams.map(t=>[t.id,t]));
  $('#qfCol').innerHTML = '<h3>Ceturtdaļfināli</h3>';
  $('#sfCol').innerHTML = '<h3>Pusfināli</h3>';
  $('#finCol').innerHTML = '<h3>Fināls</h3>';

  const mkMatch = (m, stage, idx) => {
    const el = document.createElement('div'); el.className='match';
    const hName = nameOf(m.home, teamsMap);
    const aName = nameOf(m.away, teamsMap);
    el.innerHTML = `
      <div class="status">${stage} ${idx!=null?('• '+(idx+1)):""}</div>
      <div class="team ${winnerClass(m,'home')}">
        <div class="row"><span class="seed">H</span><span class="name">${hName}</span></div>
        <input class="score-in" type="number" min="0" value="${m.hs??''}" data-stage="${stage}" data-id="${m.id}" data-side="hs" />
      </div>
      <div class="team ${winnerClass(m,'away')}">
        <div class="row"><span class="seed">A</span><span class="name">${aName}</span></div>
        <input class="score-in" type="number" min="0" value="${m.as??''}" data-stage="${stage}" data-id="${m.id}" data-side="as" />
      </div>
    `;
    return el;
  };

  state.bracket.qf.forEach((m,i)=> $('#qfCol').appendChild(mkMatch(m,'QF',i)));
  state.bracket.sf.forEach((m,i)=> $('#sfCol').appendChild(mkMatch(m,'SF',i)));
  state.bracket.fin.forEach((m)=> $('#finCol').appendChild(mkMatch(m,'Final')));

  // Handleri
  $$('.bracket .score-in').forEach(inp=>{
    inp.addEventListener('change', ()=>{
      const stage=inp.dataset.stage, id=inp.dataset.id, side=inp.dataset.side;
      const col = stage==='QF'?'qf':stage==='SF'?'sf':'fin';
      const m = state.bracket[col].find(x=>x.id===id);
      const val = inp.value==='' ? null : Math.max(0, parseInt(inp.value,10));
      m[side] = Number.isFinite(val)?val:null;
      // sync: playoff rezultāts
      Sync.push({type:'BRACKET_SCORE', stage:col, matchId: id, side, value:m[side]});
      propagateBracket(state.bracket, Object.fromEntries(state.teams.map(t=>[t.id,t])));
      saveState(state);
      renderBracket();
    });
  });

  drawLinks();
}

function drawLinks(){
  const svg = $('#linkLayer'); if(!svg) return;
  const br = $('.bracket'); const r = br.getBoundingClientRect();
  svg.setAttribute('viewBox', `0 0 ${r.width} ${r.height}`);
  svg.setAttribute('width', r.width); svg.setAttribute('height', r.height);
  svg.innerHTML='';
  const qfEls = $$('#qfCol .match'), sfEls=$$('#sfCol .match'), finEl=$$('#finCol .match')[0];
  const pathBetween = (a,b)=>{
    const ra=a.getBoundingClientRect(), rb=b.getBoundingClientRect();
    const sx=ra.right - r.left, sy=ra.top + ra.height/2 - r.top;
    const ex=rb.left - r.left, ey=rb.top + rb.height/2 - r.top;
    const mx=(sx+ex)/2;
    return `M ${sx} ${sy} C ${mx} ${sy}, ${mx} ${ey}, ${ex} ${ey}`;
  };
  const paths=[];
  if(sfEls[0]){ if(qfEls[0]) paths.push(pathBetween(qfEls[0], sfEls[0])); if(qfEls[3]) paths.push(pathBetween(qfEls[3], sfEls[0])); }
  if(sfEls[1]){ if(qfEls[1]) paths.push(pathBetween(qfEls[1], sfEls[1])); if(qfEls[2]) paths.push(pathBetween(qfEls[2], sfEls[1])); }
  if(finEl){ if(sfEls[0]) paths.push(pathBetween(sfEls[0], finEl)); if(sfEls[1]) paths.push(pathBetween(sfEls[1], finEl)); }
  for(const d of paths){
    const p = document.createElementNS('http://www.w3.org/2000/svg','path');
    p.setAttribute('d', d); p.setAttribute('fill','none'); p.setAttribute('stroke','var(--ring)'); p.setAttribute('stroke-width','2');
    svg.appendChild(p);
  }
}

/* ======================= HOOK UP UI ======================= */
$('#genGroups').addEventListener('click', ()=>{
  const name = $('#tName').value.trim();
  const teams = $('#teamsInput').value.split('\n').map(s=>s.trim()).filter(Boolean).map(n=>({id:uid(), name:n}));
  if(teams.length<2){ alert('Ievadi vismaz 2 komandas.'); return }
  state.name = name; state.teams = teams;
  state.groups = makeGroups(teams, $('#groupStrategy').value);
  state.standings = computeStandings(state.groups, Object.fromEntries(teams.map(t=>[t.id,t])));
  state.bracket = null;
  saveState(state);
  renderGroups(); renderStandings();
  $('#playoffPanel').hidden=false;
  $('#groupsPanel').hidden=false;
  $('#standingsPanel').hidden=false;
  // sync: turnīra inicializācija
  Sync.push({type:'TOURNAMENT_INIT', name, teams: teams.map(t=>t.name)});
});

$('#buildBracket').addEventListener('click', ()=>{
  if(!state.groups.length){ alert('Vispirms jāizspēlē / jāievada grupu dati.'); return }
  state.standings = computeStandings(state.groups, Object.fromEntries(state.teams.map(t=>[t.id,t])));
  state.bracket = buildBracketFromStandings(state.standings);
  propagateBracket(state.bracket, Object.fromEntries(state.teams.map(t=>[t.id,t])));
  saveState(state);
  renderBracket();
  Sync.push({type:'BRACKET_BUILT'});
});

$('#exportBtn').addEventListener('click', ()=>{
  const data = 'data:application/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(state, null, 2));
  const a=document.createElement('a'); a.href=data; a.download=(state.name||'tournament')+'.json'; a.click();
});

$('#importBtn').addEventListener('click', async ()=>{
  const inp=document.createElement('input'); inp.type='file'; inp.accept='application/json';
  inp.onchange = async ()=>{
    const file=inp.files[0]; if(!file) return;
    try{
      const text=await file.text(); const obj=JSON.parse(text);
      state = Object.assign({name:'',teams:[],groups:[],standings:{},bracket:null}, obj);
      saveState(state);
      $('#tName').value = state.name || '';
      $('#teamsInput').value = state.teams.map(t=>t.name).join('\n');
      if(state.groups?.length){ renderGroups(); $('#groupsPanel').hidden=false }
      if(state.standings && Object.keys(state.standings).length){ renderStandings(); $('#standingsPanel').hidden=false }
      if(state.bracket){ renderBracket(); $('#playoffPanel').hidden=false }
      Sync.push({type:'IMPORT_OK', teamCount: state.teams.length});
    }catch(e){ alert('Neizdevās importēt failu.'); Sync.push({type:'IMPORT_FAIL', error:String(e)}) }
  };
  inp.click();
});

$('#resetBtn').addEventListener('click', ()=>{
  if(!confirm('Tiešām notīrīt turnīru?')) return;
  clearState();
  state={name:'',teams:[],groups:[],standings:{},bracket:null};
  $('#tName').value=''; $('#teamsInput').value='';
  $('#groupsHost').innerHTML=''; $('#standingsHost').innerHTML='';
  $('#qfCol').innerHTML='<h3>Ceturtdaļfināli</h3>'; $('#sfCol').innerHTML='<h3>Pusfināli</h3>'; $('#finCol').innerHTML='<h3>Fināls</h3>';
  $('#groupsPanel').hidden=true; $('#standingsPanel').hidden=true; $('#playoffPanel').hidden=true;
  Sync.push({type:'RESET'});
});

/* ======================= RESTORE ======================= */
(function boot(){
  const saved = loadState();
  if(saved){
    state = Object.assign(state, saved);
    $('#tName').value = state.name || '';
    $('#teamsInput').value = (state.teams||[]).map(t=>t.name).join('\n');
    if(state.groups?.length){ renderGroups(); $('#groupsPanel').hidden=false }
    if(state.standings && Object.keys(state.standings).length){ renderStandings(); $('#standingsPanel').hidden=false }
    if(state.bracket){ renderBracket(); $('#playoffPanel').hidden=false }
  }
  const ro=new ResizeObserver(()=>drawLinks());
  ro.observe($('.bracket'));
})();
</script>
</body>
</html>