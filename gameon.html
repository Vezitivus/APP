/***********************************************************
 * GOOGLE APPS SCRIPT – TURNĪRA PĀRVALDE
 ***********************************************************/

/** Norāda Google Sheets ID. */
var SPREADSHEET_ID = "1aqu4ge0K__oePsdaLGnYmsCPqy8073XzHTxzTdurBJA";

/** doGet – API ieeja */
function doGet(e) {
  var action = e.parameter.action;
  if (!action) {
    return outputJSON({ error: "No action provided" });
  }
  
  var ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  
  switch(action) {
    case "newGame":
      return newGame(ss, e);
    case "saveTeams":
      return saveTeams(e, ss);
    case "getGroupASchedule":
      return getGroupSchedule(ss, "A", e.parameter.gameName);
    case "getGroupBSchedule":
      return getGroupSchedule(ss, "B", e.parameter.gameName);
    case "standings":
      return getStandings(ss, e.parameter.gameName);
    case "getPlayoffSchedule":
      return getPlayoffSchedule(ss, e.parameter.gameName);
    case "saveGroupScore":
      return saveGroupScore(e, ss);
    case "savePlayoffScore":
      return savePlayoffScore(e, ss);
    default:
      return outputJSON({ error: "Invalid action" });
  }
}

/** Ērtāka JSON atgriešana. */
function outputJSON(obj) {
  return ContentService.createTextOutput(JSON.stringify(obj))
    .setMimeType(ContentService.MimeType.JSON);
}

/** 
 * Jauna spēle – ja spēles lapa ar lietotāja ievadīto nosaukumu jau pastāv, 
 * atgriež esošo lapu; citādi izveido jaunu lapu.
 */
function newGame(ss, e) {
  var userGameName = e.parameter.userGameName || "";
  userGameName = userGameName.trim();
  
  var sheet;
  var gameName;
  if (userGameName) {
    sheet = ss.getSheetByName(userGameName);
    if (sheet) {
      // Spēles lapa jau pastāv – atgriež esošo nosaukumu.
      gameName = userGameName;
      return outputJSON({ gameName: gameName });
    } else {
      gameName = userGameName;
    }
  } else {
    var now = new Date();
    gameName = "Game_" + Utilities.formatDate(now, ss.getSpreadsheetTimeZone(), "yyyyMMdd_HHmmss");
  }
  
  sheet = ss.insertSheet(gameName);
  sheet.clear();
  sheet.getRange(1, 1).setValue("Game: " + gameName);
  
  return outputJSON({ gameName: gameName });
}

/** Saglabā komandas un ģenerē turnīra struktūru (Group A/B Schedule, Standings A/B). */
function saveTeams(e, ss) {
  var gameName = e.parameter.gameName;
  if (!gameName) return outputJSON({ error: "No gameName provided" });
  
  var teamsParam = e.parameter.teams;
  if (!teamsParam) return outputJSON({ error: "No teams provided" });
  
  var teams;
  try {
    teams = JSON.parse(teamsParam);
  } catch(err) {
    return outputJSON({ error: "Invalid teams format" });
  }
  
  var sheet = ss.getSheetByName(gameName);
  if (!sheet) return outputJSON({ error: "Game sheet not found" });
  
  var result = generateTournamentForGame(sheet, teams);
  return outputJSON({ status: "OK", message: result.message });
}

/** 
 * Ģenerē turnīra struktūru ar 20 tukšām rindām starp sadaļām.
 * Playoffs tiks ģenerēts no Standings Top 4 (no abām grupām) pēc norādītās loģikas.
 */
function generateTournamentForGame(sheet, teams) {
  sheet.clear();
  var r = 1;
  
  // Virsraksts
  sheet.getRange(r, 1).setValue("Game: " + sheet.getName());
  r++;
  
  // 1. Team Input
  sheet.getRange(r, 1).setValue("Team Input");
  r++;
  sheet.getRange(r, 1).setValue("Team");
  r++;
  for (var i = 0; i < teams.length; i++) {
    sheet.getRange(r + i, 1).setValue(teams[i]);
  }
  r += teams.length;
  r += 20;
  
  // Sadala komandas grupās
  var groupA, groupB;
  if (teams.length <= 5) {
    groupA = teams;
    groupB = [];
  } else {
    var half = Math.ceil(teams.length / 2);
    groupA = teams.slice(0, half);
    groupB = teams.slice(half);
  }
  
  // 2. Group A Schedule
  sheet.getRange(r, 1).setValue("Group A Schedule");
  r++;
  sheet.getRange(r, 1, 1, 5).setValues([["Match #", "Team A", "Team B", "Score A", "Score B"]]);
  r++;
  var matchNum = 1;
  for (var a = 0; a < groupA.length - 1; a++) {
    for (var b = a + 1; b < groupA.length; b++) {
      sheet.getRange(r, 1, 1, 5).setValues([[matchNum, groupA[a], groupA[b], "", ""]]);
      r++;
      matchNum++;
    }
  }
  r += 20;
  
  // 3. Group B Schedule (ja ir)
  if (groupB.length > 0) {
    sheet.getRange(r, 1).setValue("Group B Schedule");
    r++;
    sheet.getRange(r, 1, 1, 5).setValues([["Match #", "Team A", "Team B", "Score A", "Score B"]]);
    r++;
    matchNum = 1;
    for (var a = 0; a < groupB.length - 1; a++) {
      for (var b = a + 1; b < groupB.length; b++) {
        sheet.getRange(r, 1, 1, 5).setValues([[matchNum, groupB[a], groupB[b], "", ""]]);
        r++;
        matchNum++;
      }
    }
    r += 20;
  }
  
  // 4. Standings A – sākotnēji ieraksta komandu sarakstu
  sheet.getRange(r, 1).setValue("Standings A");
  r++;
  sheet.getRange(r, 1, 1, 6).setValues([["Team", "Games", "Wins", "Losses", "Points For", "Points Against"]]);
  r++;
  for (var i = 0; i < groupA.length; i++) {
    sheet.getRange(r + i, 1).setValue(groupA[i]);
  }
  r += groupA.length;
  r += 20;
  
  // 5. Standings B
  if (groupB.length > 0) {
    sheet.getRange(r, 1).setValue("Standings B");
    r++;
    sheet.getRange(r, 1, 1, 6).setValues([["Team", "Games", "Wins", "Losses", "Points For", "Points Against"]]);
    r++;
    for (var i = 0; i < groupB.length; i++) {
      sheet.getRange(r + i, 1).setValue(groupB[i]);
    }
    r += groupB.length;
    r += 20;
  }
  
  // 6. Playoffs – sākotnēji ievieto paziņojumu (reālo bracket ģenerē "getPlayoffSchedule")
  sheet.getRange(r, 1).setValue("Playoffs: (tiks ģenerēts no Standings top 4, kad atvērs Playoffs sadaļu)");
  
  return { message: "Tournament structure created for " + sheet.getName() };
}

/** Palīgfunkcija: atrod norādītā virsraksta rindu datu masīvā. */
function findHeaderRow(data, headerText) {
  for (var i = 0; i < data.length; i++) {
    if (data[i][0] === headerText) return i;
  }
  return -1;
}

/** Palīgfunkcija: nolasām datus no noteiktas sadaļas (header un rows). */
function getSectionData(sheet, headerText) {
  var data = sheet.getDataRange().getValues();
  var start = findHeaderRow(data, headerText);
  if (start === -1) return { header: [], rows: [] };
  
  var header = data[start + 1];
  var rows = [];
  for (var i = start + 2; i < data.length; i++) {
    if (!data[i][0]) break;
    rows.push(data[i].slice(0, header.length));
  }
  return { header: header, rows: rows };
}

/** Atgriež Group A/B grafiku datus. */
function getGroupSchedule(ss, group, gameName) {
  if (!gameName) return outputJSON({ error: "No gameName provided" });
  
  var sheet = ss.getSheetByName(gameName);
  if (!sheet) return outputJSON({ error: "Game sheet not found" });
  
  var headerText = (group === "A") ? "Group A Schedule" : "Group B Schedule";
  var result = getSectionData(sheet, headerText);
  return outputJSON(result);
}

/** 
 * Standings – pārrēķina statistiku no "Group X Schedule", sakārto un ieraksta to "Standings X".
 * Sakārtošanas kārtība:
 *  - Wins dilstoši,
 *  - Losses augoši,
 *  - Points For dilstoši,
 *  - Points Against augoši.
 */
function getStandings(ss, gameName) {
  if (!gameName) return outputJSON({ error: "No gameName provided" });
  
  var sheet = ss.getSheetByName(gameName);
  if (!sheet) return outputJSON({ error: "Game sheet not found" });
  
  calcStandingsForGroup(sheet, "A");
  calcStandingsForGroup(sheet, "B");
  
  var standingsA = getSectionData(sheet, "Standings A");
  var standingsB = getSectionData(sheet, "Standings B");
  return outputJSON({ standingsA: standingsA, standingsB: standingsB });
}

/** Pārrēķina un sakārto statistiku attiecīgai grupai un ieraksta to "Standings X". */
function calcStandingsForGroup(sheet, group) {
  var headerText = (group === "A") ? "Group A Schedule" : "Group B Schedule";
  var scheduleData = getSectionData(sheet, headerText);
  var stats = {};
  
  scheduleData.rows.forEach(function(row) {
    // row: [Match#, Team A, Team B, Score A, Score B]
    var teamA = row[1];
    var teamB = row[2];
    var sA = parseFloat(row[3]);
    var sB = parseFloat(row[4]);
    
    if (!teamA || !teamB) return;
    if (!stats[teamA]) stats[teamA] = { games: 0, wins: 0, losses: 0, pf: 0, pa: 0 };
    if (!stats[teamB]) stats[teamB] = { games: 0, wins: 0, losses: 0, pf: 0, pa: 0 };
    
    if (!isNaN(sA) && !isNaN(sB)) {
      stats[teamA].games++;
      stats[teamB].games++;
      stats[teamA].pf += sA;
      stats[teamA].pa += sB;
      stats[teamB].pf += sB;
      stats[teamB].pa += sA;
      if (sA > sB) {
        stats[teamA].wins++;
        stats[teamB].losses++;
      } else if (sB > sA) {
        stats[teamB].wins++;
        stats[teamA].losses++;
      }
    }
  });
  
  var standingsHeader = (group === "A") ? "Standings A" : "Standings B";
  var stData = getSectionData(sheet, standingsHeader);
  if (!stData.rows || stData.rows.length === 0) return;
  
  // Izveidojam masīvu no komandu vārdiem
  var teams = stData.rows.map(function(row) { return row[0]; });
  
  // Izveidojam statistiku masīvu
  var standingsArr = teams.map(function(team) {
    var s = stats[team] || { games: 0, wins: 0, losses: 0, pf: 0, pa: 0 };
    return { team: team, games: s.games, wins: s.wins, losses: s.losses, pf: s.pf, pa: s.pa };
  });
  
  // Sakārtojam pēc: wins dilstoši, losses augoši, pf dilstoši, pa augoši.
  standingsArr.sort(function(a, b) {
    if (b.wins !== a.wins) return b.wins - a.wins;
    if (a.losses !== b.losses) return a.losses - b.losses;
    if (b.pf !== a.pf) return b.pf - a.pf;
    return a.pa - b.pa;
  });
  
  // Atrodam Standings X sadaļas sākuma rindu
  var dataRange = sheet.getDataRange().getValues();
  var headerRowIndex = findHeaderRow(dataRange, standingsHeader);
  if (headerRowIndex === -1) return;
  var startRow = headerRowIndex + 2;
  
  // Pierakstām sakārtotos datus atpakaļ
  for (var i = 0; i < standingsArr.length; i++) {
    sheet.getRange(startRow + i, 1).setValue(standingsArr[i].team);
    sheet.getRange(startRow + i, 2).setValue(standingsArr[i].games);
    sheet.getRange(startRow + i, 3).setValue(standingsArr[i].wins);
    sheet.getRange(startRow + i, 4).setValue(standingsArr[i].losses);
    sheet.getRange(startRow + i, 5).setValue(standingsArr[i].pf);
    sheet.getRange(startRow + i, 6).setValue(standingsArr[i].pa);
  }
}

/** 
 * Kad atver Playoffs, ja "Playoffs" sadaļa nav izveidota, ģenerē to no Standings TOP 4 saskaņā ar loģiku.
 */
function getPlayoffSchedule(ss, gameName) {
  if (!gameName) return outputJSON({ error: "No gameName provided" });
  
  var sheet = ss.getSheetByName(gameName);
  if (!sheet) return outputJSON({ error: "Game sheet not found" });
  
  var data = sheet.getDataRange().getValues();
  var playoffsRow = findHeaderRow(data, "Playoffs");
  if (playoffsRow === -1 || (data[playoffsRow][0] && data[playoffsRow][0].indexOf("Playoffs:") === 0)) {
    generatePlayoffsFromStandings(sheet);
  }
  
  var result = getSectionData(sheet, "Playoffs");
  return outputJSON(result);
}

/** 
 * Ģenerē "Playoffs" tabulu no Standings TOP 4 no abām grupām saskaņā ar loģiku:
 * QF1: A1 vs B4, QF2: A2 vs B3, QF3: A3 vs B2, QF4: A4 vs B1,
 * SF1 (1-4): Winner QF1 vs Winner QF4, SF2 (1-4): Winner QF2 vs Winner QF3,
 * Final: Winner SF1 vs Winner SF2, 3rd Place: Loser SF1 vs Loser SF2,
 * SF1 (5-8): Loser QF1 vs Loser QF4, SF2 (5-8): Loser QF2 vs Loser QF3,
 * 5th Place: Winner SF1 (5-8) vs Winner SF2 (5-8), 7th Place: Loser SF1 (5-8) vs Loser SF2 (5-8).
 * Kamēr rezultāti netiek ievadīti, rezultātu lauki paliek tukši.
 */
function generatePlayoffsFromStandings(sheet) {
  // Pārrēķina Standings, lai tie būtu aktuāli.
  calcStandingsForGroup(sheet, "A");
  calcStandingsForGroup(sheet, "B");
  
  var stA = getSectionData(sheet, "Standings A");
  var stB = getSectionData(sheet, "Standings B");
  if (stA.rows.length < 4 || stB.rows.length < 4) {
    var row = sheet.getLastRow() + 1;
    sheet.getRange(row, 1).setValue("Playoffs");
    sheet.getRange(row + 1, 1).setValue("Nepietiek komandu (mazāk par 4 abās grupās)");
    return;
  }
  
  var A1 = stA.rows[0][0], A2 = stA.rows[1][0], A3 = stA.rows[2][0], A4 = stA.rows[3][0];
  var B1 = stB.rows[0][0], B2 = stB.rows[1][0], B3 = stB.rows[2][0], B4 = stB.rows[3][0];
  
  var row = sheet.getLastRow() + 1;
  sheet.getRange(row, 1).setValue("Playoffs");
  row++;
  sheet.getRange(row, 1, 1, 6).setValues([["Match", "Team 1", "Team 2", "Score 1", "Score 2", "Winner"]]);
  row++;
  
  // QF
  sheet.getRange(row, 1, 4, 6).setValues([
    ["QF1", A1, B4, "", "", ""],
    ["QF2", A2, B3, "", "", ""],
    ["QF3", A3, B2, "", "", ""],
    ["QF4", A4, B1, "", "", ""]
  ]);
  row += 4; row += 2;
  
  // SF (1-4)
  sheet.getRange(row, 1, 2, 6).setValues([
    ["SF1 (1-4)", "Winner QF1", "Winner QF4", "", "", ""],
    ["SF2 (1-4)", "Winner QF2", "Winner QF3", "", "", ""]
  ]);
  row += 2; row += 2;
  
  // Final and 3rd Place
  sheet.getRange(row, 1, 2, 6).setValues([
    ["Final", "Winner SF1", "Winner SF2", "", "", ""],
    ["3rd Place", "Loser SF1", "Loser SF2", "", "", ""]
  ]);
  row += 2; row += 2;
  
  // SF (5-8)
  sheet.getRange(row, 1, 2, 6).setValues([
    ["SF1 (5-8)", "Loser QF1", "Loser QF4", "", "", ""],
    ["SF2 (5-8)", "Loser QF2", "Loser QF3", "", "", ""]
  ]);
  row += 2; row += 2;
  
  // 5th and 7th Place
  sheet.getRange(row, 1, 2, 6).setValues([
    ["5th Place", "Winner SF1 (5-8)", "Winner SF2 (5-8)", "", "", ""],
    ["7th Place", "Loser SF1 (5-8)", "Loser SF2 (5-8)", "", "", ""]
  ]);
}

/** Saglabā grupas spēles rezultātus. */
function saveGroupScore(e, ss) {
  var gameName = e.parameter.gameName;
  var group = e.parameter.group;
  var matchNumber = parseInt(e.parameter.matchNumber);
  var scoreA = e.parameter.scoreA;
  var scoreB = e.parameter.scoreB;
  
  if (!gameName || !group || !matchNumber || scoreA === undefined || scoreB === undefined)
    return outputJSON({ error: "Missing parameters" });
  
  var sheet = ss.getSheetByName(gameName);
  if (!sheet) return outputJSON({ error: "Game sheet not found" });
  
  var headerText = (group === "A") ? "Group A Schedule" : "Group B Schedule";
  var data = sheet.getDataRange().getValues();
  
  var startRow = findHeaderRow(data, headerText);
  if (startRow === -1) return outputJSON({ error: "Group schedule not found" });
  
  var rowFound = -1;
  for (var i = startRow + 2; i < data.length; i++) {
    if (data[i][0] === matchNumber) {
      rowFound = i;
      break;
    }
  }
  if (rowFound === -1) return outputJSON({ error: "Match not found" });
  
  var currentA = sheet.getRange(rowFound + 1, 4).getValue();
  var currentB = sheet.getRange(rowFound + 1, 5).getValue();
  if (currentA !== "" || currentB !== "")
    return outputJSON({ error: "Score already saved" });
  
  sheet.getRange(rowFound + 1, 4).setValue(scoreA);
  sheet.getRange(rowFound + 1, 5).setValue(scoreB);
  
  return outputJSON({ status: "Score saved" });
}

/** Saglabā Playoff spēles rezultātus un aprēķina Winner. */
function savePlayoffScore(e, ss) {
  var gameName = e.parameter.gameName;
  var matchId = e.parameter.matchId;
  var score1 = e.parameter.score1;
  var score2 = e.parameter.score2;
  
  if (!gameName || !matchId || score1 === undefined || score2 === undefined)
    return outputJSON({ error: "Missing parameters" });
  
  var sheet = ss.getSheetByName(gameName);
  if (!sheet) return outputJSON({ error: "Game sheet not found" });
  
  var data = sheet.getDataRange().getValues();
  var startRow = findHeaderRow(data, "Playoffs");
  if (startRow === -1) return outputJSON({ error: "Playoffs section not found" });
  
  var rowFound = -1;
  for (var i = startRow + 2; i < data.length; i++) {
    if (data[i][0] === matchId) {
      rowFound = i;
      break;
    }
  }
  if (rowFound === -1) return outputJSON({ error: "Match not found" });
  
  var current1 = sheet.getRange(rowFound + 1, 4).getValue();
  var current2 = sheet.getRange(rowFound + 1, 5).getValue();
  if (current1 !== "" || current2 !== "")
    return outputJSON({ error: "Score already saved" });
  
  sheet.getRange(rowFound + 1, 4).setValue(score1);
  sheet.getRange(rowFound + 1, 5).setValue(score2);
  
  var team1 = sheet.getRange(rowFound + 1, 2).getValue();
  var team2 = sheet.getRange(rowFound + 1, 3).getValue();
  var s1 = parseFloat(score1);
  var s2 = parseFloat(score2);
  var w = "";
  if (s1 > s2) w = team1;
  else if (s2 > s1) w = team2;
  else w = "Draw";
  
  sheet.getRange(rowFound + 1, 6).setValue(w);
  
  return outputJSON({ status: "Score saved" });
}
