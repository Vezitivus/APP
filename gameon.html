/**
 * GET pieprasījumu apstrāde – maršrutēšana pēc action parametra.
 * Visiem action, kas prasa darbību ar konkrētu spēles lapu, tiek nodrošināts arī "gameName" (izņemot newGame un getGameHistory).
 */
function doGet(e) {
  var action = e.parameter.action;
  if (!action) {
    return ContentService.createTextOutput(JSON.stringify({ error: "No action provided" }))
                         .setMimeType(ContentService.MimeType.JSON);
  }
  
  var ss = SpreadsheetApp.openById("1aqu4ge0K__oePsdaLGnYmsCPqy8073XzHTxzTdurBJA");
  
  if (action == "newGame") {
    return newGame(ss, e);
  } else if (action == "saveTeams") {
    return saveTeams(e, ss);
  } else if (action == "getGroupASchedule") {
    return getGroupSchedule(ss, "A", e.parameter.gameName);
  } else if (action == "getGroupBSchedule") {
    return getGroupSchedule(ss, "B", e.parameter.gameName);
  } else if (action == "standings") {
    return getStandings(ss, e.parameter.gameName);
  } else if (action == "getPlayoffSchedule") {
    return getPlayoffSchedule(ss, e.parameter.gameName);
  } else if (action == "saveGroupScore") {
    return saveGroupScore(e, ss);
  } else if (action == "savePlayoffScore") {
    return savePlayoffScore(e, ss);
  } else if (action == "getGameHistory") {
    return getGameHistory(ss);
  } else {
    return ContentService.createTextOutput(JSON.stringify({ error: "Invalid action" }))
                         .setMimeType(ContentService.MimeType.JSON);
  }
}

/**
 * Jauna spēle – izveido jaunu lapu ar unikālu nosaukumu.
 * Ja lietotājs ievada spēles nosaukumu (userGameName), to izmanto, citādi ģenerē "Game_YYYYMMDD_HHMMSS".
 */
function newGame(ss, e) {
  var userGameName = e.parameter.userGameName;
  var gameName = "";
  if(userGameName && userGameName.trim() !== "") {
    gameName = userGameName.trim();
    // Pārliecināmies, ka šāda lapa vēl neeksistē – ja eksistē, pievieno unikālu galotni.
    if(ss.getSheetByName(gameName)) {
      gameName += "_" + (new Date()).getTime();
    }
  } else {
    var now = new Date();
    gameName = "Game_" + Utilities.formatDate(now, ss.getSpreadsheetTimeZone(), "yyyyMMdd_HHmmss");
  }
  var sheet = ss.insertSheet(gameName);
  sheet.clear();
  sheet.getRange(1, 1).setValue("Game: " + gameName);
  return ContentService.createTextOutput(JSON.stringify({ gameName: gameName }))
                       .setMimeType(ContentService.MimeType.JSON);
}

/**
 * Saglabā komandas un ģenerē turnīra struktūru tajā pašā spēles lapā.
 * Parametri: gameName, teams (JSON masīvs).
 */
function saveTeams(e, ss) {
  var gameName = e.parameter.gameName;
  if (!gameName) {
    return ContentService.createTextOutput(JSON.stringify({ error: "No gameName provided" }))
                         .setMimeType(ContentService.MimeType.JSON);
  }
  var teamsParam = e.parameter.teams;
  if (!teamsParam) {
    return ContentService.createTextOutput(JSON.stringify({ error: "No teams provided" }))
                         .setMimeType(ContentService.MimeType.JSON);
  }
  var teams;
  try {
    teams = JSON.parse(teamsParam);
  } catch(err) {
    return ContentService.createTextOutput(JSON.stringify({ error: "Invalid teams format" }))
                         .setMimeType(ContentService.MimeType.JSON);
  }
  
  var sheet = ss.getSheetByName(gameName);
  if (!sheet) {
    return ContentService.createTextOutput(JSON.stringify({ error: "Game sheet not found" }))
                         .setMimeType(ContentService.MimeType.JSON);
  }
  
  var result = generateTournamentForGame(sheet, teams);
  return ContentService.createTextOutput(JSON.stringify({ status: "Teams saved", message: result.message }))
                       .setMimeType(ContentService.MimeType.JSON);
}

/**
 * Ģenerē turnīra struktūru vienā spēles lapā.
 * Sadaļas: Komandu ievade, Group A Schedule, (Group B Schedule, ja nepieciešams), Standings un Playoffs.
 * "Free Team" kolonna ir izņemta.
 */
function generateTournamentForGame(sheet, teams) {
  var r = 1;
  // Spēles virsraksts
  sheet.getRange(r, 1).setValue("Game: " + sheet.getName());
  r++;
  // Komandu ievades sadaļa
  sheet.getRange(r, 1).setValue("Team Input");
  r++;
  sheet.getRange(r, 1).setValue("Team");
  r++;
  for (var i = 0; i < teams.length; i++) {
    sheet.getRange(r + i, 1).setValue(teams[i]);
  }
  r = r + teams.length;
  r++; // tukša rinda
  
  // Noteik grupu sadalījumu
  var groupA, groupB;
  if (teams.length <= 5) {
    groupA = teams;
    groupB = [];
  } else {
    var aCount = Math.ceil(teams.length / 2);
    groupA = teams.slice(0, aCount);
    groupB = teams.slice(aCount);
  }
  
  // Group A Schedule (5 kolonnas)
  sheet.getRange(r, 1).setValue("Group A Schedule");
  r++;
  sheet.getRange(r, 1, 1, 5).setValues([["Match #", "Team A", "Team B", "Score A", "Score B"]]);
  r++;
  var matchNum = 1;
  for (var i = 0; i < groupA.length - 1; i++) {
    for (var j = i + 1; j < groupA.length; j++) {
      sheet.getRange(r, 1, 1, 5).setValues([[matchNum, groupA[i], groupA[j], "", ""]]);
      r++;
      matchNum++;
    }
  }
  
  // Group B Schedule (ja ir)
  if (groupB.length > 0) {
    r++;
    sheet.getRange(r, 1).setValue("Group B Schedule");
    r++;
    sheet.getRange(r, 1, 1, 5).setValues([["Match #", "Team A", "Team B", "Score A", "Score B"]]);
    r++;
    matchNum = 1;
    for (var i = 0; i < groupB.length - 1; i++) {
      for (var j = i + 1; j < groupB.length; j++) {
        sheet.getRange(r, 1, 1, 5).setValues([[matchNum, groupB[i], groupB[j], "", ""]]);
        r++;
        matchNum++;
      }
    }
  }
  
  // Standings sadaļa
  r++;
  sheet.getRange(r, 1).setValue("Standings");
  r++;
  sheet.getRange(r, 1).setValue("Team");
  r++;
  for (var i = 0; i < teams.length; i++) {
    sheet.getRange(r + i, 1).setValue(teams[i]);
  }
  r = r + teams.length;
  
  // Playoffs sadaļa
  r++;
  sheet.getRange(r, 1).setValue("Playoffs");
  r++;
  sheet.getRange(r, 1, 1, 5).setValues([["Match ID", "Team1", "Team2", "Score1", "Score2"]]);
  r++;
  var playoffTeams = teams.slice(0, Math.min(8, teams.length));
  for (var j = 0; j < playoffTeams.length; j += 2) {
    var matchId = "P" + ((j/2) + 1);
    var team1 = playoffTeams[j];
    var team2 = playoffTeams[j+1] || "";
    sheet.getRange(r, 1, 1, 5).setValues([[matchId, team1, team2, "", ""]]);
    r++;
  }
  
  return { message: "Tournament generated on sheet " + sheet.getName() };
}

/**
 * Palīgfunkcija – izgūst datus no sadaļas, meklējot pēc sadaļas virsraksta.
 */
function getSectionData(sheet, headerText) {
  var data = sheet.getDataRange().getValues();
  var startRow = null;
  for (var i = 0; i < data.length; i++) {
    if (data[i][0] === headerText) {
      startRow = i;
      break;
    }
  }
  if (startRow === null) {
    return { header: [], rows: [] };
  }
  var header = data[startRow + 1];
  var table = [];
  for (var i = startRow + 2; i < data.length; i++) {
    if (!data[i][0]) break;
    table.push(data[i].slice(0, header.length));
  }
  return { header: header, rows: table };
}

/**
 * Izgūst grupas grafiku datus.
 */
function getGroupSchedule(ss, group, gameName) {
  if (!gameName) return ContentService.createTextOutput(JSON.stringify({ error: "No gameName provided" }))
                         .setMimeType(ContentService.MimeType.JSON);
  var sheet = ss.getSheetByName(gameName);
  if (!sheet) {
    return ContentService.createTextOutput(JSON.stringify({ error: "Game sheet not found" }))
                         .setMimeType(ContentService.MimeType.JSON);
  }
  var headerText = (group === "A") ? "Group A Schedule" : "Group B Schedule";
  var result = getSectionData(sheet, headerText);
  return ContentService.createTextOutput(JSON.stringify(result))
                       .setMimeType(ContentService.MimeType.JSON);
}

/**
 * Izgūst Standings datus.
 */
function getStandings(ss, gameName) {
  if (!gameName) return ContentService.createTextOutput(JSON.stringify({ error: "No gameName provided" }))
                         .setMimeType(ContentService.MimeType.JSON);
  var sheet = ss.getSheetByName(gameName);
  if (!sheet) {
    return ContentService.createTextOutput(JSON.stringify({ error: "Game sheet not found" }))
                         .setMimeType(ContentService.MimeType.JSON);
  }
  var result = getSectionData(sheet, "Standings");
  return ContentService.createTextOutput(JSON.stringify(result))
                       .setMimeType(ContentService.MimeType.JSON);
}

/**
 * Izgūst Playoffs datus.
 */
function getPlayoffSchedule(ss, gameName) {
  if (!gameName) return ContentService.createTextOutput(JSON.stringify({ error: "No gameName provided" }))
                         .setMimeType(ContentService.MimeType.JSON);
  var sheet = ss.getSheetByName(gameName);
  if (!sheet) {
    return ContentService.createTextOutput(JSON.stringify({ error: "Game sheet not found" }))
                         .setMimeType(ContentService.MimeType.JSON);
  }
  var result = getSectionData(sheet, "Playoffs");
  return ContentService.createTextOutput(JSON.stringify(result))
                       .setMimeType(ContentService.MimeType.JSON);
}

/**
 * Saglabā grupas spēles punktus.
 */
function saveGroupScore(e, ss) {
  var gameName = e.parameter.gameName;
  var group = e.parameter.group;
  var matchNumber = parseInt(e.parameter.matchNumber);
  var scoreA = e.parameter.scoreA;
  var scoreB = e.parameter.scoreB;
  if (!gameName || !group || !matchNumber || scoreA === undefined || scoreB === undefined) {
    return ContentService.createTextOutput(JSON.stringify({ error: "Missing parameters" }))
                         .setMimeType(ContentService.MimeType.JSON);
  }
  var sheet = ss.getSheetByName(gameName);
  if (!sheet) {
    return ContentService.createTextOutput(JSON.stringify({ error: "Game sheet not found" }))
                         .setMimeType(ContentService.MimeType.JSON);
  }
  var headerText = (group === "A") ? "Group A Schedule" : "Group B Schedule";
  var data = sheet.getDataRange().getValues();
  var startRow = null;
  for (var i = 0; i < data.length; i++) {
    if (data[i][0] === headerText) {
      startRow = i;
      break;
    }
  }
  if (startRow === null) {
    return ContentService.createTextOutput(JSON.stringify({ error: "Group schedule not found" }))
                         .setMimeType(ContentService.MimeType.JSON);
  }
  var rowFound = null;
  var headerRow = data[startRow + 1];
  for (var i = startRow + 2; i < data.length; i++) {
    if (data[i][0] === matchNumber) {
      rowFound = i + 1;
      break;
    }
  }
  if (!rowFound) {
    return ContentService.createTextOutput(JSON.stringify({ error: "Match not found" }))
                         .setMimeType(ContentService.MimeType.JSON);
  }
  var currentScoreA = sheet.getRange(rowFound, 4).getValue();
  var currentScoreB = sheet.getRange(rowFound, 5).getValue();
  if (currentScoreA !== "" || currentScoreB !== "") {
    return ContentService.createTextOutput(JSON.stringify({ error: "Score already saved" }))
                         .setMimeType(ContentService.MimeType.JSON);
  }
  sheet.getRange(rowFound, 4).setValue(scoreA);
  sheet.getRange(rowFound, 5).setValue(scoreB);
  return ContentService.createTextOutput(JSON.stringify({ status: "Score saved" }))
                       .setMimeType(ContentService.MimeType.JSON);
}

/**
 * Saglabā Playoffs spēles punktus.
 */
function savePlayoffScore(e, ss) {
  var gameName = e.parameter.gameName;
  var matchId = e.parameter.matchId;
  var score1 = e.parameter.score1;
  var score2 = e.parameter.score2;
  if (!gameName || !matchId || score1 === undefined || score2 === undefined) {
    return ContentService.createTextOutput(JSON.stringify({ error: "Missing parameters" }))
                         .setMimeType(ContentService.MimeType.JSON);
  }
  var sheet = ss.getSheetByName(gameName);
  if (!sheet) {
    return ContentService.createTextOutput(JSON.stringify({ error: "Game sheet not found" }))
                         .setMimeType(ContentService.MimeType.JSON);
  }
  var data = sheet.getDataRange().getValues();
  var startRow = null;
  for (var i = 0; i < data.length; i++) {
    if (data[i][0] === "Playoffs") {
      startRow = i;
      break;
    }
  }
  if (startRow === null) {
    return ContentService.createTextOutput(JSON.stringify({ error: "Playoffs section not found" }))
                         .setMimeType(ContentService.MimeType.JSON);
  }
  var rowFound = null;
  for (var i = startRow + 2; i < data.length; i++) {
    if (data[i][0] === matchId) {
      rowFound = i + 1;
      break;
    }
  }
  if (!rowFound) {
    return ContentService.createTextOutput(JSON.stringify({ error: "Match not found" }))
                         .setMimeType(ContentService.MimeType.JSON);
  }
  var currentScore1 = sheet.getRange(rowFound, 4).getValue();
  var currentScore2 = sheet.getRange(rowFound, 5).getValue();
  if (currentScore1 !== "" || currentScore2 !== "") {
    return ContentService.createTextOutput(JSON.stringify({ error: "Score already saved" }))
                         .setMimeType(ContentService.MimeType.JSON);
  }
  sheet.getRange(rowFound, 4).setValue(score1);
  sheet.getRange(rowFound, 5).setValue(score2);
  // Aprēķina uzvarētāju
  var team1 = sheet.getRange(rowFound, 2).getValue();
  var team2 = sheet.getRange(rowFound, 3).getValue();
  var winner = (parseFloat(score1) > parseFloat(score2)) ? team1 : (parseFloat(score2) > parseFloat(score1) ? team2 : "Draw");
  sheet.getRange(rowFound, 6).setValue(winner);
  return ContentService.createTextOutput(JSON.stringify({ status: "Score saved" }))
                       .setMimeType(ContentService.MimeType.JSON);
}

/**
 * Izgūst spēļu vēsturi – atgriež visu lapu nosaukumus, kas sākas ar "Game_".
 */
function getGameHistory(ss) {
  var sheets = ss.getSheets();
  var games = [];
  for(var i = 0; i < sheets.length; i++){
    var name = sheets[i].getName();
    if(name.indexOf("Game_") === 0 || name.indexOf("Rīga") === 0) { // Ja lietotājs ir ievadījis arī pielāgotu nosaukumu
      games.push(name);
    }
  }
  games.sort();
  games.reverse();
  return ContentService.createTextOutput(JSON.stringify({ games: games }))
                       .setMimeType(ContentService.MimeType.JSON);
}
