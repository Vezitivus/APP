<!doctype html>
<html lang="lv">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Turnƒ´ru AplikƒÅcija ‚Äî Pro Liquid UI</title>
<meta name="color-scheme" content="light dark" />
<style>
  /* ===== Pro Liquid + Glass Theme ===== */
  :root{
    --bg:#0b0f14; --text:#e6e9ef; --muted:#9aa4b2;
    --card:rgba(18,24,38,.55); --border:rgba(255,255,255,.08); --ring:#6f7dd62b;
    --accent:#7c5cff; --accent2:#45a2ff; --gold:#f4c542; --ok:#19c37d; --bad:#ff5c7a;
    --radius:16px; --shadow:0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.05);
    --font:ui-sans-serif,-apple-system,"SF Pro Text","Inter","Segoe UI",Roboto,Arial; --space:clamp(10px,2vw,18px);
    --std-w-num: clamp(30px, 7vw, 56px);
  }
  @media (prefers-color-scheme:light){
    :root{ --bg:#f7f8fc; --text:#0f172a; --muted:#4b5568; --card:rgba(255,255,255,.82); --border:rgba(15,23,42,.08);
           --ring:#7c8dd41c; --shadow:0 12px 30px rgba(18,20,40,.08), inset 0 1px 0 rgba(255,255,255,.55)}
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;color:var(--text);font-family:var(--font);background:var(--bg);
    background:
      radial-gradient(1200px 800px at 120% -10%, color-mix(in oklab, var(--accent) 35%, transparent), transparent 60%),
      radial-gradient(900px 600px at -30% 20%, color-mix(in oklab, var(--accent2) 35%, transparent), transparent 60%),
      radial-gradient(600px 500px at 80% 110%, color-mix(in oklab, #19c37d 35%, transparent), transparent 60%);
  }

  /* ===== Header ===== */
  header{
    position:sticky;top:0;z-index:20;backdrop-filter:saturate(140%) blur(12px);
    background:linear-gradient(180deg, rgba(0,0,0,.0), rgba(0,0,0,.05)), var(--card);
    border-bottom:1px solid var(--border);
  }
  .bar{max-width:1200px;margin:0 auto;padding:12px clamp(14px,3vw,24px);display:flex;gap:12px;align-items:center;justify-content:space-between}
  .brand{display:flex;gap:12px;align-items:center;font-weight:900;letter-spacing:.2px}
  .dot{width:14px;height:14px;border-radius:50%;
       background:radial-gradient(12px 12px at 20% 20%, #fff8, #0000), linear-gradient(135deg,var(--accent),var(--accent2))}
  .wrap{max-width:1200px;margin:clamp(10px,2vw,20px) auto clamp(60px,7vw,96px); padding:0 clamp(14px,3vw,24px);display:grid;gap:var(--space)}

  /* notice (inline, not popup) */
  .notice{
    max-width:1200px;
    margin:0 auto 10px;
    padding:0 clamp(14px,3vw,24px);
  }
  .notice > div{
    display:flex; align-items:center; justify-content:space-between; gap:12px;
    padding:10px 12px;
    border-radius:14px;
    border:1px solid var(--border);
    background:color-mix(in oklab, var(--card) 92%, rgba(0,0,0,.18));
    box-shadow:0 20px 60px rgba(0,0,0,.35);
  }
  .notice b{font-weight:900}
  .notice button{
    border:1px solid var(--border); background:transparent; color:var(--text);
    border-radius:999px; padding:6px 10px; cursor:pointer;
  }

  /* ===== Panels & buttons ===== */
  .panel{
    background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);
    padding:clamp(12px,2.6vw,20px); transition:transform .12s ease, box-shadow .25s ease;
  }
  .panel:hover{ transform:translateY(-1px) }
  h2{margin:0 0 8px;font-size:clamp(18px,2.6vw,22px)}
  h3{margin:0 0 8px;font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.12em}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .muted{color:var(--muted);font-size:13px}
  .tnum{font-variant-numeric:tabular-nums}

  input,textarea,select{
    width:100%;background:rgba(255,255,255,.02);color:var(--text);border:1px solid var(--border);border-radius:12px;padding:12px 12px;
    transition:border .2s ease, box-shadow .2s ease, background-color .2s ease, transform .08s ease;
    -webkit-tap-highlight-color: transparent;
  }
  textarea{min-height:160px;resize:vertical}
  input:focus,textarea:focus,select:focus{outline:none;border-color:color-mix(in oklab, var(--accent) 45%, var(--border));box-shadow:0 0 0 6px var(--ring)}
  .btn{
    appearance:none;border:1px solid var(--border);
    background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(0,0,0,.08));
    color:var(--text);border-radius:999px;padding:11px 16px;cursor:pointer;
    -webkit-tap-highlight-color:transparent; touch-action:manipulation; user-select:none; -webkit-user-select:none;
  }
  .btn--accent{border:none;background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff}
  .btn--gold{border:none;background:linear-gradient(135deg,var(--gold),#ffd569);color:#1a1a1a}
  .btn:active{transform:translateY(1px)}

  .score-in{
    width:clamp(44px, 11vw, 62px);
    text-align:center;
    padding:8px 6px;
    border-radius:10px;
    border:1px solid var(--border);
    background:rgba(255,255,255,.03);
    color:var(--text);
  }

  /* ===== Standings (no horizontal scroll) ===== */
  .standings-table{table-layout:fixed;width:100%;border-collapse:separate;border-spacing:0 8px}
  .standings-table th,.standings-table td{padding:8px 10px}
  .standings-table thead th{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.12em}
  .standings-table tbody tr{background:linear-gradient(180deg,transparent, color-mix(in oklab, var(--card) 88%, transparent))}
  .name-nowrap{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;display:inline-block}
  @media (max-width:520px){ .standings-table th,.standings-table td{font-size:12px;padding:6px 6px} }

  #standingsHost{ display:grid; grid-template-columns:1fr; gap:var(--space); align-items:start; }
  #standingsHost > .panel{ min-width:0 }
  .standings-table td:nth-child(2) .name-nowrap{display:block;min-width:0;max-width:100%}
  .standings-table th,.standings-table td{overflow:hidden}

  /* ===== Bracket ===== */
  .bracket{display:grid;gap:var(--space);grid-template-columns:repeat(3, minmax(260px,1fr))}
  .round{display:grid;gap:var(--space)}
  .match{border:1px solid var(--border);border-radius:14px;padding:12px;background:color-mix(in oklab, var(--card) 94%, transparent)}
  .team{display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:center;padding:8px;border-radius:10px}
  .team.win{outline:2px solid color-mix(in oklab, var(--ok) 45%, transparent);outline-offset:-2px}
  .status{font-size:12px;color:var(--muted);margin-bottom:6px}

  /* compact checkbox */
  .chk{appearance:none;width:16px;height:16px;border:1px solid var(--border);border-radius:4px;background:rgba(255,255,255,.02);display:inline-block;position:relative;vertical-align:middle}
  .chk:checked{background:linear-gradient(135deg,var(--accent),var(--accent2));border-color:transparent}
  .chk:checked::after{content:'‚úì';position:absolute;inset:0;font-size:12px;color:#fff;display:flex;align-items:center;justify-content:center}

  /* ===== Groups layout ===== */
  .group-grid{display:grid; gap:var(--space); grid-template-columns:repeat(auto-fit,minmax(340px,1fr))}
  .group-head{
    display:flex; align-items:flex-start; justify-content:space-between; gap:10px; flex-wrap:wrap;
    margin-bottom:10px;
  }
  .group-title{display:flex; align-items:baseline; gap:10px}
  .gid{
    display:inline-flex; align-items:center; justify-content:center;
    width:36px; height:36px; border-radius:12px;
    background:radial-gradient(14px 14px at 20% 20%, rgba(255,255,255,.35), transparent 55%),
               linear-gradient(135deg,var(--accent),var(--accent2));
    color:#fff; font-weight:1000;
    box-shadow:0 14px 32px rgba(0,0,0,.35);
  }

  /* ===== Match row like screenshot ===== */
  .match-pill{
    position:relative;
    border-radius:999px;
    padding:14px 14px 12px;
    border:1px solid rgba(255,255,255,.06);
    background:
      radial-gradient(220px 120px at 18% 40%, rgba(255,255,255,.06), transparent 60%),
      linear-gradient(180deg, rgba(255,255,255,.03), rgba(0,0,0,.22));
    box-shadow:0 30px 90px rgba(0,0,0,.55), inset 0 1px 0 rgba(255,255,255,.05);
    cursor:pointer;
    touch-action:manipulation;
    -webkit-tap-highlight-color:transparent;
    transition:transform .12s ease, border-color .2s ease;
  }
  .match-pill:hover{ transform:translateY(-1px); border-color:color-mix(in oklab, var(--accent) 18%, rgba(255,255,255,.06)); }
  .match-pill:active{ transform:translateY(1px); }

  .mp-labels{
    display:flex; justify-content:space-between; align-items:center;
    padding:0 10px 10px 86px; /* leave space for R badge */
    font-size:12px;
    color:color-mix(in oklab, var(--text) 65%, var(--muted));
    font-weight:900;
    opacity:.9;
  }
  .mp-main{display:flex; align-items:center; gap:16px}

  .rbadge{
    width:72px; height:56px;
    border-radius:18px;
    display:grid; place-items:center;
    font-weight:1000;
    letter-spacing:.08em;
    border:1px solid rgba(255,255,255,.07);
    background:
      radial-gradient(40px 24px at 35% 30%, rgba(255,255,255,.08), transparent 60%),
      linear-gradient(180deg, rgba(255,255,255,.03), rgba(0,0,0,.25));
    box-shadow: inset 0 1px 0 rgba(255,255,255,.05);
  }

  .team-chip{
    flex:1; min-width:0;
    display:flex; align-items:center; gap:12px;
    height:56px;
    padding:10px 14px;
    border-radius:18px;
    border:1px solid rgba(255,255,255,.06);
    background:
      radial-gradient(140px 70px at 10% 30%, rgba(255,255,255,.06), transparent 60%),
      linear-gradient(180deg, rgba(255,255,255,.02), rgba(0,0,0,.20));
  }
  .team-chip.away{ justify-content:flex-end; }
  .team-name{
    min-width:0;
    overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
    font-weight:1000;
    font-size:clamp(16px, 2.4vw, 22px);
    letter-spacing:.02em;
  }

  .avatar{
    width:36px;height:36px;border-radius:12px;
    flex:0 0 auto;
    overflow:hidden;
    border:1px solid rgba(255,255,255,.10);
    background:
      radial-gradient(14px 14px at 30% 30%, rgba(255,255,255,.30), transparent 55%),
      linear-gradient(135deg, rgba(124,92,255,.95), rgba(69,162,255,.85));
    box-shadow:0 12px 30px rgba(0,0,0,.35);
    display:grid; place-items:center;
    font-weight:1000;
    color:#fff;
    font-size:12px;
    letter-spacing:.06em;
  }
  .avatar img{width:100%;height:100%;object-fit:cover;display:block}
  .avatar.alt{
    background:
      radial-gradient(14px 14px at 30% 30%, rgba(255,255,255,.30), transparent 55%),
      linear-gradient(135deg, rgba(99,102,241,.95), rgba(168,85,247,.80));
  }

  .score-chip{
    position:relative;
    width:180px; height:56px;
    border-radius:999px;
    display:grid; place-items:center;
    font-weight:1000;
    font-size:clamp(18px, 3vw, 28px);
    letter-spacing:.04em;
    color:#fff;
    border:1px solid color-mix(in oklab, var(--ok) 35%, rgba(255,255,255,.06));
    background:
      radial-gradient(140px 80px at 25% 25%, rgba(255,255,255,.15), transparent 60%),
      linear-gradient(135deg, color-mix(in oklab, var(--ok) 35%, rgba(0,0,0,.20)), rgba(0,0,0,.30));
    box-shadow:0 18px 50px rgba(0,0,0,.55), inset 0 1px 0 rgba(255,255,255,.08);
  }
  .score-chip.done{
    border-color:color-mix(in oklab, var(--ok) 55%, rgba(255,255,255,.06));
  }
  .ot-badge{
    position:absolute;
    right:10px; top:50%;
    transform:translateY(-50%);
    padding:6px 10px;
    border-radius:999px;
    font-size:12px;
    font-weight:1000;
    letter-spacing:.06em;
    color:color-mix(in oklab, var(--gold) 90%, #fff);
    border:1px solid rgba(255,255,255,.10);
    background:rgba(0,0,0,.18);
    opacity:0;
  }
  .ot-badge.on{ opacity:1; }

  .match-pill.disabled{
    opacity:.45;
    cursor:default;
  }

  @media (max-width:720px){
    .mp-labels{ padding-left:86px; }
    .score-chip{ width:148px; }
  }
  @media (max-width:560px){
    .mp-labels{ padding-left:82px; }
    .rbadge{ width:68px; }
    .score-chip{ width:132px; }
    .team-name{ font-size:18px; }
  }

  /* ===== Match modal (clean, no hints) ===== */
  .mm-backdrop{
    position:fixed; inset:0;
    background:rgba(0,0,0,.62);
    backdrop-filter: blur(10px);
    opacity:0; visibility:hidden; pointer-events:none;
    transition:opacity .22s cubic-bezier(.2,.8,.2,1);
    z-index:95;
  }
  .mm-backdrop.open{ opacity:1; visibility:visible; pointer-events:auto; }

  .mm{
    position:fixed; left:50%; top:50%;
    transform:translate(-50%,-50%) scale(.985);
    width:min(520px, calc(100% - 24px));
    border-radius:22px;
    background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(0,0,0,.18)), var(--card);
    border:1px solid var(--border);
    box-shadow:0 40px 120px rgba(0,0,0,.62), inset 0 1px 0 rgba(255,255,255,.06);
    backdrop-filter: blur(14px) saturate(150%);
    opacity:0; visibility:hidden; pointer-events:none;
    transition: transform .24s cubic-bezier(.2,.8,.2,1), opacity .24s cubic-bezier(.2,.8,.2,1);
    z-index:110;
    overflow:hidden;
  }
  .mm.open{ opacity:1; visibility:visible; pointer-events:auto; transform:translate(-50%,-50%) scale(1); }

  .mm-head{
    display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
    padding:14px 16px; border-bottom:1px solid var(--border);
    background:color-mix(in oklab, var(--card) 96%, transparent)
  }
  .mm-title{ font-weight:1000; letter-spacing:.02em; font-size:16px; }
  .mm-sub{ margin-top:6px; font-size:12px; color:var(--muted); line-height:1.25; }

  .mm-body{ padding:14px 16px 16px; display:grid; gap:12px; }

  .mm-scorebox{
    border:1px solid var(--border);
    border-radius:18px;
    background:rgba(255,255,255,.03);
    padding:12px;
    display:grid; gap:10px;
  }
  .mm-row{
    display:grid;
    grid-template-columns:1fr min-content 1fr;
    gap:10px;
    align-items:stretch;
  }
  .mm-side{
    border:1px solid var(--border);
    background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(0,0,0,.10));
    border-radius:16px;
    padding:12px;
    cursor:pointer;
    touch-action:manipulation;
    user-select:none; -webkit-user-select:none;
    display:grid; gap:8px;
    box-shadow:0 10px 24px rgba(0,0,0,.22), inset 0 1px 0 rgba(255,255,255,.04);
  }
  .mm-side.active{
    border-color:color-mix(in oklab, var(--accent) 45%, var(--border));
    box-shadow:0 0 0 6px var(--ring), 0 12px 30px rgba(0,0,0,.32), inset 0 1px 0 rgba(255,255,255,.04);
  }
  .mm-team{ font-weight:900; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
  .mm-val{
    text-align:center;
    font-size:clamp(44px, 10vw, 62px);
    font-weight:1000;
    letter-spacing:.02em;
    line-height:1;
    background:linear-gradient(135deg, var(--accent), var(--accent2));
    -webkit-background-clip:text; background-clip:text;
    color:transparent;
    text-shadow:0 18px 44px rgba(0,0,0,.35);
  }
  .mm-mid{
    display:grid; place-items:center;
    font-weight:1000;
    opacity:.6;
    font-size:22px;
  }

  .mm-meta{
    display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
  }
  .mm-toggle{
    display:inline-flex; align-items:center; gap:10px;
    padding:10px 12px;
    border:1px solid var(--border);
    border-radius:999px;
    background:rgba(255,255,255,.02);
    user-select:none; -webkit-user-select:none;
  }
  .switch{
    position:relative; width:44px; height:26px; border-radius:999px;
    border:1px solid var(--border); background:rgba(255,255,255,.04);
    flex:0 0 auto;
  }
  .switch::after{
    content:"";
    position:absolute; top:3px; left:3px;
    width:20px; height:20px; border-radius:50%;
    background:rgba(255,255,255,.85);
    transition:transform .18s cubic-bezier(.2,.8,.2,1);
    box-shadow:0 10px 18px rgba(0,0,0,.25);
  }
  .mm-toggle input{ display:none; }
  .mm-toggle input:checked + .switch{
    border-color:transparent;
    background:linear-gradient(135deg, var(--accent), var(--accent2));
  }
  .mm-toggle input:checked + .switch::after{ transform:translateX(18px); }
  .mm-toggle b{ font-weight:1000 }

  .mm-err{
    width:100%;
    padding:10px 12px;
    border-radius:14px;
    border:1px solid color-mix(in oklab, var(--bad) 30%, var(--border));
    background:color-mix(in oklab, var(--bad) 12%, rgba(0,0,0,.10));
    color:color-mix(in oklab, var(--text) 92%, var(--bad));
    font-weight:900;
    display:none;
  }
  .mm-err.show{ display:block; }

  .mm-pad{
    display:grid;
    grid-template-columns:repeat(3, 1fr);
    gap:10px;
  }
  .pad-btn{
    appearance:none;
    border:1px solid var(--border);
    background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.12));
    color:var(--text);
    border-radius:16px;
    padding:14px 12px;
    font-size:18px;
    font-weight:1000;
    cursor:pointer;
    touch-action:manipulation;
    -webkit-tap-highlight-color:transparent;
    user-select:none;
    box-shadow:0 12px 28px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.06);
  }
  .pad-btn:active{ transform:translateY(1px); }
  .pad-btn--sub{ font-size:14px; font-weight:900; color:color-mix(in oklab, var(--text) 80%, var(--muted)); }
  .mm-actions{ display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap; }
  .mm-actions .btn{ flex:1; min-width:140px; }
  .mm-actions .btn--accent{ flex:1.25; }
</style>
</head>
<body>
<header>
  <div class="bar">
    <div class="brand">
      <span class="dot"></span>
      <span id="brandTitle">Turnƒ´ru AplikƒÅcija</span>
    </div>
    <div class="row">
      <button type="button" class="btn" id="exportBtn">Eksportƒìt</button>
      <button type="button" class="btn" id="importBtn">Importƒìt</button>
      <button type="button" class="btn" id="resetBtn">Notƒ´rƒ´t</button>
      <button type="button" class="btn" id="soundBtn"><span id="soundIcon">üîä</span></button>
    </div>
  </div>
  <div class="notice" id="notice" hidden>
    <div>
      <span id="noticeText"><b>Info:</b> ‚Ä¶</span>
      <button type="button" id="noticeClose">OK</button>
    </div>
  </div>
</header>

<main class="wrap">
  <!-- SETUP -->
  <section class="panel" id="setupPanel">
    <div class="row" style="justify-content:space-between">
      <h2>1) Komandas</h2>
    </div>

    <div class="row" style="gap:var(--space); align-items:flex-start">
      <div style="flex:2; min-width:260px">
        <input id="tName" placeholder="Turnƒ´ra nosaukums (neobligƒÅts)"/>
        <div style="height:10px"></div>
        <textarea id="teamsInput" placeholder="Katru komandu jaunƒÅ rindƒÅ..."></textarea>
      </div>
      <div style="flex:1; min-width:240px">
        <label class="muted" for="groupStrategy">Grupu skaits</label>
        <select id="groupStrategy">
          <option value="auto" selected>AutomƒÅtiski (2/4/6; ‚â§6 ‚Üí 1 grupa)</option>
          <option value="n1">1 grupa (tikai ja ‚â§6 kom.)</option>
          <option value="n2">2 grupas</option>
          <option value="n4">4 grupas</option>
          <option value="n6">6 grupas</option>
        </select>
        <div style="height:10px"></div>
        <button type="button" class="btn btn--accent" id="genGroups" style="width:100%">ƒ¢enerƒìt grupas</button>
      </div>
    </div>
  </section>

  <!-- GROUPS -->
  <section class="panel" id="groupsPanel" hidden>
    <div class="row" style="justify-content:space-between; align-items:baseline">
      <h2>2) Grupas</h2>
    </div>
    <div id="groupsHost" class="group-grid"></div>
  </section>

  <!-- STANDINGS -->
  <section class="panel" id="standingsPanel" hidden>
    <h2>3) StƒÅvƒìjums</h2>
    <div id="standingsHost" class="grid"></div>
  </section>

  <!-- PLAYOFF -->
  <section class="panel" id="playoffPanel" hidden>
    <div class="row" style="justify-content:space-between;align-items:center">
      <h2>4) Playoff</h2>
      <button type="button" class="btn" id="buildBracket">ƒ¢enerƒìt Bracket</button>
    </div>

    <div class="bracket" style="margin-top:var(--space)">
      <div class="round" id="qfCol"><h3>CeturtdaƒºfinƒÅli</h3></div>
      <div class="round" id="sfCol"><h3>PusfinƒÅli</h3></div>
      <div class="round" id="finCol"><h3>FinƒÅls & 3. vieta</h3></div>
    </div>

    <div class="row" style="margin-top:12px">
      <button type="button" class="btn btn--gold" id="overallBtn" disabled>Kopsavilkums</button>
      <button type="button" class="btn" id="downloadPdfBtn" disabled>LejupielƒÅdƒìt PDF</button>
    </div>

    <div id="statsPanel" class="grid" hidden style="margin-top:var(--space)">
      <h2>5) Kopsavilkums</h2>
      <div id="awards" class="awards"></div>
      <div class="panel" id="teamStatsPanel">
        <h3>Komandu kopstatistika</h3>
        <div id="teamStatsHost"></div>
      </div>
    </div>
  </section>
</main>

<!-- Match modal -->
<div id="mmBackdrop" class="mm-backdrop"></div>
<div id="mm" class="mm" role="dialog" aria-modal="true" aria-labelledby="mmTitle" aria-hidden="true">
  <div class="mm-head">
    <div>
      <div class="mm-title" id="mmTitle">Ievadi rezultƒÅtu</div>
      <div class="mm-sub" id="mmSub">‚Äî</div>
    </div>
    <button type="button" class="btn" id="mmCloseBtn" aria-label="Aizvƒìrt">‚úï</button>
  </div>

  <div class="mm-body">
    <div class="mm-scorebox">
      <div class="mm-row">
        <div class="mm-side active" id="mmHomeBtn" role="button" tabindex="0">
          <div class="mm-team" id="mmHomeName">‚Äî</div>
          <div class="mm-val tnum" id="mmHomeVal">‚Äî</div>
        </div>
        <div class="mm-mid">:</div>
        <div class="mm-side" id="mmAwayBtn" role="button" tabindex="0">
          <div class="mm-team" id="mmAwayName">‚Äî</div>
          <div class="mm-val tnum" id="mmAwayVal">‚Äî</div>
        </div>
      </div>

      <div class="mm-meta">
        <label class="mm-toggle">
          <input type="checkbox" id="mmOt" />
          <span class="switch" aria-hidden="true"></span>
          <span>OT</span>
          <b class="tnum" id="mmOtHint"></b>
        </label>
      </div>

      <div class="mm-err" id="mmErr"></div>
    </div>

    <div class="mm-pad" id="mmPad">
      <button type="button" class="pad-btn" data-k="1">1</button>
      <button type="button" class="pad-btn" data-k="2">2</button>
      <button type="button" class="pad-btn" data-k="3">3</button>
      <button type="button" class="pad-btn" data-k="4">4</button>
      <button type="button" class="pad-btn" data-k="5">5</button>
      <button type="button" class="pad-btn" data-k="6">6</button>
      <button type="button" class="pad-btn" data-k="7">7</button>
      <button type="button" class="pad-btn" data-k="8">8</button>
      <button type="button" class="pad-btn" data-k="9">9</button>
      <button type="button" class="pad-btn pad-btn--sub" data-k="clr">Clear</button>
      <button type="button" class="pad-btn" data-k="0">0</button>
      <button type="button" class="pad-btn pad-btn--sub" data-k="bs">‚å´</button>
    </div>

    <div class="mm-actions">
      <button type="button" class="btn" id="mmResetMatchBtn">Notƒ´rƒ´t spƒìli</button>
      <button type="button" class="btn btn--accent" id="mmSaveBtn">SaglabƒÅt</button>
    </div>
  </div>
</div>

<!-- PDF libs -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js" crossorigin="anonymous"></script>

<script>
/* ===== Util ===== */
const $=(s,r=document)=>r.querySelector(s), $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
const uid=()=>Math.random().toString(36).slice(2,9);
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a}
const todayStamp = ()=> new Date().toISOString().slice(0,10);
const slugify = s => (s||'').toLowerCase().normalize('NFKD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'').slice(0,80)||'tournament';

/* ===== Inline notice (no alert popups) ===== */
function notice(msg){
  const wrap=$('#notice');
  const txt=$('#noticeText');
  if(!wrap||!txt) return;
  txt.innerHTML = `<b>Info:</b> ${String(msg).replace(/</g,'&lt;')}`;
  wrap.hidden=false;
  clearTimeout(notice._t);
  notice._t=setTimeout(()=>{wrap.hidden=true}, 3200);
}
$('#noticeClose').addEventListener('click', ()=>$('#notice').hidden=true);

/* ===== Storage ===== */
const STORAGE_KEY='tournament_state_pro_v12';
function saveState(s){ localStorage.setItem(STORAGE_KEY, JSON.stringify(s)); }
function loadState(){ try{return JSON.parse(localStorage.getItem(STORAGE_KEY)||'null')}catch{return null} }
function clearState(){ localStorage.removeItem(STORAGE_KEY); }
const SOUND_PREF_KEY='tournament_sound_on';

/* ===== Sounds ===== */
let audioCtx=null; let soundOn=(localStorage.getItem(SOUND_PREF_KEY)!=='0');
const ensureCtx=()=>{ if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)() };
function beep({freq=440,type='sine',dur=0.08,gain=0.05,a=0.005,r=0.06}={}){ if(!soundOn) return; ensureCtx();
  const now=audioCtx.currentTime, o=audioCtx.createOscillator(), g=audioCtx.createGain();
  o.type=type; o.frequency.setValueAtTime(freq,now); g.gain.setValueAtTime(0,now);
  g.gain.linearRampToValueAtTime(gain,now+a); g.gain.exponentialRampToValueAtTime(0.0001,now+a+dur+r);
  o.connect(g); g.connect(audioCtx.destination); o.start(now); o.stop(now+a+dur+r+0.02);
}
const sfx={ click:()=>beep({freq:280,type:'triangle',dur:0.05,gain:0.06}),
            score:()=>{beep({freq:420,type:'square',dur:0.06,gain:0.06}); setTimeout(()=>beep({freq:590,type:'square',dur:0.06,gain:0.05}),70)},
            success:()=>{beep({freq:450,type:'sine',dur:0.07,gain:0.06}); setTimeout(()=>beep({freq:650,type:'sine',dur:0.09,gain:0.05}),90)} };
$('#soundBtn').addEventListener('click',()=>{ soundOn=!soundOn; localStorage.setItem(SOUND_PREF_KEY,soundOn?'1':'0'); $('#soundIcon').textContent=soundOn?'üîä':'üîá'; sfx.click(); });

/* ===== State ===== */
let state={ name:'', teams:[], groups:[], standings:{}, bracket:null, overall:null };

/* ===== Grouping / fixtures ===== */
function deriveGroupCount(n,str){
  const allowed=[2,4,6];
  if(str==='n1') return (n<=6)?1:deriveGroupCount(n,'auto');
  if(str==='auto' && n<=6) return 1;
  if(str?.startsWith('n')){
    const req=+str.slice(1);
    if(req===1 && n<=6) return 1;
    if(allowed.includes(req)) return Math.min(req,n);
  }
  if(n<=6) return 1;
  const target=Math.round(n/4); let best=2;
  for(const k of allowed){
    if(k>n) continue;
    const dK=Math.abs(k-target), dB=Math.abs(best-target);
    if(dK<dB||(dK===dB&&k>best)) best=k;
  }
  return best;
}
function makeGroups(teams,str='auto'){
  const n=teams.length; if(n<2) return [];
  const gCount=deriveGroupCount(n,str), shuffled=shuffle([...teams]);
  const groups=Array.from({length:gCount},(_,i)=>({id:String.fromCharCode(65+i),teams:[],matches:[]}));
  shuffled.forEach((t,i)=>groups[i%gCount].teams.push(t.id));
  groups.forEach(g=>{
    g.matches=generateRR(g.teams).map(m=>({id:uid(),round:m.round,home:m.home,away:m.away,hs:null,as:null,ot:false}));
  });
  return groups;
}
function generateRR(teamIds){
  const t=[...teamIds]; if(t.length%2===1) t.push(null);
  const n=t.length, rounds=n-1, half=n/2, fx=[];
  for(let r=0;r<rounds;r++){
    for(let i=0;i<half;i++){
      const a=t[i], b=t[n-1-i];
      if(a!==null && b!==null){
        const swap=(r%2===0)===(i%2===0);
        fx.push({round:r+1,home:swap?a:b,away:swap?b:a});
      }
    }
    const fixed=t[0], rest=t.slice(1);
    rest.unshift(rest.pop());
    t.splice(0,t.length,fixed,...rest);
  }
  return fx;
}

/* ===== Scoring & standings ===== */
function isScored(m){ return Number.isFinite(m.hs)&&Number.isFinite(m.as)&&m.hs!==m.as }
function computeStandings(groups,map){
  const out={};
  for(const g of groups){
    const table=g.teams.map(id=>({teamId:id,name:map[id].name,played:0,w:0,l:0,gf:0,ga:0,gd:0,pts:0}));
    const idx=Object.fromEntries(table.map((r,i)=>[r.teamId,i]));
    for(const m of g.matches){
      if(!isScored(m)) continue;
      const A=table[idx[m.home]], B=table[idx[m.away]];
      A.played++; B.played++;
      A.gf+=m.hs; A.ga+=m.as; A.gd=A.gf-A.ga;
      B.gf+=m.as; B.ga+=m.hs; B.gd=B.gf-B.ga;
      if(m.hs>m.as){
        A.w++; B.l++;
        if(m.ot){A.pts+=2; B.pts+=1}else{A.pts+=3}
      }else{
        B.w++; A.l++;
        if(m.ot){B.pts+=2; A.pts+=1}else{B.pts+=3}
      }
    }
    table.sort((a,b)=> (b.pts-a.pts)||(b.gd-a.gd)||(b.gf-a.gf)||a.name.localeCompare(b.name));
    out[g.id]=table;
  }
  return out;
}

/* ===== Bracket ===== */
function buildBracketFromStandings(st){
  const gids=Object.keys(st).sort(), c=gids.length;
  const topN=(gid,n)=>{ const arr=st[gid]||[]; const out=[]; for(let i=0;i<n;i++) out.push(arr[i]?.teamId ?? null); return out; }
  const pad=(a,n)=>{const k=[...a];while(k.length<n)k.push(null);return k}
  const mk=(pairs)=>({ qf:pairs.map(p=>({id:uid(),home:p.home,away:p.away,hs:null,as:null,ot:false})),
                       sf:[{id:uid(),home:null,away:null,hs:null,as:null,ot:false},{id:uid(),home:null,away:null,hs:null,as:null,ot:false}],
                       fin:[{id:uid(),home:null,away:null,hs:null,as:null,ot:false}],
                       third:[{id:uid(),home:null,away:null,hs:null,as:null,ot:false}] });
  if(c===2){
    const [A,B]=gids; const A4=pad(topN(A,4),4), B4=pad(topN(B,4),4);
    return mk([{home:A4[0],away:B4[3]},{home:A4[1],away:B4[2]},{home:B4[0],away:A4[3]},{home:B4[1],away:A4[2]}]);
  }
  if(c===4){
    const [A,B,C,D]=gids;
    const A2=pad(topN(A,2),2),B2=pad(topN(B,2),2),C2=pad(topN(C,2),2),D2=pad(topN(D,2),2);
    return mk([{home:A2[0],away:B2[1]},{home:B2[0],away:A2[1]},{home:C2[0],away:D2[1]},{home:D2[0],away:C2[1]}]);
  }
  if(c===6){
    const rank=(a,b)=> (b?.pts||0)-(a?.pts||0)||(b?.gd||0)-(a?.gd||0)||(b?.gf||0)-(a?.gf||0)||(a?.name||'').localeCompare(b?.name||'');
    const firsts=gids.map(g=>st[g][0]&&{...st[g][0],gid:g}).filter(Boolean);
    const seconds=gids.map(g=>st[g][1]&&{...st[g][1],gid:g}).filter(Boolean).sort(rank);
    const q=[...firsts, ...seconds.slice(0,2)];
    while(q.length<8) q.push({teamId:null});
    q.sort(rank);
    const s=q.map(x=>x.teamId??null);
    return mk([{home:s[0],away:s[7]},{home:s[1],away:s[6]},{home:s[2],away:s[5]},{home:s[3],away:s[4]}]);
  }
  const all=[]; for(const g of gids) all.push(...(st[g]||[]));
  all.sort((a,b)=> (b.pts-a.pts)||(b.gd-a.gd)||(b.gf-a.gf));
  const s=pad(all.slice(0,8).map(x=>x.teamId??null),8);
  return mk([{home:s[0],away:s[7]},{home:s[1],away:s[6]},{home:s[2],away:s[5]},{home:s[3],away:s[4]}]);
}
function nameOf(id,map){ return id ? (map[id]?.name||'?') : 'BYE' }
function pickWinner(m){
  if(!m) return null;
  if(m.home&&!m.away) return m.home;
  if(!m.home&&m.away) return m.away;
  if(Number.isFinite(m.hs)&&Number.isFinite(m.as)){
    if(m.hs>m.as) return m.home;
    if(m.as>m.hs) return m.away;
  }
  return null;
}
function pickLoser(m){ const w=pickWinner(m); if(!w) return null; return w===m.home ? (m.away||null) : (m.home||null); }
function propagate(br){
  const wQF=br.qf.map(pickWinner);
  br.sf[0].home=wQF[0]; br.sf[0].away=wQF[3];
  br.sf[1].home=wQF[1]; br.sf[1].away=wQF[2];
  const wSF=br.sf.map(pickWinner), lSF=br.sf.map(pickLoser);
  br.fin[0].home=wSF[0]; br.fin[0].away=wSF[1];
  br.third[0].home=lSF[0]; br.third[0].away=lSF[1];
}

/* ===== Avatars (fallback initials) ===== */
function initials(name){
  const parts=(name||'').trim().split(/\s+/).filter(Boolean);
  const a=parts[0]?.[0]||'?';
  const b=parts[1]?.[0]||'';
  return (a+b).toUpperCase();
}
function avatarHTML(team, alt=false){
  const cls = alt ? 'avatar alt' : 'avatar';
  if(team?.imageUrl){
    return `<span class="${cls}"><img src="${team.imageUrl}" alt=""></span>`;
  }
  return `<span class="${cls}">${initials(team?.name||'?')}</span>`;
}

/* ===== Match Modal (both scores + OT) ===== */
let mmCtx=null;
let mmActive='home';
let mmBuf={home:'', away:''};

function mmErr(msg){
  const el=$('#mmErr');
  if(!el) return;
  if(!msg){ el.classList.remove('show'); el.textContent=''; return; }
  el.textContent=msg;
  el.classList.add('show');
}

function mmOpen(ctx){
  // BYE -> no modal
  if(!ctx.homeId || !ctx.awayId) return;

  mmCtx=ctx;
  mmActive='home';
  mmBuf.home = Number.isFinite(ctx.hs) ? String(ctx.hs) : '';
  mmBuf.away = Number.isFinite(ctx.as) ? String(ctx.as) : '';

  $('#mmSub').textContent = ctx.subtitle || '';
  $('#mmHomeName').textContent = ctx.homeName || '‚Äî';
  $('#mmAwayName').textContent = ctx.awayName || '‚Äî';

  $('#mmOt').checked = !!ctx.ot;
  $('#mmOtHint').textContent = ctx.ot ? 'ON' : 'OFF';

  setActiveSide('home');
  mmErr('');
  mmRender();

  $('#mmBackdrop').classList.add('open');
  $('#mm').classList.add('open');
  $('#mm').setAttribute('aria-hidden','false');

  document.addEventListener('keydown', mmKeyHandler, {capture:true});
}

function mmClose(){
  $('#mmBackdrop').classList.remove('open');
  $('#mm').classList.remove('open');
  $('#mm').setAttribute('aria-hidden','true');
  mmCtx=null; mmActive='home'; mmBuf={home:'',away:''};
  mmErr('');
  document.removeEventListener('keydown', mmKeyHandler, {capture:true});
}

function setActiveSide(side){
  mmActive = side;
  $('#mmHomeBtn').classList.toggle('active', side==='home');
  $('#mmAwayBtn').classList.toggle('active', side==='away');
}

function mmRender(){
  $('#mmHomeVal').textContent = mmBuf.home==='' ? '‚Äî' : mmBuf.home;
  $('#mmAwayVal').textContent = mmBuf.away==='' ? '‚Äî' : mmBuf.away;
  $('#mmOtHint').textContent = $('#mmOt').checked ? 'ON' : 'OFF';
}

function mmKeyHandler(e){
  if(!$('#mm').classList.contains('open')) return;
  if(e.key==='Escape'){ e.preventDefault(); mmClose(); sfx.click(); return; }
  if(/^[0-9]$/.test(e.key)){ e.preventDefault(); mmDigit(e.key); return; }
  if(e.key==='Backspace'){ e.preventDefault(); mmBack(); return; }
  if(e.key==='Enter'){ e.preventDefault(); mmSave(); return; }
  if(e.key==='Tab'){
    e.preventDefault();
    setActiveSide(mmActive==='home'?'away':'home');
    sfx.click();
  }
}

function mmDigit(d){
  let s = mmBuf[mmActive];
  if(s.length>=3) return;
  if(s==='0') s=d; else s+=d;
  mmBuf[mmActive]=s;
  mmErr('');
  mmRender(); sfx.click();
}
function mmBack(){
  mmBuf[mmActive]=mmBuf[mmActive].slice(0,-1);
  mmErr('');
  mmRender(); sfx.click();
}
function mmClearSide(){
  mmBuf[mmActive]='';
  mmErr('');
  mmRender(); sfx.click();
}
function mmResetMatch(){
  mmBuf.home=''; mmBuf.away=''; $('#mmOt').checked=false;
  mmErr('');
  mmRender(); sfx.click();
}

function parseBuf(x){ return x==='' ? null : Math.max(0, parseInt(x,10)); }

function mmValidate(hs,as){
  if(Number.isFinite(hs) && Number.isFinite(as) && hs===as){
    mmErr('Neiz≈°ƒ∑irtu nav. OT gadƒ´jumƒÅ ievadi uzvaras vƒÅrtus.');
    return false;
  }
  return true;
}

function mmSave(){
  if(!mmCtx) return;
  const hs=parseBuf(mmBuf.home);
  const as=parseBuf(mmBuf.away);
  const ot=!!$('#mmOt').checked;

  if(!mmValidate(hs,as)) return;

  if(mmCtx.type==='group'){
    const G=state.groups.find(g=>g.id===mmCtx.gid); if(!G) return;
    const M=G.matches.find(m=>m.id===mmCtx.mid); if(!M) return;
    M.hs = hs;
    M.as = as;
    M.ot = ot;

    state.standings=computeStandings(state.groups,Object.fromEntries(state.teams.map(t=>[t.id,t])));
    saveState(state);
    renderGroups();
    renderStandings();
    sfx.score();
    mmClose();
    return;
  }

  if(mmCtx.type==='bracket'){
    if(!state.bracket) return;
    const col=mmCtx.stage==='QF'?'qf':mmCtx.stage==='SF'?'sf':mmCtx.stage==='Final'?'fin':'third';
    const M=state.bracket[col].find(x=>x.id===mmCtx.id); if(!M) return;
    M.hs = hs;
    M.as = as;
    M.ot = ot;

    propagate(state.bracket);
    state.overall=null;
    saveState(state);
    renderBracket();
    refreshOverallButtons();
    $('#statsPanel').hidden=true;
    $('#downloadPdfBtn').disabled=true;
    sfx.score();
    mmClose();
    return;
  }
}

/* Modal bindings */
$('#mmBackdrop').addEventListener('click', ()=>{ mmClose(); sfx.click(); });
$('#mmCloseBtn').addEventListener('click', ()=>{ mmClose(); sfx.click(); });
$('#mmHomeBtn').addEventListener('click', ()=>{ setActiveSide('home'); sfx.click(); });
$('#mmAwayBtn').addEventListener('click', ()=>{ setActiveSide('away'); sfx.click(); });
$('#mmHomeBtn').addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); setActiveSide('home'); sfx.click(); }});
$('#mmAwayBtn').addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); setActiveSide('away'); sfx.click(); }});
$('#mmOt').addEventListener('change', ()=>{ mmErr(''); mmRender(); sfx.click(); });
$('#mmSaveBtn').addEventListener('click', ()=>{ mmSave(); });
$('#mmResetMatchBtn').addEventListener('click', ()=>{ mmResetMatch(); });

$('#mmPad').addEventListener('click', (e)=>{
  const b=e.target.closest('button[data-k]'); if(!b) return;
  const k=b.dataset.k;
  if(/^\d$/.test(k)) mmDigit(k);
  else if(k==='bs') mmBack();
  else if(k==='clr') mmClearSide();
});

/* ===== GROUPS (render like screenshot) ===== */
function renderGroups(){
  const host=$('#groupsHost'); host.innerHTML='';
  const map=Object.fromEntries(state.teams.map(t=>[t.id,t]));
  state.groups.forEach(g=>{
    const card=document.createElement('div'); card.className='panel';
    const scored=g.matches.filter(isScored).length;

    card.innerHTML=`
      <div class="group-head">
        <div class="group-title">
          <span class="gid">${g.id}</span>
          <div>
            <div style="font-weight:1000;font-size:18px;letter-spacing:.2px">Grupa ${g.id}</div>
            <div class="muted tnum">${scored}/${g.matches.length}</div>
          </div>
        </div>
      </div>
      <div class="group-cal" id="cal_${g.id}" style="display:grid; gap:12px"></div>
    `;

    const cal = card.querySelector(`#cal_${g.id}`);
    const matches=[...g.matches].sort((a,b)=> (a.round-b.round) || (a.id.localeCompare(b.id)));

    for(const m of matches){
      const homeTeam=map[m.home];
      const awayTeam=map[m.away];

      const hs = Number.isFinite(m.hs) ? m.hs : '‚Äì';
      const as = Number.isFinite(m.as) ? m.as : '‚Äì';
      const done = isScored(m);

      const pill=document.createElement('div');
      pill.className='match-pill';
      pill.setAttribute('role','button');
      pill.setAttribute('tabindex','0');

      const isBye = (!m.home || !m.away);
      if(isBye){
        pill.classList.add('disabled');
        pill.setAttribute('aria-disabled','true');
      }

      pill.innerHTML=`
        <div class="mp-labels">
          <span>MƒÅjinieki</span>
          <span>Viesi</span>
        </div>
        <div class="mp-main">
          <div class="rbadge tnum">R${m.round}</div>

          <div class="team-chip home">
            ${avatarHTML(homeTeam,false)}
            <div class="team-name">${nameOf(m.home,map)}</div>
          </div>

          <div class="score-chip tnum ${done?'done':''}">
            ${hs}:${as}
            <span class="ot-badge ${m.ot?'on':''}">OT</span>
          </div>

          <div class="team-chip away">
            ${avatarHTML(awayTeam,true)}
            <div class="team-name">${nameOf(m.away,map)}</div>
          </div>
        </div>
      `;

      const open=()=>{
        if(isBye) return;
        mmOpen({
          type:'group',
          gid:g.id,
          mid:m.id,
          homeId:m.home,
          awayId:m.away,
          homeName:nameOf(m.home,map),
          awayName:nameOf(m.away,map),
          hs:m.hs, as:m.as, ot:m.ot,
          subtitle:`Grupa ${g.id} ‚Ä¢ R${m.round}`
        });
        sfx.click();
      };
      pill.addEventListener('click', open);
      pill.addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); open(); }});

      cal.appendChild(pill);
    }

    host.appendChild(card);
  });

  $('#groupsPanel').hidden = state.groups.length===0;
}

/* ===== STANDINGS ===== */
function renderStandings(){
  const host=$('#standingsHost'); host.innerHTML='';
  const st=state.standings||{}; const gids=Object.keys(st).sort();
  gids.forEach(gid=>{
    const card=document.createElement('div'); card.className='panel';
    card.innerHTML=`<h3>Grupa ${gid} ‚Äî StƒÅvƒìjums</h3>`;
    const tbl=document.createElement('table'); tbl.className='standings-table tnum';
    tbl.innerHTML=`<colgroup>
      <col style="width:var(--std-w-num)"><col>
      <col style="width:var(--std-w-num)"><col style="width:var(--std-w-num)"><col style="width:var(--std-w-num)">
      <col style="width:var(--std-w-num)"><col style="width:var(--std-w-num)"><col style="width:var(--std-w-num)"><col style="width:var(--std-w-num)">
    </colgroup>
    <thead><tr><th>#</th><th>Komanda</th><th>Sp</th><th>U</th><th>Z</th><th>GF</th><th>GA</th><th>GD</th><th>P</th></tr></thead><tbody></tbody>`;
    const body=$('tbody',tbl);
    st[gid].forEach((r,i)=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td style="text-align:center">${i+1}</td>
        <td><span class="name-nowrap">${r.name}</span></td>
        <td style="text-align:center">${r.played}</td><td style="text-align:center">${r.w}</td><td style="text-align:center">${r.l}</td>
        <td style="text-align:center">${r.gf}</td><td style="text-align:center">${r.ga}</td><td style="text-align:center">${r.gd}</td>
        <td style="text-align:center"><b>${r.pts}</b></td>`;
      body.appendChild(tr);
    });
    card.appendChild(tbl); host.appendChild(card);
  });
  $('#standingsPanel').hidden = !gids.length;
}

/* ===== Bracket ===== */
function winnerClass(m,side){
  if(m.home && !m.away) return side==='home'?'win':'';
  if(!m.home && m.away) return side==='away'?'win':'';
  if(Number.isFinite(m.hs)&&Number.isFinite(m.as)){
    if(m.hs>m.as && side==='home') return 'win';
    if(m.as>m.hs && side==='away') return 'win';
  } return '';
}
function teamCellLg(map,id){ return `<span class="row" style="gap:8px"><span class="name">${nameOf(id,map)}</span></span>`; }

function renderBracket(){
  const map=Object.fromEntries(state.teams.map(t=>[t.id,t]));
  $('#qfCol').innerHTML='<h3>CeturtdaƒºfinƒÅli</h3>';
  $('#sfCol').innerHTML='<h3>PusfinƒÅli</h3>';
  $('#finCol').innerHTML='<h3>FinƒÅls & 3. vieta</h3>';

  const mk=(m,stage,idx)=>{
    const el=document.createElement('div'); el.className='match';
    const hs = Number.isFinite(m.hs) ? m.hs : '';
    const as = Number.isFinite(m.as) ? m.as : '';
    el.innerHTML=`
      <div class="status">${stage} ${idx!=null?('‚Ä¢ '+(idx+1)):""}</div>
      <div class="team ${winnerClass(m,'home')}">
        <span class="seed">H</span>
        ${teamCellLg(map,m.home)}
        <input class="score-in tnum" type="text" readonly value="${hs}" />
      </div>
      <div class="team ${winnerClass(m,'away')}" style="margin-top:8px">
        <span class="seed">A</span>
        ${teamCellLg(map,m.away)}
        <input class="score-in tnum" type="text" readonly value="${as}" />
      </div>
      <div class="row" style="margin-top:8px">
        <label style="display:inline-flex;align-items:center;gap:6px;font-size:12px;color:var(--muted)">
          <input class="chk" type="checkbox" ${m.ot?'checked':''} data-stage="${stage}" data-id="${m.id}" data-ot="flag" /> OT
        </label>
      </div>`;
    el.addEventListener('click', (e)=>{
      if(e.target.closest('[data-ot]')) return;
      if(!m.home || !m.away) return;
      mmOpen({
        type:'bracket',
        stage,
        id:m.id,
        homeId:m.home,
        awayId:m.away,
        homeName:nameOf(m.home,map),
        awayName:nameOf(m.away,map),
        hs:m.hs, as:m.as, ot:m.ot,
        subtitle:`${stage}`
      });
      sfx.click();
    });
    el.setAttribute('role','button');
    el.setAttribute('tabindex','0');
    el.addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); el.click(); }});
    return el;
  };

  state.bracket?.qf?.forEach((m,i)=>$('#qfCol').appendChild(mk(m,'QF',i)));
  state.bracket?.sf?.forEach((m,i)=>$('#sfCol').appendChild(mk(m,'SF',i)));
  state.bracket?.fin?.forEach(m=>$('#finCol').appendChild(mk(m,'Final')));
  state.bracket?.third?.forEach(m=>$('#finCol').appendChild(mk(m,'3rd')));

  $$('.bracket [data-ot]').forEach(el=>{
    el.addEventListener('change', ()=>{
      const stage=el.dataset.stage, id=el.dataset.id;
      const col=stage==='QF'?'qf':stage==='SF'?'sf':stage==='Final'?'fin':'third';
      const m=state.bracket[col].find(x=>x.id===id);
      m.ot=el.checked; sfx.click();
      propagate(state.bracket); saveState(state); renderBracket(); refreshOverallButtons();
    });
  });

  refreshOverallButtons();
}

/* ===== Overall / Awards & PDF ===== */
function tournamentFinished(){
  if(!state.bracket) return false;
  const fin=state.bracket.fin[0], third=state.bracket.third[0];
  return !!(pickWinner(fin)&&pickWinner(third));
}
function refreshOverallButtons(){
  const ready=tournamentFinished();
  $('#overallBtn').disabled=!ready;
  $('#downloadPdfBtn').disabled=!(ready&&state.overall);
}
function computeOverall(){
  const map=Object.fromEntries(state.teams.map(t=>[t.id,t.name])), ids=Object.keys(map);
  const stats=Object.fromEntries(ids.map(id=>[id,{teamId:id,name:map[id],played:0,wins:0,losses:0,gf:0,ga:0}]));
  const apply=m=>{
    if(!m||!m.home||!m.away) return;
    if(!isScored(m)) return;
    const hs=m.hs, as=m.as, H=stats[m.home], A=stats[m.away];
    H.played++; A.played++;
    H.gf+=hs; H.ga+=as;
    A.gf+=as; A.ga+=hs;
    if(hs>as){H.wins++;A.losses++;} else {A.wins++;H.losses++;}
  };
  for(const g of state.groups) for(const m of g.matches) apply(m);
  if(state.bracket) [...state.bracket.qf,...state.bracket.sf,...state.bracket.fin,...state.bracket.third].forEach(apply);
  const arr=Object.values(stats);
  const maxGF=Math.max(...arr.map(s=>s.gf)), maxGA=Math.max(...arr.map(s=>s.ga));
  const topGF=arr.filter(s=>s.gf===maxGF).map(s=>s.name), topGA=arr.filter(s=>s.ga===maxGA).map(s=>s.name);
  const winId=state.bracket?pickWinner(state.bracket.fin[0]):null, winName=winId?map[winId]:'‚Äî';
  return { winnerName:winName, topGF, maxGF, topGA, maxGA, teamStats: arr.sort((a,b)=> (b.wins-a.wins) || ((b.gf-b.ga)-(a.gf-a.ga)) || (b.gf-a.gf) || a.name.localeCompare(b.name)) };
}
function renderOverall(o){
  const awards=$('#awards'); awards.innerHTML='';
  const card=(t,c)=>{ const d=document.createElement('div'); d.className='panel'; d.innerHTML=`<div class="muted">${t}</div><div style="font-weight:1000;font-size:16px;margin-top:6px">${c}</div>`; return d; };
  awards.appendChild(card('Turnƒ´ra uzvarƒìtƒÅjs', o.winnerName));
  awards.appendChild(card('VisvairƒÅk g≈´tie vƒÅrti', `${o.topGF.join(', ')} (${o.maxGF})`));
  awards.appendChild(card('VisvairƒÅk ielaistie vƒÅrti', `${o.topGA.join(', ')} (${o.maxGA})`));

  const host=$('#teamStatsHost'); const tbl=document.createElement('table'); tbl.className='standings-table tnum';
  tbl.innerHTML=`<colgroup>
    <col><col style="width:var(--std-w-num)"><col style="width:var(--std-w-num)"><col style="width:var(--std-w-num)">
    <col style="width:var(--std-w-num)"><col style="width:var(--std-w-num)"><col style="width:var(--std-w-num)">
  </colgroup>
  <thead><tr><th>Komanda</th><th>Sp</th><th>U</th><th>Z</th><th>GF</th><th>GA</th><th>GD</th></tr></thead><tbody></tbody>`;
  const body=$('tbody',tbl);
  o.teamStats.forEach(s=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td><span class="name-nowrap">${s.name}</span></td><td style="text-align:center">${s.played}</td><td style="text-align:center">${s.wins}</td><td style="text-align:center">${s.losses}</td>
      <td style="text-align:center">${s.gf}</td><td style="text-align:center">${s.ga}</td><td style="text-align:center">${s.gf-s.ga}</td>`;
    body.appendChild(tr);
  });
  host.innerHTML=''; host.appendChild(tbl);
}
$('#overallBtn').addEventListener('click', ()=>{
  if(!tournamentFinished()){ notice('Kopsavilkums pieejams pƒìc finƒÅla un 3. vietas spƒìles.'); return; }
  state.overall=computeOverall(); saveState(state); renderOverall(state.overall);
  $('#statsPanel').hidden=false; $('#downloadPdfBtn').disabled=false; sfx.success();
});
$('#downloadPdfBtn').addEventListener('click', ()=>{
  if(!state.overall){ notice('Vispirms ƒ£enerƒì kopsavilkumu.'); return; }
  try{
    const { jsPDF } = window.jspdf; const doc=new jsPDF({unit:'pt',format:'a4'});
    const margin=36, lineH=18, pageW=doc.internal.pageSize.getWidth();
    const title = state.name ? `Turnƒ´ra kopsavilkums ‚Äî ${state.name}` : 'Turnƒ´ra kopsavilkums';
    doc.setFont('helvetica','bold'); doc.setFontSize(18); doc.text(title, margin, 52);
    doc.setFont('helvetica','normal'); doc.setFontSize(11); doc.text(`Datums: ${todayStamp()}`, pageW - margin - 140, 52);
    const y0=78;
    doc.text(`UzvarƒìtƒÅjs: ${state.overall.winnerName}`, margin, y0);
    doc.text(`VisvairƒÅk g≈´tie vƒÅrti: ${state.overall.topGF.join(', ')} (${state.overall.maxGF})`, margin, y0+lineH);
    doc.text(`VisvairƒÅk ielaistie vƒÅrti: ${state.overall.topGA.join(', ')} (${state.overall.maxGA})`, margin, y0+lineH*2);

    const rows = state.overall.teamStats.map(s=>({ name:s.name, Sp:s.played, U:s.wins, Z:s.losses, GF:s.gf, GA:s.ga, GD:(s.gf-s.ga) }));
    doc.autoTable({
      startY: y0+lineH*3+10,
      head: [['Komanda','Sp','U','Z','GF','GA','GD']],
      body: rows.map(r=>[r.name, r.Sp, r.U, r.Z, r.GF, r.GA, r.GD]),
      styles:{font:'helvetica',fontSize:10,cellPadding:4},
      headStyles:{fillColor:[124,92,255],textColor:255},
      alternateRowStyles:{fillColor:[245,245,248]},
      margin:{left:margin,right:margin}
    });
    const fname=`${slugify(state.name)}_${todayStamp()}_kopsavilkums.pdf`; doc.save(fname); sfx.success();
  }catch(e){ notice('NeizdevƒÅs ƒ£enerƒìt PDF.'); }
});

/* ===== UI hooks ===== */
function updateGroupOptions(){
  const n = ($('#teamsInput').value.split('\n').map(s=>s.trim()).filter(Boolean)).length;
  const optN1=$('#groupStrategy').querySelector('option[value="n1"]');
  if(n>6){ optN1.disabled=true; } else { optN1.disabled=false; }
}
$('#teamsInput').addEventListener('input', updateGroupOptions);

$('#genGroups').addEventListener('click', ()=>{
  const name=$('#tName').value.trim();
  const teamNames=$('#teamsInput').value.split('\n').map(s=>s.trim()).filter(Boolean);
  if(teamNames.length<2){ notice('Ievadi vismaz 2 komandas.'); return; }
  if($('#groupStrategy').value==='n1' && teamNames.length>6){
    $('#groupStrategy').value='auto';
  }
  const teams=teamNames.map(n=>({id:uid(),name:n, imageUrl:null}));
  state={...state,name,teams,groups:makeGroups(teams,$('#groupStrategy').value), standings:{}, bracket:null, overall:null};
  state.standings=computeStandings(state.groups,Object.fromEntries(teams.map(t=>[t.id,t])));
  saveState(state);
  $('#brandTitle').textContent = state.name || 'Turnƒ´ru AplikƒÅcija';
  updateGroupOptions();
  renderGroups();
  renderStandings();
  $('#playoffPanel').hidden=false; $('#groupsPanel').hidden=false; $('#standingsPanel').hidden=false;
  $('#statsPanel').hidden=true; $('#downloadPdfBtn').disabled=true;
  sfx.success();
});

$('#buildBracket').addEventListener('click', ()=>{
  if(!state.groups.length){ notice('Vispirms jƒÅievada grupu dati.'); return; }
  state.standings=computeStandings(state.groups,Object.fromEntries(state.teams.map(t=>[t.id,t])));
  state.bracket=buildBracketFromStandings(state.standings);
  propagate(state.bracket);
  state.overall=null;
  saveState(state);
  renderBracket();
  $('#statsPanel').hidden=true; $('#downloadPdfBtn').disabled=true;
  sfx.success();
});

$('#exportBtn').addEventListener('click', ()=>{
  const data='data:application/json;charset=utf-8,'+encodeURIComponent(JSON.stringify(state,null,2));
  const a=document.createElement('a'); a.href=data; a.download=(slugify(state.name)||'tournament')+'.json'; a.click(); sfx.click();
});

$('#importBtn').addEventListener('click', async ()=>{
  const inp=document.createElement('input'); inp.type='file'; inp.accept='application/json';
  inp.onchange=async ()=>{
    const f=inp.files[0]; if(!f) return;
    try{
      const txt=await f.text(); const obj=JSON.parse(txt);
      state=Object.assign({name:'',teams:[],groups:[],standings:{},bracket:null,overall:null},obj);
      saveState(state);
      $('#tName').value=state.name||'';
      $('#teamsInput').value=(state.teams||[]).map(t=>t.name).join('\n');
      $('#brandTitle').textContent = state.name || 'Turnƒ´ru AplikƒÅcija';

      if(state.groups?.length){ renderGroups(); $('#groupsPanel').hidden=false }
      if(state.standings && Object.keys(state.standings).length){ renderStandings(); $('#standingsPanel').hidden=false }
      if(state.bracket){ renderBracket(); $('#playoffPanel').hidden=false }
      if(state.overall){ renderOverall(state.overall); $('#statsPanel').hidden=false; $('#downloadPdfBtn').disabled=false }

      updateGroupOptions();
      sfx.success();
    }catch{
      notice('NeizdevƒÅs importƒìt.');
    }
  };
  inp.click();
});

$('#resetBtn').addEventListener('click', ()=>{
  if(!confirm('Tie≈°ƒÅm notƒ´rƒ´t turnƒ´ru?')) return;
  clearState();
  state={name:'',teams:[],groups:[],standings:{},bracket:null,overall:null};
  $('#tName').value=''; $('#teamsInput').value=''; $('#brandTitle').textContent='Turnƒ´ru AplikƒÅcija';
  $('#groupsHost').innerHTML=''; $('#standingsHost').innerHTML='';
  $('#qfCol').innerHTML='<h3>CeturtdaƒºfinƒÅli</h3>'; $('#sfCol').innerHTML='<h3>PusfinƒÅli</h3>'; $('#finCol').innerHTML='<h3>FinƒÅls & 3. vieta</h3>';
  $('#groupsPanel').hidden=true; $('#standingsPanel').hidden=true; $('#playoffPanel').hidden=true; $('#statsPanel').hidden=true;
  $('#downloadPdfBtn').disabled=true; $('#overallBtn').disabled=true;
  sfx.click();
});

/* ===== Restore ===== */
(function boot(){
  $('#soundIcon').textContent = soundOn ? 'üîä' : 'üîá';
  const saved=loadState();
  if(saved){
    state=Object.assign(state,saved);
    $('#tName').value=state.name||'';
    $('#teamsInput').value=(state.teams||[]).map(t=>t.name).join('\n');
    $('#brandTitle').textContent = state.name || 'Turnƒ´ru AplikƒÅcija';
    if(state.groups?.length){ renderGroups(); $('#groupsPanel').hidden=false }
    if(state.standings && Object.keys(state.standings).length){ renderStandings(); $('#standingsPanel').hidden=false }
    if(state.bracket){ renderBracket(); $('#playoffPanel').hidden=false }
    if(state.overall){ renderOverall(state.overall); $('#statsPanel').hidden=false; $('#downloadPdfBtn').disabled=false }
  }
  updateGroupOptions();
})();
</script>
</body>
</html>
