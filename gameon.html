<!doctype html>
<html lang="lv">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>TurnÄ«ru AplikÄcija â€” Pro Liquid UI</title>
<meta name="color-scheme" content="light dark" />
<style>
  /* ===== Pro Liquid + Glass Theme ===== */
  :root{
    --bg:#0b0f14; --text:#e6e9ef; --muted:#9aa4b2;
    --card:rgba(18,24,38,.55); --border:rgba(255,255,255,.08); --ring:#6f7dd62b;
    --accent:#7c5cff; --accent2:#45a2ff; --gold:#f4c542; --ok:#19c37d; --danger:#ff5d5d;
    --radius:16px; --shadow:0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.05);
    --font:ui-sans-serif,-apple-system,"SF Pro Text","Inter","Segoe UI",Roboto,Arial; --space:clamp(10px,2vw,18px);
  }
  @media (prefers-color-scheme:light){
    :root{ --bg:#f7f8fc; --text:#0f172a; --muted:#4b5568; --card:rgba(255,255,255,.82); --border:rgba(15,23,42,.08);
           --ring:#7c8dd41c; --shadow:0 12px 30px rgba(18,20,40,.08), inset 0 1px 0 rgba(255,255,255,.55)}
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;color:var(--text);font-family:var(--font);background:var(--bg);
    background:
      radial-gradient(1200px 800px at 120% -10%, color-mix(in oklab, var(--accent) 35%, transparent), transparent 60%),
      radial-gradient(900px 600px at -30% 20%, color-mix(in oklab, var(--accent2) 35%, transparent), transparent 60%),
      radial-gradient(600px 500px at 80% 110%, color-mix(in oklab, #19c37d 35%, transparent), transparent 60%);
  }

  header{
    position:sticky;top:0;z-index:20;backdrop-filter:saturate(140%) blur(12px);
    background:linear-gradient(180deg, rgba(0,0,0,.0), rgba(0,0,0,.05)), var(--card);
    border-bottom:1px solid var(--border);
  }
  .bar{max-width:1200px;margin:0 auto;padding:12px clamp(14px,3vw,24px);display:flex;gap:12px;align-items:center;justify-content:space-between}
  .brand{display:flex;gap:12px;align-items:center;font-weight:800;letter-spacing:.2px}
  .brand img{width:28px;height:28px;border-radius:8px;object-fit:cover;box-shadow:0 0 10px #0003}
  .dot{width:14px;height:14px;border-radius:50%;
       background:radial-gradient(12px 12px at 20% 20%, #fff8, #0000), linear-gradient(135deg,var(--accent),var(--accent2))}
  .wrap{max-width:1200px;margin:clamp(10px,2vw,20px) auto clamp(60px,7vw,96px); padding:0 clamp(14px,3vw,24px);display:grid;gap:var(--space)}

  .panel{
    background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);
    padding:clamp(12px,2.6vw,20px); transition:transform .12s ease, box-shadow .25s ease, border-color .2s ease, background .2s ease;
  }
  .panel:hover{ transform:translateY(-1px) }

  h1,h2,h3{margin:0 0 8px}
  h2{font-size:clamp(18px,2.6vw,22px)} h3{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.12em}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}

  input,textarea,select{
    width:100%;background:rgba(255,255,255,.02);color:var(--text);border:1px solid var(--border);border-radius:12px;padding:12px 12px;
    transition:border .2s ease, box-shadow .2s ease, background-color .2s ease, transform .08s ease;
  }
  textarea{min-height:160px;resize:vertical}
  input:focus,textarea:focus,select:focus{outline:none;border-color:color-mix(in oklab, var(--accent) 45%, var(--border));box-shadow:0 0 0 6px var(--ring)}
  .btn{appearance:none;border:1px solid var(--border);background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(0,0,0,.08));
       color:var(--text);border-radius:999px;padding:11px 16px;cursor:pointer}
  .btn--accent{border:none;background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff}
  .btn--gold{border:none;background:linear-gradient(135deg,var(--gold),#ffd569);color:#1a1a1a}
  .muted{color:var(--muted);font-size:13px}

  /* ===== Tables ===== */
  .table-scroll{overflow:auto; -webkit-overflow-scrolling:touch}
  table{width:100%;border-collapse:separate;border-spacing:0 10px}
  th,td{padding:clamp(6px,1.8vw,12px) clamp(8px,2vw,14px);text-align:left}
  thead th{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.12em}
  tbody tr{background:linear-gradient(180deg,transparent, color-mix(in oklab, var(--card) 88%, transparent))}
  .score-in{width:56px;text-align:center;padding:10px}
  .chip{display:inline-flex;align-items:center;gap:6px;padding:6px 12px;border:1px solid var(--border);border-radius:999px;font-size:12px;background:rgba(255,255,255,.02)}

  /* ===== Standings: always fit; names never break per letter ===== */
  .standings-table{table-layout:fixed}
  .standings-table th:not(:nth-child(2)), .standings-table td:not(:nth-child(2)){width:clamp(38px,7vw,60px); text-align:center}
  .standings-table th:nth-child(2), .standings-table td:nth-child(2){width:auto}
  .name-nowrap{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;display:inline-block;max-width:65vw}
  @media (min-width:700px){ .name-nowrap{max-width:unset} }
  @media (max-width:520px){ .standings-table th,.standings-table td{font-size:12px;padding:6px 6px} .score-in{width:50px} }

  /* Logos */
  .logo{width:18px;height:18px;border-radius:50%;object-fit:cover;border:1px solid var(--border)}
  .logo-lg{width:22px;height:22px;border-radius:6px;object-fit:cover;border:1px solid var(--border)}

  /* ===== Bracket ===== */
  .bracket{display:grid;gap:var(--space);grid-template-columns:repeat(3, minmax(260px,1fr))}
  .round{display:grid;gap:var(--space)}
  .match{border:1px solid var(--border);border-radius:14px;padding:12px;background:color-mix(in oklab, var(--card) 94%, transparent)}
  .team{display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:center;padding:8px;border-radius:10px}
  .team.win{outline:2px solid color-mix(in oklab, var(--ok) 45%, transparent);outline-offset:-2px}
  .status{font-size:12px;color:var(--muted);margin-bottom:6px}

  /* ===== Groups: summary + inline expand ===== */
  .group-card{position:relative; cursor:pointer}
  .chips{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}
  .chip-tag{padding:6px 10px;border:1px solid var(--border);border-radius:999px;font-size:12px;background:rgba(255,255,255,.02)}
  .prog{margin-top:6px;font-size:12px;color:var(--muted)}
  .fixtures{margin-top:8px;display:grid;gap:6px}
  .fix-row{display:grid;grid-template-columns:36px 1fr auto 1fr auto;gap:8px;align-items:center}
  .fix-row .vs{color:var(--muted);text-align:center}
  .fix-row .score{font-weight:700}
  .fix-row .ot{color:var(--muted);font-size:12px}

  /* edit mode within card */
  .group-card .edit-mode{display:none}
  .group-card.edit .view-mode{display:none}
  .group-card.edit .edit-mode{display:block}
  .group-actions{display:none; margin-top:8px; justify-content:flex-end}
  .group-card.edit .group-actions{display:flex}
  /* prevent accidental collapse when clicking inputs */
  .stop-prop{pointer-events:auto}
</style>
</head>
<body>
<header>
  <div class="bar">
    <div class="brand">
      <img id="brandLogoImg" alt="" style="display:none"/>
      <span class="dot" id="brandDot"></span>
      <span id="brandTitle">TurnÄ«ru AplikÄcija</span>
    </div>
    <div class="row">
      <button class="btn" id="imagesToggleBtn">ğŸ–¼ï¸ AttÄ“li</button>
      <button class="btn" id="exportBtn">EksportÄ“t</button>
      <button class="btn" id="importBtn">ImportÄ“t</button>
      <button class="btn" id="resetBtn">NotÄ«rÄ«t</button>
      <button class="btn" id="soundBtn"><span id="soundIcon">ğŸ”Š</span></button>
    </div>
  </div>
</header>

<main class="wrap">
  <!-- SETUP -->
  <section class="panel" id="setupPanel">
    <div class="row" style="justify-content:space-between">
      <h2>1) Ievadi komandas</h2>
      <div class="muted">Dati glabÄjas lokÄli (localStorage)</div>
    </div>

    <div class="row" style="gap:var(--space); align-items:flex-start">
      <div style="flex:2; min-width:260px">
        <input id="tName" placeholder="TurnÄ«ra nosaukums (neobligÄts)"/>
        <div style="height:10px"></div>
        <textarea id="teamsInput" placeholder="Katru komandu jaunÄ rindÄ..."></textarea>
      </div>
      <div style="flex:1; min-width:240px">
        <label class="muted" for="groupStrategy">Grupu skaits</label>
        <select id="groupStrategy">
          <option value="auto" selected>AutomÄtiski (2/4/6; â‰¤6 â†’ 1 grupa)</option>
          <option value="n1">1 grupa (tikai ja â‰¤6 kom.)</option>
          <option value="n2">2 grupas</option>
          <option value="n4">4 grupas</option>
          <option value="n6">6 grupas</option>
        </select>
        <div style="height:10px"></div>
        <button class="btn btn--accent" id="genGroups" style="width:100%">Ä¢enerÄ“t grupas</button>
      </div>
    </div>
  </section>

  <!-- HIDDEN IMAGES PANEL -->
  <section class="panel" id="imagesPanel" hidden>
    <h2>AttÄ“lu iestatÄ«jumi (neobligÄti)</h2>
    <div style="height:10px"></div>
    <div class="panel" style="padding:12px">
      <h3>TurnÄ«ra logotips</h3>
      <div class="row" style="align-items:center; justify-content:space-between; gap:12px;">
        <div class="row" style="gap:10px">
          <img id="brandLogoPreview" class="logo-lg" alt="" style="display:none"/>
          <div class="muted" id="brandLogoPlaceholder">Nav iestatÄ«ts</div>
        </div>
        <div class="row">
          <input type="file" id="brandLogoInput" accept="image/*"/>
          <button class="btn" id="clearBrandLogo">NoÅ†emt</button>
        </div>
      </div>
    </div>

    <div style="height:10px"></div>
    <div id="logosHost" class="grid" style="display:grid;gap:var(--space);grid-template-columns:repeat(auto-fit,minmax(220px,1fr))"></div>
  </section>

  <!-- GROUPS -->
  <section class="panel" id="groupsPanel" hidden>
    <h2>2) Grupas & kalendÄrs</h2>
    <div id="groupsHost" class="grid" style="display:grid; gap:var(--space); grid-template-columns:repeat(auto-fit,minmax(300px,1fr))"></div>
  </section>

  <!-- STANDINGS -->
  <section class="panel" id="standingsPanel" hidden>
    <h2>3) StÄvÄ“jums (Standings)</h2>
    <div id="standingsHost" class="grid" style="display:grid; gap:var(--space); grid-template-columns:repeat(auto-fit,minmax(300px,1fr))"></div>
  </section>

  <!-- PLAYOFF -->
  <section class="panel" id="playoffPanel" hidden>
    <div class="row" style="justify-content:space-between;align-items:center">
      <h2>4) Playoff (no Quarterfinals)</h2>
      <button class="btn" id="buildBracket">Ä¢enerÄ“t Bracket</button>
    </div>

    <div class="bracket" style="margin-top:var(--space)">
      <div class="round" id="qfCol"><h3>CeturtdaÄ¼finÄli</h3></div>
      <div class="round" id="sfCol"><h3>PusfinÄli</h3></div>
      <div class="round" id="finCol"><h3>FinÄls & 3. vieta</h3></div>
    </div>

    <div class="row" style="margin-top:12px">
      <button class="btn btn--gold" id="overallBtn" disabled>Kopsavilkums</button>
      <button class="btn" id="downloadPdfBtn" disabled>LejupielÄdÄ“t PDF</button>
    </div>

    <div id="statsPanel" class="grid" hidden style="margin-top:var(--space)">
      <h2>5) TurnÄ«ra kopsavilkums & apbalvojumi</h2>
      <div id="awards" class="awards"></div>
      <div class="panel" id="teamStatsPanel">
        <h3>Komandu kopstatistika</h3>
        <div id="teamStatsHost"></div>
      </div>
    </div>
  </section>
</main>

<!-- PDF libs -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script>
/* ===== Sync config (Sheets optional) ===== */
const SYNC_ENDPOINT = ''; // ieliec GAS URL, ja vajag dublÄ“t
const SYNC_ENABLED  = !!SYNC_ENDPOINT;

/* ===== Util ===== */
const $ = (s,r=document)=>r.querySelector(s);
const $$ = (s,r=document)=>Array.from(r.querySelectorAll(s));
const uid=()=>Math.random().toString(36).slice(2,9);
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a}
const todayStamp = ()=> new Date().toISOString().slice(0,10);
const slugify = s => (s||'').toLowerCase().normalize('NFKD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'').slice(0,80)||'tournament';

/* ===== Storage ===== */
const STORAGE_KEY='tournament_state_pro_v6';
function saveState(s){ localStorage.setItem(STORAGE_KEY, JSON.stringify(s)); Sync.push({type:'STATE_SAVE'}); }
function loadState(){ try{return JSON.parse(localStorage.getItem(STORAGE_KEY)||'null')}catch{return null} }
function clearState(){ localStorage.removeItem(STORAGE_KEY); }
const SOUND_PREF_KEY='tournament_sound_on';

/* ===== Optional sync queue ===== */
function getClientId(){ let id=localStorage.getItem('tournament_client_id'); if(!id){id=crypto.randomUUID?.()||('c_'+uid()); localStorage.setItem('tournament_client_id',id)} return id; }
const Sync={ key:'tournament_sync_queue_v1',queue:[],timer:null,
  init(){ try{this.queue=JSON.parse(localStorage.getItem(this.key)||'[]')}catch{this.queue=[]}
    if(SYNC_ENABLED&&navigator.onLine) this.schedule(300);
    addEventListener('online',()=>this.schedule(0));
    addEventListener('visibilitychange',()=>{ if(document.visibilityState==='hidden') this.flush({beacon:true}); else this.schedule(200); });
    addEventListener('beforeunload',()=>this.flush({beacon:true}));
  },
  persist(){ localStorage.setItem(this.key, JSON.stringify(this.queue)) },
  push(event){ if(!SYNC_ENABLED) return; this.queue.push({t:Date.now(),client:getClientId(),event}); this.persist(); this.schedule(400); },
  schedule(ms=400){ if(!SYNC_ENABLED) return; clearTimeout(this.timer); this.timer=setTimeout(()=>this.flush().catch(()=>{}),ms) },
  async flush({beacon=false}={}){ if(!SYNC_ENABLED||!this.queue.length) return;
    const batch=this.queue.slice(0,50), payload=JSON.stringify({client:getClientId(),ua:navigator.userAgent,batch});
    try{
      if(beacon && navigator.sendBeacon){
        const ok=navigator.sendBeacon(SYNC_ENDPOINT,new Blob([payload],{type:'application/json'}));
        if(ok){this.queue.splice(0,batch.length); this.persist();} return;
      }
      const res=await fetch(SYNC_ENDPOINT,{method:'POST',headers:{'Content-Type':'application/json'},body:payload,mode:'cors',keepalive:true});
      if(res.ok){this.queue.splice(0,batch.length); this.persist();}
    }catch{} finally{ if(this.queue.length) this.schedule(1500); }
  }
}; Sync.init();

/* ===== Sounds ===== */
let audioCtx=null; let soundOn=(localStorage.getItem(SOUND_PREF_KEY)!=='0');
const ensureCtx=()=>{ if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)() };
function beep({freq=440,type='sine',dur=0.08,gain=0.05,a=0.005,r=0.06}={}){ if(!soundOn) return; ensureCtx();
  const now=audioCtx.currentTime, o=audioCtx.createOscillator(), g=audioCtx.createGain();
  o.type=type; o.frequency.setValueAtTime(freq,now); g.gain.setValueAtTime(0,now);
  g.gain.linearRampToValueAtTime(gain,now+a); g.gain.exponentialRampToValueAtTime(0.0001,now+a+dur+r);
  o.connect(g); g.connect(audioCtx.destination); o.start(now); o.stop(now+a+dur+r+0.02);
}
const sfx={ click:()=>beep({freq:280,type:'triangle',dur:0.05,gain:0.06}),
            score:()=>{beep({freq:420,type:'square',dur:0.06,gain:0.06}); setTimeout(()=>beep({freq:590,type:'square',dur:0.06,gain:0.05}),70)},
            success:()=>{beep({freq:450,type:'sine',dur:0.07,gain:0.06}); setTimeout(()=>beep({freq:650,type:'sine',dur:0.09,gain:0.05}),90)} };
$('#soundBtn').addEventListener('click',()=>{ soundOn=!soundOn; localStorage.setItem(SOUND_PREF_KEY,soundOn?'1':'0'); $('#soundIcon').textContent=soundOn?'ğŸ”Š':'ğŸ”‡'; sfx.click(); });

/* ===== State ===== */
let state={ name:'', teams:[], logos:{}, brandLogo:null, groups:[], standings:{}, bracket:null, overall:null };

/* ===== Grouping / fixtures ===== */
function deriveGroupCount(n,str){
  const allowed=[2,4,6];
  if(str==='n1') return (n<=6)?1:deriveGroupCount(n,'auto');
  if(str==='auto' && n<=6) return Math.min(1,n);
  if(str?.startsWith('n')){ const req=+str.slice(1); if(req===1 && n<=6) return 1; if(allowed.includes(req)) return Math.min(req,n); }
  if(n<=6) return 1;
  const target=Math.round(n/4); let best=2; for(const k of allowed){ if(k>n) continue; const dK=Math.abs(k-target), dB=Math.abs(best-target); if(dK<dB||(dK===dB&&k>best)) best=k; } return best;
}
function makeGroups(teams,str='auto'){
  const n=teams.length; if(n<2) return [];
  const gCount=deriveGroupCount(n,str), shuffled=shuffle([...teams]);
  const groups=Array.from({length:gCount},(_,i)=>({id:String.fromCharCode(65+i),teams:[],matches:[]}));
  shuffled.forEach((t,i)=>groups[i%gCount].teams.push(t.id));
  groups.forEach(g=>{ g.matches=generateRR(g.teams).map(m=>({id:uid(),round:m.round,home:m.home,away:m.away,hs:null,as:null,ot:false})); });
  return groups;
}
function generateRR(teamIds){
  const t=[...teamIds]; if(t.length%2===1) t.push(null);
  const n=t.length, rounds=n-1, half=n/2, fx=[];
  for(let r=0;r<rounds;r++){
    for(let i=0;i<half;i++){ const a=t[i], b=t[n-1-i]; if(a!==null && b!==null){ const swap=(r%2===0)===(i%2===0); fx.push({round:r+1,home:swap?a:b,away:swap?b:a}); } }
    const fixed=t[0], rest=t.slice(1); rest.unshift(rest.pop()); t.splice(0,t.length,fixed,...rest);
  } return fx;
}

/* ===== Scoring & standings ===== */
function isScored(m){ return Number.isFinite(m.hs)&&Number.isFinite(m.as)&&m.hs!==m.as }
function computeStandings(groups,map){
  const out={};
  for(const g of groups){
    const table=g.teams.map(id=>({teamId:id,name:map[id].name,played:0,w:0,l:0,gf:0,ga:0,gd:0,pts:0}));
    const idx=Object.fromEntries(table.map((r,i)=>[r.teamId,i]));
    for(const m of g.matches){
      if(!isScored(m)) continue;
      const A=table[idx[m.home]], B=table[idx[m.away]];
      A.played++; B.played++; A.gf+=m.hs; A.ga+=m.as; A.gd=A.gf-A.ga; B.gf+=m.as; B.ga+=m.hs; B.gd=B.gf-B.ga;
      if(m.hs>m.as){ A.w++; B.l++; if(m.ot){A.pts+=2; B.pts+=1}else{A.pts+=3} }
      else{ B.w++; A.l++; if(m.ot){B.pts+=2; A.pts+=1}else{B.pts+=3} }
    }
    table.sort((a,b)=> (b.pts-a.pts)||(b.gd-a.gd)||(b.gf-a.gf)||a.name.localeCompare(b.name));
    out[g.id]=table;
  } return out;
}

/* ===== Bracket ===== */
function buildBracketFromStandings(st){
  const gids=Object.keys(st).sort(), c=gids.length;
  const topN=(gid,n)=>{ const arr=st[gid]||[]; const out=[]; for(let i=0;i<n;i++) out.push(arr[i]?.teamId ?? null); return out; }
  const pad=(a,n)=>{const k=[...a];while(k.length<n)k.push(null);return k}
  const mk=(pairs)=>({ qf:pairs.map(p=>({id:uid(),home:p.home,away:p.away,hs:null,as:null,ot:false})),
                       sf:[{id:uid(),home:null,away:null,hs:null,as:null,ot:false},{id:uid(),home:null,away:null,hs:null,as:null,ot:false}],
                       fin:[{id:uid(),home:null,away:null,hs:null,as:null,ot:false}],
                       third:[{id:uid(),home:null,away:null,hs:null,as:null,ot:false}] });
  if(c===2){ const [A,B]=gids; const A4=pad(topN(A,4),4), B4=pad(topN(B,4),4);
    return mk([{home:A4[0],away:B4[3]},{home:A4[1],away:B4[2]},{home:B4[0],away:A4[3]},{home:B4[1],away:A4[2]}]); }
  if(c===4){ const [A,B,C,D]=gids; const A2=pad(topN(A,2),2),B2=pad(topN(B,2),2),C2=pad(topN(C,2),2),D2=pad(topN(D,2),2);
    return mk([{home:A2[0],away:B2[1]},{home:B2[0],away:A2[1]},{home:C2[0],away:D2[1]},{home:D2[0],away:C2[1]}]); }
  if(c===6){
    const rank=(a,b)=> (b?.pts||0)-(a?.pts||0)||(b?.gd||0)-(a?.gd||0)||(b?.gf||0)-(a?.gf||0)||(a?.name||'').localeCompare(b?.name||'');
    const firsts=gids.map(g=>st[g][0]&&{...st[g][0],gid:g}).filter(Boolean);
    const seconds=gids.map(g=>st[g][1]&&{...st[g][1],gid:g}).filter(Boolean).sort(rank);
    const q=[...firsts, ...seconds.slice(0,2)]; while(q.length<8) q.push({teamId:null}); q.sort(rank); const s=q.map(x=>x.teamId??null);
    return mk([{home:s[0],away:s[7]},{home:s[1],away:s[6]},{home:s[2],away:s[5]},{home:s[3],away:s[4]}]);
  }
  const all=[]; for(const g of gids) all.push(...(st[g]||[])); all.sort((a,b)=> (b.pts-a.pts)||(b.gd-a.gd)||(b.gf-a.gf));
  const s=pad(all.slice(0,8).map(x=>x.teamId??null),8);
  return mk([{home:s[0],away:s[7]},{home:s[1],away:s[6]},{home:s[2],away:s[5]},{home:s[3],away:s[4]}]);
}
function nameOf(id,map){ return id ? (map[id]?.name||'?') : 'BYE' }
function pickWinner(m){ if(!m) return null; if(m.home&&!m.away) return m.home; if(!m.home&&m.away) return m.away;
  if(Number.isFinite(m.hs)&&Number.isFinite(m.as)){ if(m.hs>m.as) return m.home; if(m.as>m.hs) return m.away; } return null; }
function pickLoser(m){ const w=pickWinner(m); if(!w) return null; return w===m.home ? (m.away||null) : (m.home||null); }
function propagate(br){
  const wQF=br.qf.map(pickWinner);
  br.sf[0].home=wQF[0]; br.sf[0].away=wQF[3];
  br.sf[1].home=wQF[1]; br.sf[1].away=wQF[2];
  const wSF=br.sf.map(pickWinner), lSF=br.sf.map(pickLoser);
  br.fin[0].home=wSF[0]; br.fin[0].away=wSF[1];
  br.third[0].home=lSF[0]; br.third[0].away=lSF[1];
}

/* ===== Render helpers ===== */
function teamCell(map,id){ const lg=state.logos?.[id]; const img=lg?`<img class="logo" src="${lg}" alt="">`:''; return `<span class="row" style="gap:8px">${img}${nameOf(id,map)}</span>`; }
function teamCellLg(map,id){ const lg=state.logos?.[id]; const img=lg?`<img class="logo-lg" src="${lg}" alt="">`:''; return `<span class="row" style="gap:8px">${img}<span class="name">${nameOf(id,map)}</span></span>`; }

/* ===== GROUPS (summary + inline editor) ===== */
let editingGroupId=null;

function renderGroups(){
  const host=$('#groupsHost'); host.innerHTML='';
  const map=Object.fromEntries(state.teams.map(t=>[t.id,t]));
  state.groups.forEach(g=>{
    const card=document.createElement('div'); card.className='panel group-card'; card.dataset.gid=g.id;
    if(editingGroupId===g.id) card.classList.add('edit');

    const rounds=new Set(g.matches.map(m=>m.round)).size;
    const chips = g.teams.map(id=>{
      const lg=state.logos?.[id]; const nm=nameOf(id,map);
      return `<span class="chip-tag">${lg?`<img class="logo" src="${lg}" alt=""> `:''}${nm}</span>`;
    }).join('');

    const scored=g.matches.filter(isScored).length;
    const fixturesView=g.matches.map(m=>{
      const hs = Number.isFinite(m.hs)?m.hs:'â€“', as=Number.isFinite(m.as)?m.as:'â€“', ot = m.ot ? '<span class="ot">OT</span>' : '';
      return `<div class="fix-row view-mode"><span class="muted">R${m.round}</span>
        <span class="row" style="gap:6px">${state.logos?.[m.home]?`<img class="logo" src="${state.logos[m.home]}" alt="">`:''}${nameOf(m.home,map)}</span>
        <span class="score">${hs}:${as}</span>
        <span class="row" style="gap:6px;justify-self:end">${state.logos?.[m.away]?`<img class="logo" src="${state.logos[m.away]}" alt="">`:''}${nameOf(m.away,map)}</span>
        ${ot}</div>`;
    }).join('');

    const fixturesEdit=g.matches.map(m=>{
      return `<div class="fix-row edit-mode stop-prop"><span class="muted">R${m.round}</span>
        <span class="row" style="gap:6px">${state.logos?.[m.home]?`<img class="logo" src="${state.logos[m.home]}" alt="">`:''}${nameOf(m.home,map)}</span>
        <span class="row" style="gap:6px">
          <input class="score-in" type="number" min="0" value="${m.hs??''}" data-g="${g.id}" data-mid="${m.id}" data-side="hs"/>
          :
          <input class="score-in" type="number" min="0" value="${m.as??''}" data-g="${g.id}" data-mid="${m.id}" data-side="as"/>
        </span>
        <span class="row" style="gap:6px;justify-self:end">${state.logos?.[m.away]?`<img class="logo" src="${state.logos[m.away]}" alt="">`:''}${nameOf(m.away,map)}</span>
        <label class="chip"><input type="checkbox" ${m.ot?'checked':''} data-g="${g.id}" data-mid="${m.id}" data-ot="1"/> OT</label>
      </div>`;
    }).join('');

    card.innerHTML=`
      <h3>Grupa ${g.id}</h3>
      <div class="muted">${g.teams.length} komandas â€¢ ${rounds} kÄrtas</div>
      <div class="chips">${chips}</div>
      <div class="prog">${scored}/${g.matches.length} spÄ“les ievadÄ«tas</div>
      <div class="fixtures">${fixturesView}${fixturesEdit}</div>
      <div class="group-actions"><button class="btn btn--accent stop-prop" data-done="${g.id}">Done</button></div>
      <div class="muted" style="margin-top:6px">Nospied kartÄ«ti, lai ievadÄ«tu rezultÄtus</div>
    `;
    host.appendChild(card);
  });

  // Click to toggle expand (edit)
  $$('#groupsHost .group-card').forEach(el=>{
    el.addEventListener('click', (e)=>{
      const gid=el.dataset.gid;
      if(editingGroupId===gid){ editingGroupId=null; el.classList.remove('edit'); sfx.click(); }
      else { editingGroupId=gid; $$('#groupsHost .group-card.edit').forEach(x=>x.classList.remove('edit')); el.classList.add('edit'); sfx.click(); }
    });
  });
  // Stop bubbling on inputs
  $$('#groupsHost .stop-prop').forEach(el=> el.addEventListener('click', e=> e.stopPropagation()));

  // Done btn
  $$('[data-done]').forEach(btn=>{
    btn.addEventListener('click', (e)=>{ e.stopPropagation(); editingGroupId=null; renderGroups(); sfx.success(); });
  });

  // Input handlers
  $$('#groupsHost .score-in').forEach(inp=>{
    inp.addEventListener('change', ()=>{
      const gId=inp.dataset.g, mid=inp.dataset.mid, side=inp.dataset.side;
      const G=state.groups.find(x=>x.id===gId), M=G.matches.find(x=>x.id===mid);
      const v=inp.value===''?null:Math.max(0,parseInt(inp.value,10));
      M[side]=Number.isFinite(v)?v:null;
      if(Number.isFinite(M.hs)&&Number.isFinite(M.as)){ sfx.score(); if(M.hs===M.as){ alert('NeizÅ¡Ä·irtu nav. Ja bija OT, atzÄ«mÄ“ OT un ievadi uzvaras vÄrtus.'); } }
      state.standings=computeStandings(state.groups,Object.fromEntries(state.teams.map(t=>[t.id,t])));
      saveState(state); renderGroups(); renderStandings();
    });
  });
  $$('#groupsHost [data-ot]').forEach(box=>{
    box.addEventListener('change', ()=>{
      const gId=box.dataset.g, mid=box.dataset.mid;
      const G=state.groups.find(x=>x.id===gId), M=G.matches.find(x=>x.id===mid);
      M.ot=box.checked; sfx.click();
      if(Number.isFinite(M.hs)&&Number.isFinite(M.as)&&M.hs===M.as){ alert('NeizÅ¡Ä·irtu nav. OT gadÄ«jumÄ jÄbÅ«t uzvaras vÄrtiem.'); }
      state.standings=computeStandings(state.groups,Object.fromEntries(state.teams.map(t=>[t.id,t])));
      saveState(state); renderGroups(); renderStandings();
    });
  });

  $('#groupsPanel').hidden = state.groups.length===0;
}

/* ===== STANDINGS (fit screen, equal columns, no broken names) ===== */
function renderStandings(){
  const host=$('#standingsHost'); host.innerHTML='';
  const st=state.standings||{}; const gids=Object.keys(st).sort();
  const map=Object.fromEntries(state.teams.map(t=>[t.id,t]));
  gids.forEach(gid=>{
    const card=document.createElement('div'); card.className='panel';
    card.innerHTML=`<h3>Grupa ${gid} â€” StÄvÄ“jums</h3>`;
    const tbl=document.createElement('table'); tbl.className='standings-table';
    tbl.innerHTML=`<thead><tr><th>#</th><th>Komanda</th><th>Sp</th><th>U</th><th>Z</th><th>GF</th><th>GA</th><th>GD</th><th>P</th></tr></thead><tbody></tbody>`;
    const body=$('tbody',tbl);
    st[gid].forEach((r,i)=>{
      const logo = state.logos?.[r.teamId];
      const nameCell = `<span class="row" style="gap:8px"><span>${logo?`<img class="logo" src="${logo}" alt="">`:''}</span><span class="name-nowrap">${r.name}</span></span>`;
      const tr=document.createElement('tr');
      tr.innerHTML=`<td style="text-align:center">${i+1}</td>
        <td>${nameCell}</td>
        <td style="text-align:center">${r.played}</td><td style="text-align:center">${r.w}</td><td style="text-align:center">${r.l}</td>
        <td style="text-align:center">${r.gf}</td><td style="text-align:center">${r.ga}</td><td style="text-align:center">${r.gd}</td>
        <td style="text-align:center"><b>${r.pts}</b></td>`;
      body.appendChild(tr);
    });
    card.appendChild(tbl); host.appendChild(card);
  });
  $('#standingsPanel').hidden = gids.length===0;
}

/* ===== BRACKET ===== */
function winnerClass(m,side){
  if(m.home && !m.away) return side==='home'?'win':'';
  if(!m.home && m.away) return side==='away'?'win':'';
  if(Number.isFinite(m.hs)&&Number.isFinite(m.as)){
    if(m.hs>m.as && side==='home') return 'win';
    if(m.as>m.hs && side==='away') return 'win';
  } return '';
}
function renderBracket(){
  const map=Object.fromEntries(state.teams.map(t=>[t.id,t]));
  $('#qfCol').innerHTML='<h3>CeturtdaÄ¼finÄli</h3>';
  $('#sfCol').innerHTML='<h3>PusfinÄli</h3>';
  $('#finCol').innerHTML='<h3>FinÄls & 3. vieta</h3>';

  const mk=(m,stage,idx)=>{
    const el=document.createElement('div'); el.className='match';
    el.innerHTML=`
      <div class="status">${stage} ${idx!=null?('â€¢ '+(idx+1)):""}</div>
      <div class="team ${winnerClass(m,'home')}">
        <span class="seed">H</span>
        ${teamCellLg(map,m.home)}
        <input class="score-in" type="number" min="0" value="${m.hs??''}" data-stage="${stage}" data-id="${m.id}" data-side="hs" />
      </div>
      <div class="team ${winnerClass(m,'away')}" style="margin-top:8px">
        <span class="seed">A</span>
        ${teamCellLg(map,m.away)}
        <input class="score-in" type="number" min="0" value="${m.as??''}" data-stage="${stage}" data-id="${m.id}" data-side="as" />
      </div>
      <div class="row" style="margin-top:8px">
        <label class="chip"><input type="checkbox" ${m.ot?'checked':''} data-stage="${stage}" data-id="${m.id}" data-ot="flag" /> OT</label>
      </div>`;
    return el;
  };

  state.bracket.qf.forEach((m,i)=>$('#qfCol').appendChild(mk(m,'QF',i)));
  state.bracket.sf.forEach((m,i)=>$('#sfCol').appendChild(mk(m,'SF',i)));
  state.bracket.fin.forEach(m=>$('#finCol').appendChild(mk(m,'Final')));
  state.bracket.third.forEach(m=>$('#finCol').appendChild(mk(m,'3rd')));

  $$('.bracket .score-in').forEach(inp=>{
    inp.addEventListener('change', ()=>{
      const stage=inp.dataset.stage, id=inp.dataset.id, side=inp.dataset.side;
      const col=stage==='QF'?'qf':stage==='SF'?'sf':stage==='Final'?'fin':'third';
      const m=state.bracket[col].find(x=>x.id===id);
      const val=inp.value===''?null:Math.max(0,parseInt(inp.value,10));
      m[side]=Number.isFinite(val)?val:null;
      if(Number.isFinite(m.hs)&&Number.isFinite(m.as)){ sfx.score(); if(m.hs===m.as){ alert('NeizÅ¡Ä·irtu nav. Ja bija OT, atzÄ«mÄ“ OT un ievadi uzvaras vÄrtus.'); } }
      propagate(state.bracket); saveState(state); renderBracket(); refreshOverallButtons();
    });
  });
  $$('.bracket [data-ot]').forEach(el=>{
    el.addEventListener('change', ()=>{
      const stage=el.dataset.stage, id=el.dataset.id;
      const col=stage==='QF'?'qf':stage==='SF'?'sf':stage==='Final'?'fin':'third';
      const m=state.bracket[col].find(x=>x.id===id);
      m.ot=el.checked; sfx.click();
      if(Number.isFinite(m.hs)&&Number.isFinite(m.as)&&m.hs===m.as){ alert('NeizÅ¡Ä·irtu nav. OT gadÄ«jumÄ jÄbÅ«t uzvaras vÄrtiem.'); }
      propagate(state.bracket); saveState(state); renderBracket(); refreshOverallButtons();
    });
  });

  refreshOverallButtons();
}

/* ===== IMAGES ===== */
function renderBrandHeader(){ const img=$('#brandLogoImg'), dot=$('#brandDot');
  if(state.brandLogo){ img.src=state.brandLogo; img.style.display='inline-block'; dot.style.display='none'; } else { img.src=''; img.style.display='none'; dot.style.display='inline-block'; }
  $('#brandTitle').textContent = state.name || 'TurnÄ«ru AplikÄcija';
}
function renderBrandPanel(){ const prev=$('#brandLogoPreview'), ph=$('#brandLogoPlaceholder');
  if(state.brandLogo){ prev.src=state.brandLogo; prev.style.display='inline-block'; ph.style.display='none'; } else { prev.src=''; prev.style.display='none'; ph.style.display='inline-block'; } }
async function fileToDataURL(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); }); }
function renderLogosPanel(){
  const host=$('#logosHost'); host.innerHTML='';
  if(!state.teams?.length){ host.innerHTML='<div class="muted">Vispirms ievadi komandas.</div>'; return; }
  state.teams.forEach(t=>{
    const card=document.createElement('div'); card.className='panel';
    card.innerHTML=`
      <div class="row" style="justify-content:space-between;align-items:center">
        <div class="row" style="gap:10px">${state.logos[t.id]?`<img class="logo-lg" src="${state.logos[t.id]}" alt="">`:`<span class="logo-lg" style="background:#0000;border:1px dashed var(--border)"></span>`}
          <div style="font-weight:600">${t.name}</div></div>
        <div class="row"><input type="file" accept="image/*" data-team="${t.id}" class="logoIn"/><button class="btn" data-clear="${t.id}">NoÅ†emt</button></div>
      </div>`;
    host.appendChild(card);
  });
  $$('.logoIn').forEach(inp=>inp.addEventListener('change', async ()=>{
    const f=inp.files?.[0]; if(!f) return; const id=inp.dataset.team; const url=await fileToDataURL(f);
    state.logos[id]=url; saveState(state); sfx.success(); renderLogosPanel(); renderGroups(); renderStandings(); if(state.bracket) renderBracket();
  }));
  $$('[data-clear]').forEach(btn=>btn.addEventListener('click', ()=>{ delete state.logos[btn.dataset.clear]; saveState(state); renderLogosPanel(); renderGroups(); renderStandings(); if(state.bracket) renderBracket(); }));
}
$('#imagesToggleBtn').addEventListener('click', ()=>{ const el=$('#imagesPanel'); el.hidden=!el.hidden; if(!el.hidden){ renderBrandPanel(); renderLogosPanel(); sfx.click(); } });
$('#brandLogoInput').addEventListener('change', async ()=>{ const f=$('#brandLogoInput').files?.[0]; if(!f) return; state.brandLogo=await fileToDataURL(f); saveState(state); renderBrandHeader(); renderBrandPanel(); sfx.success(); });
$('#clearBrandLogo').addEventListener('click', ()=>{ state.brandLogo=null; saveState(state); renderBrandHeader(); renderBrandPanel(); sfx.click(); });

/* ===== Overall / Awards (use same non-breaking names) ===== */
function tournamentFinished(){ if(!state.bracket) return false; const fin=state.bracket.fin[0], third=state.bracket.third[0]; return !!(pickWinner(fin)&&pickWinner(third)); }
function refreshOverallButtons(){ const ready=tournamentFinished(); $('#overallBtn').disabled=!ready; $('#downloadPdfBtn').disabled=!(ready&&state.overall); }
$('#overallBtn').addEventListener('click', ()=>{
  if(!tournamentFinished()){ alert('Kopsavilkums pieejams pÄ“c finÄla un 3. vietas spÄ“les.'); return; }
  state.overall=computeOverall(); saveState(state); renderOverall(state.overall);
  $('#statsPanel').hidden=false; $('#downloadPdfBtn').disabled=false; sfx.success();
});
function computeOverall(){
  const map=Object.fromEntries(state.teams.map(t=>[t.id,t.name])), ids=Object.keys(map);
  const stats=Object.fromEntries(ids.map(id=>[id,{teamId:id,name:map[id],played:0,wins:0,losses:0,gf:0,ga:0}]));
  const apply=m=>{ if(!m||!m.home||!m.away) return; if(!isScored(m)) return;
    const hs=m.hs, as=m.as, H=stats[m.home], A=stats[m.away];
    H.played++; A.played++; H.gf+=hs; H.ga+=as; A.gf+=as; A.ga+=hs; if(hs>as){H.wins++;A.losses++;} else {A.wins++;H.losses++;} };
  for(const g of state.groups) for(const m of g.matches) apply(m);
  if(state.bracket) [...state.bracket.qf,...state.bracket.sf,...state.bracket.fin,...state.bracket.third].forEach(apply);
  const arr=Object.values(stats); const maxGF=Math.max(...arr.map(s=>s.gf)), maxGA=Math.max(...arr.map(s=>s.ga));
  const topGF=arr.filter(s=>s.gf===maxGF).map(s=>s.name), topGA=arr.filter(s=>s.ga===maxGA).map(s=>s.name);
  const winId=state.bracket?pickWinner(state.bracket.fin[0]):null, winName=winId?map[winId]:'â€”';
  return { winnerName:winName, topGF, maxGF, topGA, maxGA, teamStats: arr.sort((a,b)=> (b.wins-a.wins) || ((b.gf-b.ga)-(a.gf-a.ga)) || (b.gf-a.gf) || a.name.localeCompare(b.name)) };
}
function renderOverall(o){
  const awards=$('#awards'); awards.innerHTML='';
  const card=(t,c)=>{ const d=document.createElement('div'); d.className='panel'; d.innerHTML=`<div class="muted">${t}</div><div style="font-weight:700;font-size:16px;margin-top:6px">${c}</div>`; return d; };
  awards.appendChild(card('TurnÄ«ra uzvarÄ“tÄjs', o.winnerName));
  awards.appendChild(card('VisvairÄk gÅ«tie vÄrti', `${o.topGF.join(', ')} (${o.maxGF})`));
  awards.appendChild(card('VisvairÄk ielaistie vÄrti', `${o.topGA.join(', ')} (${o.maxGA})`));

  const host=$('#teamStatsHost'); const tbl=document.createElement('table'); tbl.className='standings-table';
  tbl.innerHTML=`<thead><tr><th>Komanda</th><th>Sp</th><th>U</th><th>Z</th><th>GF</th><th>GA</th><th>GD</th></tr></thead><tbody></tbody>`;
  const body=$('tbody',tbl);
  o.teamStats.forEach(s=>{
    const logo=state.logos?.[s.teamId]; const nameCell=`<span class="row" style="gap:8px">${logo?`<img class="logo" src="${logo}" alt="">`:''}<span class="name-nowrap">${s.name}</span></span>`;
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${nameCell}</td><td style="text-align:center">${s.played}</td><td style="text-align:center">${s.wins}</td><td style="text-align:center">${s.losses}</td>
      <td style="text-align:center">${s.gf}</td><td style="text-align:center">${s.ga}</td><td style="text-align:center">${s.gf-s.ga}</td>`;
    body.appendChild(tr);
  });
  host.innerHTML=''; host.appendChild(tbl);
}

/* ===== PDF ===== */
$('#downloadPdfBtn').addEventListener('click', ()=>{
  if(!state.overall){ alert('Vispirms Ä£enerÄ“ kopsavilkumu.'); return; }
  try{
    const { jsPDF } = window.jspdf; const doc=new jsPDF({unit:'pt',format:'a4'});
    const margin=36, lineH=18, pageW=doc.internal.pageSize.getWidth();
    if(state.brandLogo){ try{ doc.addImage(state.brandLogo,'PNG', margin, 30, 32, 32, undefined, 'FAST'); }catch{} }
    const title = state.name ? `TurnÄ«ra kopsavilkums â€” ${state.name}` : 'TurnÄ«ra kopsavilkums';
    doc.setFont('helvetica','bold'); doc.setFontSize(18); doc.text(title, margin+48, 52);
    doc.setFont('helvetica','normal'); doc.setFontSize(11); doc.text(`Datums: ${todayStamp()}`, pageW - margin - 140, 52);

    const y0=78;
    doc.text(`UzvarÄ“tÄjs: ${state.overall.winnerName}`, margin, y0);
    doc.text(`VisvairÄk gÅ«tie vÄrti: ${state.overall.topGF.join(', ')} (${state.overall.maxGF})`, margin, y0+lineH);
    doc.text(`VisvairÄk ielaistie vÄrti: ${state.overall.topGA.join(', ')} (${state.overall.maxGA})`, margin, y0+lineH*2);

    const rows = state.overall.teamStats.map(s=>({ name:s.name, logo: state.logos?.[s.teamId]||null, Sp:s.played, U:s.wins, Z:s.losses, GF:s.gf, GA:s.ga, GD:(s.gf-s.ga) }));
    doc.autoTable({
      startY: y0+lineH*3+10,
      head: [['', 'Komanda','Sp','U','Z','GF','GA','GD']],
      body: rows.map(r=>['', r.name, r.Sp, r.U, r.Z, r.GF, r.GA, r.GD]),
      styles:{font:'helvetica',fontSize:10,cellPadding:4},
      headStyles:{fillColor:[124,92,255],textColor:255},
      alternateRowStyles:{fillColor:[245,245,248]},
      margin:{left:margin,right:margin},
      didDrawCell:(data)=>{
        if(data.section==='body' && data.column.index===0){
          const rowIdx=data.row.index, lg=rows[rowIdx].logo;
          if(lg){ const x=data.cell.x+6, y=data.cell.y+6, size=14; try{ doc.addImage(lg,'PNG',x,y,size,size,undefined,'FAST'); }catch{} }
        }
        if(data.section==='head' && data.column.index===0){ doc.setFontSize(9); doc.text('Logo', data.cell.x+6, data.cell.y+11); }
      },
      willDrawCell:(data)=>{ if(data.column.index===0) data.cell.styles.cellPadding={top:4,right:4,bottom:4,left:24}; }
    });

    const fname=`${slugify(state.name)}_${todayStamp()}_kopsavilkums.pdf`; doc.save(fname); sfx.success();
  }catch(e){ alert('NeizdevÄs Ä£enerÄ“t PDF.'); }
});

/* ===== UI helpers ===== */
function updateGroupOptions(){
  const n = ($('#teamsInput').value.split('\n').map(s=>s.trim()).filter(Boolean)).length;
  const optN1=$('#groupStrategy').querySelector('option[value="n1"]');
  if(n>6){ optN1.disabled=true; optN1.title='1 grupa atÄ¼auta tikai ja â‰¤6 komandas'; } else { optN1.disabled=false; optN1.title=''; }
}

/* ===== Hook up ===== */
$('#teamsInput').addEventListener('input', updateGroupOptions);
$('#genGroups').addEventListener('click', ()=>{
  const name=$('#tName').value.trim();
  const teamNames=$('#teamsInput').value.split('\n').map(s=>s.trim()).filter(Boolean);
  if(teamNames.length<2){ alert('Ievadi vismaz 2 komandas.'); return; }
  if($('#groupStrategy').value==='n1' && teamNames.length>6){
    alert('â€œ1 grupaâ€ atÄ¼auta tikai, ja â‰¤6 komandas. PÄrslÄ“dzu uz automÄtisku (2/4/6).');
    $('#groupStrategy').value='auto';
  }
  const teams=teamNames.map(n=>({id:uid(),name:n}));
  state={...state,name,teams,groups:makeGroups(teams,$('#groupStrategy').value), standings:{}, bracket:null, overall:null, logos:{}};
  state.standings=computeStandings(state.groups,Object.fromEntries(teams.map(t=>[t.id,t])));
  saveState(state); renderBrandHeader(); updateGroupOptions(); renderGroups(); renderStandings();
  $('#playoffPanel').hidden=false; $('#groupsPanel').hidden=false; $('#standingsPanel').hidden=false; $('#statsPanel').hidden=true; $('#downloadPdfBtn').disabled=true;
  sfx.success();
});

$('#buildBracket').addEventListener('click', ()=>{
  if(!state.groups.length){ alert('Vispirms jÄievada grupu dati.'); return; }
  state.standings=computeStandings(state.groups,Object.fromEntries(state.teams.map(t=>[t.id,t])));
  state.bracket=buildBracketFromStandings(state.standings); propagate(state.bracket);
  state.overall=null; saveState(state); renderBracket(); $('#statsPanel').hidden=true; $('#downloadPdfBtn').disabled=true; sfx.success();
});

$('#exportBtn').addEventListener('click', ()=>{
  const data='data:application/json;charset=utf-8,'+encodeURIComponent(JSON.stringify(state,null,2));
  const a=document.createElement('a'); a.href=data; a.download=(slugify(state.name)||'tournament')+'.json'; a.click(); sfx.click();
});
$('#importBtn').addEventListener('click', async ()=>{
  const inp=document.createElement('input'); inp.type='file'; inp.accept='application/json';
  inp.onchange=async ()=>{
    const f=inp.files[0]; if(!f) return;
    try{
      const txt=await f.text(); const obj=JSON.parse(txt);
      state=Object.assign({name:'',teams:[],logos:{},brandLogo:null,groups:[],standings:{},bracket:null,overall:null},obj);
      saveState(state);
      $('#tName').value=state.name||''; $('#teamsInput').value=(state.teams||[]).map(t=>t.name).join('\n');
      renderBrandHeader(); if(state.groups?.length){ renderGroups(); $('#groupsPanel').hidden=false }
      if(state.standings && Object.keys(state.standings).length){ renderStandings(); $('#standingsPanel').hidden=false }
      if(state.bracket){ renderBracket(); $('#playoffPanel').hidden=false }
      if(state.overall){ renderOverall(state.overall); $('#statsPanel').hidden=false; $('#downloadPdfBtn').disabled=false }
      updateGroupOptions(); sfx.success();
    }catch{ alert('NeizdevÄs importÄ“t.'); }
  };
  inp.click();
});
$('#resetBtn').addEventListener('click', ()=>{
  if(!confirm('TieÅ¡Äm notÄ«rÄ«t turnÄ«ru?')) return;
  clearState(); state={name:'',teams:[],logos:{},brandLogo:null,groups:[],standings:{},bracket:null,overall:null};
  $('#tName').value=''; $('#teamsInput').value=''; renderBrandHeader();
  $('#groupsHost').innerHTML=''; $('#standingsHost').innerHTML=''; $('#qfCol').innerHTML='<h3>CeturtdaÄ¼finÄli</h3>'; $('#sfCol').innerHTML='<h3>PusfinÄli</h3>'; $('#finCol').innerHTML='<h3>FinÄls & 3. vieta</h3>';
  $('#groupsPanel').hidden=true; $('#standingsPanel').hidden=true; $('#playoffPanel').hidden=true; $('#statsPanel').hidden=true; $('#downloadPdfBtn').disabled=true; $('#overallBtn').disabled=true;
  sfx.click();
});

/* ===== Restore ===== */
(function boot(){
  $('#soundIcon').textContent = soundOn ? 'ğŸ”Š' : 'ğŸ”‡';
  const saved=loadState();
  if(saved){
    state=Object.assign(state,saved);
    $('#tName').value=state.name||''; $('#teamsInput').value=(state.teams||[]).map(t=>t.name).join('\n');
    renderBrandHeader(); if(state.groups?.length){ renderGroups(); $('#groupsPanel').hidden=false }
    if(state.standings && Object.keys(state.standings).length){ renderStandings(); $('#standingsPanel').hidden=false }
    if(state.bracket){ renderBracket(); $('#playoffPanel').hidden=false }
    if(state.overall){ renderOverall(state.overall); $('#statsPanel').hidden=false; $('#downloadPdfBtn').disabled=false }
  }
  updateGroupOptions();
})();
</script>
</body>
</html>