.cal col.c-team{width:calc((100% - var(--cal-w-r) - var(--cal-w-score) - var(--cal-w-ot)) / 2)}
  .cal thead th{position:sticky;top:0;background:color-mix(in oklab, var(--card) 98%, transparent);backdrop-filter:blur(6px);border-bottom:1px solid var(--border);z-index:1}
  .cal tbody tr{background:transparent;border-bottom:1px dashed var(--border)}
  .cal th,.cal td{padding:10px 12px}
  .cal th.r,.cal td.r{text-align:center}
  .cal .name-nowrap{display:block;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .cal th.score,.cal td.score{text-align:center}
  .score-grid{display:inline-grid;grid-template-columns:1fr auto 1fr;gap:6px;align-items:center}
  .colon{opacity:.7}
  .row-done{background:linear-gradient(180deg, color-mix(in oklab, var(--ok) 12%, transparent), transparent)}

  /* compact checkbox */
  .chk{appearance:none;width:16px;height:16px;border:1px solid var(--border);border-radius:4px;background:rgba(255,255,255,.02);display:inline-block;position:relative;vertical-align:middle}
  .chk:checked{background:linear-gradient(135deg,var(--accent),var(--accent2));border-color:transparent}
  .chk:checked::after{content:'âœ“';position:absolute;inset:0;font-size:12px;color:#fff;display:flex;align-items:center;justify-content:center}
</style>
</head>
<body>
<header>
  <div class="bar">
    <div class="brand">
      <span class="dot"></span>
      <span id="brandTitle">TurnÄ«ru AplikÄcija</span>
    </div>
    <div class="row">
      <button type="button" class="btn" id="exportBtn">EksportÄ“t</button>
      <button type="button" class="btn" id="importBtn">ImportÄ“t</button>
      <button type="button" class="btn" id="resetBtn">NotÄ«rÄ«t</button>
      <button type="button" class="btn" id="soundBtn"><span id="soundIcon">ğŸ”Š</span></button>
    </div>
  </div>
</header>

<main class="wrap">
  <!-- SETUP -->
  <section class="panel" id="setupPanel">
    <div class="row" style="justify-content:space-between">
      <h2>1) Ievadi komandas</h2>
      <div class="muted">Dati glabÄjas lokÄli (localStorage)</div>
      <div class="muted">Dati glabÄjas Google Sheets (automÄtiski)</div>
    </div>

    <div class="row" style="gap:var(--space); align-items:flex-start">
      <div style="flex:2; min-width:260px">
        <input id="tName" placeholder="TurnÄ«ra nosaukums (neobligÄts)"/>
        <div style="height:10px"></div>
        <textarea id="teamsInput" placeholder="Katru komandu jaunÄ rindÄ..."></textarea>
      </div>
      <div style="flex:1; min-width:240px">
        <label class="muted" for="groupStrategy">Grupu skaits</label>
        <select id="groupStrategy">
          <option value="auto" selected>AutomÄtiski (2/4/6; â‰¤6 â†’ 1 grupa)</option>
          <option value="n1">1 grupa (tikai ja â‰¤6 kom.)</option>
          <option value="n2">2 grupas</option>
          <option value="n4">4 grupas</option>
          <option value="n6">6 grupas</option>
        </select>
        <div style="height:10px"></div>
        <button type="button" class="btn btn--accent" id="genGroups" style="width:100%">Ä¢enerÄ“t grupas</button>
      </div>
    </div>
  </section>

  <!-- GROUPS (preview with results) -->
  <section class="panel" id="groupsPanel" hidden>
@@ -255,73 +253,131 @@
    <div class="sheet-title" id="sheetTitle">KalendÄrs</div>
    <div class="row"><button type="button" class="btn" id="closeSheetBtn" aria-label="AizvÄ“rt">âœ•</button></div>
  </div>
  <div class="sheet-body">
    <div class="cal-wrap">
      <table class="cal tnum" id="calTable"></table>
    </div>
  </div>
  <div class="sheet-foot">
    <button type="button" class="btn btn--accent" id="sheetDoneBtn">Done</button>
  </div>
</div>

<!-- PDF libs -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js" crossorigin="anonymous"></script>

<script>
/* ===== Util ===== */
const $=(s,r=document)=>r.querySelector(s), $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
const uid=()=>Math.random().toString(36).slice(2,9);
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a}
const todayStamp = ()=> new Date().toISOString().slice(0,10);
const slugify = s => (s||'').toLowerCase().normalize('NFKD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'').slice(0,80)||'tournament';

/* ===== Storage ===== */
/* ===== Storage & Sync ===== */
const STORAGE_KEY='tournament_state_pro_v12';
function saveState(s){ localStorage.setItem(STORAGE_KEY, JSON.stringify(s)); }
const API_URL='https://script.google.com/macros/s/AKfycbwg3SEvNLtrI7zxouy9HMdyDKwy5qnMBgvRNgEhG37oFXVCn04vHmFUfjA24DXbDDww7w/exec';
let currentTournamentName='';
let saveTimer=null;
let loadingName=null;

function createEmptyState(name=''){ return { name, teams:[], groups:[], standings:{}, bracket:null, overall:null }; }

function saveState(s,{skipRemote=false}={}){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(s));
  if(!skipRemote) scheduleRemoteSave();
}
function loadState(){ try{return JSON.parse(localStorage.getItem(STORAGE_KEY)||'null')}catch{return null} }
function clearState(){ localStorage.removeItem(STORAGE_KEY); }
const SOUND_PREF_KEY='tournament_sound_on';

async function apiRequest(payload){
  const res=await fetch(API_URL,{method:'POST',headers:{'Content-Type':'text/plain;charset=utf-8'},body:JSON.stringify(payload)});
  if(!res.ok) throw new Error(`HTTP ${res.status}`);
  const data=await res.json();
  if(data?.status!=='ok') throw new Error(data?.message||'NezinÄma API kÄ¼Å«da');
  return data;
}

function scheduleRemoteSave(){
  if(!state?.name) return;
  currentTournamentName=state.name;
  if(saveTimer) clearTimeout(saveTimer);
  saveTimer=setTimeout(()=>{
    saveTimer=null;
    pushStateToRemote().catch(err=>console.error('NeizdevÄs saglabÄt datus Google Sheets',err));
  },300);
}

async function pushStateToRemote(){
  if(!state?.name) return;
  await apiRequest({action:'save',name:state.name,state});
}

async function loadTournamentByName(name,{silent=false}={}){
  const trimmed=(name||'').trim();
  if(!trimmed) return;
  if(loadingName===trimmed) return;
  loadingName=trimmed;
  try{
    const res=await apiRequest({action:'loadOrCreate',name:trimmed});
    let nextState;
    if(res.exists && res.state){
      nextState=Object.assign(createEmptyState(trimmed),res.state,{name:trimmed});
      applyState(nextState,{skipRemote:true});
    }else{
      nextState=createEmptyState(trimmed);
      applyState(nextState);
    }
    currentTournamentName=trimmed;
    if(!silent) sfx.success();
  }catch(err){
    console.error(err);
    if(!silent) alert('NeizdevÄs pieslÄ“gties Google Sheets. PÄrbaudi savienojumu un mÄ“Ä£ini vÄ“lreiz.');
  }finally{
    if(loadingName===trimmed) loadingName=null;
  }
}

/* ===== Sounds ===== */
let audioCtx=null; let soundOn=(localStorage.getItem(SOUND_PREF_KEY)!=='0');
const ensureCtx=()=>{ if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)() };
function beep({freq=440,type='sine',dur=0.08,gain=0.05,a=0.005,r=0.06}={}){ if(!soundOn) return; ensureCtx();
  const now=audioCtx.currentTime, o=audioCtx.createOscillator(), g=audioCtx.createGain();
  o.type=type; o.frequency.setValueAtTime(freq,now); g.gain.setValueAtTime(0,now);
  g.gain.linearRampToValueAtTime(gain,now+a); g.gain.exponentialRampToValueAtTime(0.0001,now+a+dur+r);
  o.connect(g); g.connect(audioCtx.destination); o.start(now); o.stop(now+a+dur+r+0.02);
}
const sfx={ click:()=>beep({freq:280,type:'triangle',dur:0.05,gain:0.06}),
            score:()=>{beep({freq:420,type:'square',dur:0.06,gain:0.06}); setTimeout(()=>beep({freq:590,type:'square',dur:0.06,gain:0.05}),70)},
            success:()=>{beep({freq:450,type:'sine',dur:0.07,gain:0.06}); setTimeout(()=>beep({freq:650,type:'sine',dur:0.09,gain:0.05}),90)} };
$('#soundBtn').addEventListener('click',()=>{ soundOn=!soundOn; localStorage.setItem(SOUND_PREF_KEY,soundOn?'1':'0'); $('#soundIcon').textContent=soundOn?'ğŸ”Š':'ğŸ”‡'; sfx.click(); });

/* ===== State ===== */
let state={ name:'', teams:[], groups:[], standings:{}, bracket:null, overall:null };
let state=createEmptyState();

/* ===== Grouping / fixtures ===== */
function deriveGroupCount(n,str){
  // AtÄ¼auts: 2,4,6; ja â‰¤6 komandas â†’ drÄ«kst 1 grupa
  const allowed=[2,4,6];
  if(str==='n1') return (n<=6)?1:deriveGroupCount(n,'auto');
  if(str==='auto' && n<=6) return Math.min(1,n);
  if(str?.startsWith('n')){ const req=+str.slice(1); if(req===1 && n<=6) return 1; if(allowed.includes(req)) return Math.min(req,n); }
  if(n<=6) return 1;
  const target=Math.round(n/4); let best=2; for(const k of allowed){ if(k>n) continue; const dK=Math.abs(k-target), dB=Math.abs(best-target); if(dK<dB||(dK===dB&&k>best)) best=k; } return best;
}
function makeGroups(teams,str='auto'){
  const n=teams.length; if(n<2) return [];
  const gCount=deriveGroupCount(n,str), shuffled=shuffle([...teams]);
  const groups=Array.from({length:gCount},(_,i)=>({id:String.fromCharCode(65+i),teams:[],matches:[]}));
  shuffled.forEach((t,i)=>groups[i%gCount].teams.push(t.id));
  groups.forEach(g=>{ g.matches=generateRR(g.teams).map(m=>({id:uid(),round:m.round,home:m.home,away:m.away,hs:null,as:null,ot:false})); });
  return groups;
}
function generateRR(teamIds){
  const t=[...teamIds]; if(t.length%2===1) t.push(null);
  const n=t.length, rounds=n-1, half=n/2, fx=[];
  for(let r=0;r<rounds;r++){
    for(let i=0;i<half;i++){ const a=t[i], b=t[n-1-i]; if(a!==null && b!==null){ const swap=(r%2===0)===(i%2===0); fx.push({round:r+1,home:swap?a:b,away:swap?b:a}); } }
    const fixed=t[0], rest=t.slice(1); rest.unshift(rest.pop()); t.splice(0,t.length,fixed,...rest);
@@ -644,109 +700,136 @@ $('#downloadPdfBtn').addEventListener('click', ()=>{
  try{
    const { jsPDF } = window.jspdf; const doc=new jsPDF({unit:'pt',format:'a4'});
    const margin=36, lineH=18, pageW=doc.internal.pageSize.getWidth();
    const title = state.name ? `TurnÄ«ra kopsavilkums â€” ${state.name}` : 'TurnÄ«ra kopsavilkums';
    doc.setFont('helvetica','bold'); doc.setFontSize(18); doc.text(title, margin, 52);
    doc.setFont('helvetica','normal'); doc.setFontSize(11); doc.text(`Datums: ${todayStamp()}`, pageW - margin - 140, 52);
    const y0=78;
    doc.text(`UzvarÄ“tÄjs: ${state.overall.winnerName}`, margin, y0);
    doc.text(`VisvairÄk gÅ«tie vÄrti: ${state.overall.topGF.join(', ')} (${state.overall.maxGF})`, margin, y0+lineH);
    doc.text(`VisvairÄk ielaistie vÄrti: ${state.overall.topGA.join(', ')} (${state.overall.maxGA})`, margin, y0+lineH*2);
    const rows = state.overall.teamStats.map(s=>({ name:s.name, Sp:s.played, U:s.wins, Z:s.losses, GF:s.gf, GA:s.ga, GD:(s.gf-s.ga) }));
    doc.autoTable({
      startY: y0+lineH*3+10,
      head: [['Komanda','Sp','U','Z','GF','GA','GD']],
      body: rows.map(r=>[r.name, r.Sp, r.U, r.Z, r.GF, r.GA, r.GD]),
      styles:{font:'helvetica',fontSize:10,cellPadding:4},
      headStyles:{fillColor:[124,92,255],textColor:255},
      alternateRowStyles:{fillColor:[245,245,248]},
      margin:{left:margin,right:margin}
    });
    const fname=`${slugify(state.name)}_${todayStamp()}_kopsavilkums.pdf`; doc.save(fname); sfx.success();
  }catch(e){ alert('NeizdevÄs Ä£enerÄ“t PDF.'); }
});

/* ===== UI helpers & hooks ===== */
function applyState(nextState,{skipRemote=false}={}){
  if(saveTimer){ clearTimeout(saveTimer); saveTimer=null; }
  const incoming=nextState||{};
  state=Object.assign(createEmptyState(incoming.name||''), incoming);
  currentTournamentName=state.name||'';

  if(state.groups?.length && (!state.standings || !Object.keys(state.standings).length)){
    const map=Object.fromEntries((state.teams||[]).map(t=>[t.id,t]));
    state.standings=computeStandings(state.groups,map);
  }

  $('#tName').value=state.name||'';
  $('#teamsInput').value=(state.teams||[]).map(t=>t.name).join('\n');
  $('#brandTitle').textContent = state.name || 'TurnÄ«ru AplikÄcija';

  updateGroupOptions();
  renderGroups();
  renderStandings();
  renderBracket();

  $('#playoffPanel').hidden = state.groups.length===0 && !state.bracket;

  if(state.overall){
    renderOverall(state.overall);
    $('#statsPanel').hidden=false;
    $('#downloadPdfBtn').disabled=false;
  }else{
    $('#awards').innerHTML='';
    $('#teamStatsHost').innerHTML='';
    $('#statsPanel').hidden=true;
    $('#downloadPdfBtn').disabled=true;
  }

  refreshOverallButtons();
  saveState(state,{skipRemote});
}

function updateGroupOptions(){
  const n = ($('#teamsInput').value.split('\n').map(s=>s.trim()).filter(Boolean)).length;
  const optN1=$('#groupStrategy').querySelector('option[value="n1"]');
  if(n>6){ optN1.disabled=true; optN1.title='1 grupa atÄ¼auta tikai ja â‰¤6 komandas'; } else { optN1.disabled=false; optN1.title=''; }
}
$('#teamsInput').addEventListener('input', updateGroupOptions);

$('#genGroups').addEventListener('click', ()=>{
async function handleTournamentNameChange(){
  const name=$('#tName').value.trim();
  if(!name){
    currentTournamentName='';
    applyState(createEmptyState(),{skipRemote:true});
    return;
  }
  await loadTournamentByName(name);
}
$('#tName').addEventListener('change', ()=>{ handleTournamentNameChange(); });
$('#tName').addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); e.target.blur(); }});

$('#genGroups').addEventListener('click', async ()=>{
  const name=$('#tName').value.trim();
  const teamNames=$('#teamsInput').value.split('\n').map(s=>s.trim()).filter(Boolean);
  if(!name){ alert('Ievadi turnÄ«ra nosaukumu, lai saglabÄtu datus Google Sheets.'); $('#tName').focus(); return; }
  if(teamNames.length<2){ alert('Ievadi vismaz 2 komandas.'); return; }
  if($('#groupStrategy').value==='n1' && teamNames.length>6){
    alert('â€œ1 grupaâ€ atÄ¼auta tikai, ja â‰¤6 komandas. PÄrslÄ“dzu uz automÄtisku (2/4/6).');
    $('#groupStrategy').value='auto';
  }
  if(state.name!==name){ await loadTournamentByName(name,{silent:true}); }
  const teams=teamNames.map(n=>({id:uid(),name:n}));
  state={...state,name,teams,groups:makeGroups(teams,$('#groupStrategy').value), standings:{}, bracket:null, overall:null};
  state.standings=computeStandings(state.groups,Object.fromEntries(teams.map(t=>[t.id,t])));
  saveState(state); $('#brandTitle').textContent = state.name || 'TurnÄ«ru AplikÄcija';
  updateGroupOptions(); renderGroups(); renderStandings();
  $('#playoffPanel').hidden=false; $('#groupsPanel').hidden=false; $('#standingsPanel').hidden=false; $('#statsPanel').hidden=true; $('#downloadPdfBtn').disabled=true;
  const nextState={...state,name,teams,groups:makeGroups(teams,$('#groupStrategy').value), standings:{}, bracket:null, overall:null};
  nextState.standings=computeStandings(nextState.groups,Object.fromEntries(teams.map(t=>[t.id,t])));
  applyState(nextState);
  sfx.success();
});

$('#buildBracket').addEventListener('click', ()=>{
  if(!state.groups.length){ alert('Vispirms jÄievada grupu dati.'); return; }
  state.standings=computeStandings(state.groups,Object.fromEntries(state.teams.map(t=>[t.id,t])));
  state.bracket=buildBracketFromStandings(state.standings); propagate(state.bracket);
  state.overall=null; saveState(state); renderBracket(); $('#statsPanel').hidden=true; $('#downloadPdfBtn').disabled=true; sfx.success();
});

$('#exportBtn').addEventListener('click', ()=>{
  const data='data:application/json;charset=utf-8,'+encodeURIComponent(JSON.stringify(state,null,2));
  const a=document.createElement('a'); a.href=data; a.download=(slugify(state.name)||'tournament')+'.json'; a.click(); sfx.click();
});

$('#importBtn').addEventListener('click', async ()=>{
  const inp=document.createElement('input'); inp.type='file'; inp.accept='application/json';
  inp.onchange=async ()=>{
    const f=inp.files[0]; if(!f) return;
    try{
      const txt=await f.text(); const obj=JSON.parse(txt);
      state=Object.assign({name:'',teams:[],groups:[],standings:{},bracket:null,overall:null},obj);
      saveState(state);
      $('#tName').value=state.name||''; $('#teamsInput').value=(state.teams||[]).map(t=>t.name).join('\n');
      $('#brandTitle').textContent = state.name || 'TurnÄ«ru AplikÄcija';
      if(state.groups?.length){ renderGroups(); $('#groupsPanel').hidden=false }
      if(state.standings && Object.keys(state.standings).length){ renderStandings(); $('#standingsPanel').hidden=false }
      if(state.bracket){ renderBracket(); $('#playoffPanel').hidden=false }
      if(state.overall){ renderOverall(state.overall); $('#statsPanel').hidden=false; $('#downloadPdfBtn').disabled=false }
      updateGroupOptions(); sfx.success();
    }catch{ alert('NeizdevÄs importÄ“t.'); }
  };
  inp.click();
});

$('#resetBtn').addEventListener('click', ()=>{
$('#resetBtn').addEventListener('click', async ()=>{
  if(!confirm('TieÅ¡Äm notÄ«rÄ«t turnÄ«ru?')) return;
  clearState(); state={name:'',teams:[],groups:[],standings:{},bracket:null,overall:null};
  $('#tName').value=''; $('#teamsInput').value=''; $('#brandTitle').textContent='TurnÄ«ru AplikÄcija';
  $('#groupsHost').innerHTML=''; $('#standingsHost').innerHTML='';
  $('#qfCol').innerHTML='<h3>CeturtdaÄ¼finÄli</h3>'; $('#sfCol').innerHTML='<h3>PusfinÄli</h3>'; $('#finCol').innerHTML='<h3>FinÄls & 3. vieta</h3>';
  $('#groupsPanel').hidden=true; $('#standingsPanel').hidden=true; $('#playoffPanel').hidden=true; $('#statsPanel').hidden=true; $('#downloadPdfBtn').disabled=true; $('#overallBtn').disabled=true;
  const prevName=state.name;
  if(saveTimer){ clearTimeout(saveTimer); saveTimer=null; }
  currentTournamentName='';
  if(prevName){
    try{
      await apiRequest({action:'save',name:prevName,state:createEmptyState(prevName)});
    }catch(err){ console.error('NeizdevÄs iztÄ«rÄ«t datus Google Sheets',err); }
  }
  applyState(createEmptyState(),{skipRemote:true});
  clearState();
  sfx.click();
});

/* ===== Restore ===== */
(function boot(){
  $('#soundIcon').textContent = soundOn ? 'ğŸ”Š' : 'ğŸ”‡';
  const saved=loadState();
  if(saved){
    state=Object.assign(state,saved);
    $('#tName').value=state.name||''; $('#teamsInput').value=(state.teams||[]).map(t=>t.name).join('\n');
    $('#brandTitle').textContent = state.name || 'TurnÄ«ru AplikÄcija';
    if(state.groups?.length){ renderGroups(); $('#groupsPanel').hidden=false }
    if(state.standings && Object.keys(state.standings).length){ renderStandings(); $('#standingsPanel').hidden=false }
    if(state.bracket){ renderBracket(); $('#playoffPanel').hidden=false }
    if(state.overall){ renderOverall(state.overall); $('#statsPanel').hidden=false; $('#downloadPdfBtn').disabled=false }
    applyState(saved,{skipRemote:true});
  }else{
    applyState(createEmptyState(),{skipRemote:true});
  }
  if(state.name){
    loadTournamentByName(state.name,{silent:true});
  }
  updateGroupOptions();
})();
</script>
</body>
</html>
