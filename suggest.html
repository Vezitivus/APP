<!DOCTYPE html>
<html lang="lv">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ieteikumi VEZITIVUS</title>
  <style>
    body { font-family: sans-serif; margin: 20px; background: #f4f4f4; }
    header { background: #333; color: #fff; padding: 10px; text-align: center; }
    #submitForm { margin: 20px 0; }
    #submitForm input, #submitForm textarea { width: 100%; margin: 5px 0; padding: 8px; }
    #submitForm button { padding: 8px 16px; background: #008CBA; color: #fff; border: none; border-radius: 3px; cursor: pointer; }
    .suggestion { background: #fff; margin: 10px 0; padding: 10px; border-radius: 5px; }
    .suggestion p { margin: 5px 0; }
    .like-button { background: #008CBA; color: #fff; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; }
    .like-button[disabled] { background: #aaa; cursor: default; }
  </style>
</head>
<body>
  <header>Ieteikumi VEZITIVUS</header>
  
  <div id="submitForm">
    <input type="text" id="uidInput" placeholder="Ievadi savu UID (vai paliek tukšs, tiks ģenerēts)" />
    <textarea id="suggestionInput" placeholder="Ievadiet ieteikumu"></textarea>
    <button id="submitBtn">Pievienot ieteikumu</button>
  </div>
  
  <div id="suggestionsContainer">
    <!-- Ieraksti tiks ģenerēti šeit -->
  </div>
  
  <script>
    // Nomainiet webappUrl, ja nepieciešams!
    const webappUrl = 'https://script.google.com/macros/s/AKfycbxX5l-iQNITlUQAEXV62euxLwPCVlJP7eLaUkya9KQksMC3NgY6L8iMpJXQ4lEfztdT4A/exec';
    
    function getUid() {
      let uid = document.getElementById('uidInput').value.trim();
      if (!uid) {
        uid = 'anon_' + Math.floor(Math.random() * 1000000);
        document.getElementById('uidInput').value = uid;
      }
      return uid;
    }
    
    function jsonpRequest(url, callback) {
      const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
      const script = document.createElement('script');
      window[callbackName] = function(data) {
        delete window[callbackName];
        document.body.removeChild(script);
        callback(data);
      };
      script.src = url + (url.indexOf('?') >= 0 ? '&' : '?') + 'callback=' + callbackName + '&_=' + new Date().getTime();
      document.body.appendChild(script);
    }
    
    function loadSuggestions() {
      const uid = getUid();
      const url = webappUrl + '?action=getRecommendations&uid=' + encodeURIComponent(uid);
      jsonpRequest(url, function(data) {
        if(data.status === 'success'){
          renderSuggestions(data.recommendations);
        } else {
          console.error(data.message);
        }
      });
    }
    
    function renderSuggestions(suggestions) {
      const container = document.getElementById('suggestionsContainer');
      container.innerHTML = '';
      suggestions.forEach(s => {
        const div = document.createElement('div');
        div.className = 'suggestion';
        div.innerHTML = '<p><strong>Autors:</strong> ' + s.submitter + '</p>' +
                        '<p>' + s.text.replace(/\n/g, '<br>') + '</p>' +
                        '<p><strong>Likes:</strong> ' + s.likes + '</p>';
        const currentUid = getUid();
        if(!s.alreadyLiked) {
          const btn = document.createElement('button');
          btn.className = 'like-button';
          btn.textContent = 'Like';
          btn.addEventListener('click', function() {
            likeSuggestion(s.id);
          });
          div.appendChild(btn);
        } else {
          const span = document.createElement('span');
          span.textContent = 'Jūs jau devis like';
          div.appendChild(span);
        }
        container.appendChild(div);
      });
    }
    
    function likeSuggestion(recId) {
      const uid = getUid();
      const url = webappUrl + '?action=like&recId=' + encodeURIComponent(recId) + '&uid=' + encodeURIComponent(uid);
      jsonpRequest(url, function(data) {
        if(data.status === 'success'){
          loadSuggestions();
        } else {
          alert(data.message);
        }
      });
    }
    
    document.getElementById('submitBtn').addEventListener('click', function() {
      const uid = getUid();
      const text = document.getElementById('suggestionInput').value.trim();
      if(!text){
        alert('Lūdzu, ievadiet ieteikumu');
        return;
      }
      const url = webappUrl + '?action=submitRecommendation&uid=' + encodeURIComponent(uid) + '&text=' + encodeURIComponent(text);
      jsonpRequest(url, function(data) {
        if(data.status === 'success'){
          document.getElementById('suggestionInput').value = '';
          loadSuggestions();
        } else {
          alert(data.message);
        }
      });
    });
    
    // Sākotnēji ielādējam ierakstus
    loadSuggestions();
  </script>
</body>
</html>
