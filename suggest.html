<!DOCTYPE html>
<html lang="lv">
<head>
  <meta charset="UTF-8">
  <title>Ieteikumi VEZITIVUS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    /* Pamatstili */
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: #f0f0f0;
    }
    /* Fiksēta augšdaļa ar caurspīdīgu fonu */
    .header {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      background: rgba(0, 0, 0, 0.5);
      color: #fff;
      text-align: center;
      padding: 20px 0;
      z-index: 100;
    }
    /* Poga jauna ieraksta ievadei */
    .add-btn {
      display: block;
      width: 220px;
      margin: 100px auto 20px;
      padding: 10px;
      text-align: center;
      background: #007BFF;
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    /* Ieteikumu konteineris */
    .content {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      padding-bottom: 40px;
    }
    /* Ieteikumu bloks (sākumā 45% platumā) */
    .recommendation {
      background: #fff;
      margin: 10px;
      width: 45%;
      padding: 10px;
      border: 1px solid #ccc;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
      cursor: pointer;
      position: relative;
    }
    /* Ieraksta teksts sākumā ierobežots */
    .recommendation .text {
      max-height: 100px;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }
    /* Kad ieraksts ir paplašināts, noņemam max-height un palielinām platumu līdz 90% */
    .recommendation.expanded {
      width: 90%;
    }
    .recommendation.expanded .text {
      max-height: none;
    }
    /* Like poga – sākotnēji paslēpta */
    .like-button {
      display: none;
      position: absolute;
      bottom: 10px;
      right: 10px;
      background: #28a745;
      color: #fff;
      border: none;
      padding: 5px 10px;
      border-radius: 3px;
      cursor: pointer;
    }
    /* Paplašinātā ieraksta like poga parādās */
    .recommendation.expanded .like-button {
      display: block;
    }
  </style>
</head>
<body>
  <div class="header">Ieteikumi VEZITIVUS</div>
  <button class="add-btn" id="addRecommendation">Pievienot ieteikumu/atsauksmi</button>
  <div class="content" id="recommendationsContainer"></div>

  <script>
    (function(){
      // Izolējam mainīgos, lai izvairītos no globālas piekļuves
      'use strict';

      // Nolasām UID no URL, piemēram: ?uid=lietotajaID
      function getUID() {
        const params = new URLSearchParams(window.location.search);
        return params.get('uid') || '';
      }
      const uid = getUID();

      // Jūsu Google Script Webapp URL
      const backendUrl = 'https://script.google.com/macros/s/AKfycbxX5l-iQNITlUQAEXV62euxLwPCVlJP7eLaUkya9KQksMC3NgY6L8iMpJXQ4lEfztdT4A/exec';

      // Funkcija ielādē ieteikumus no backend
      function loadRecommendations() {
        // Nododam darbību "getRecommendations" – backendam jāatgriež JSON masīvs
        fetch(backendUrl + '?action=getRecommendations')
          .then(response => response.json())
          .then(data => {
            renderRecommendations(data);
          })
          .catch(err => console.error('Kļūda ielādējot ieteikumus:', err));
      }

      // Funkcija renderē ieteikumus lapā
      function renderRecommendations(recommendations) {
        const container = document.getElementById('recommendationsContainer');
        container.innerHTML = ''; // notīra iepriekšējo saturu
        recommendations.forEach((rec, index) => {
          const recDiv = document.createElement('div');
          recDiv.className = 'recommendation';
          // Piešķiram unikālu id – ja backend atgriež id, izmanto to, citādi izmanto index
          recDiv.dataset.id = rec.id || index;
          recDiv.innerHTML = '<div class="text">' + rec.text + '</div>' +
                             '<button class="like-button">Like (' + (rec.likes || 0) + ')</button>';
          container.appendChild(recDiv);

          // Noklikšķinot uz ieraksta, tas paplašinās/celšas
          recDiv.addEventListener('click', function(e) {
            // Ja klikšķis bija uz like pogas, nepārslēdzam paplašināšanu
            if(e.target.classList.contains('like-button')) return;
            // Ja kāds cits ieraksts ir paplašināts, to saraujam
            const expanded = document.querySelector('.recommendation.expanded');
            if(expanded && expanded !== recDiv) {
              expanded.classList.remove('expanded');
            }
            recDiv.classList.toggle('expanded');
          });

          // Like pogas klikšķa apstrāde
          const likeBtn = recDiv.querySelector('.like-button');
          likeBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            const recId = recDiv.dataset.id;
            // Pārbaudām lokāli, ja jau esat nospiedis like (var saglabāt ar localStorage)
            if(localStorage.getItem('liked_' + recId)) {
              alert('Jūs jau nospiedāt like šim ierakstam.');
              return;
            }
            // Nosūta pieprasījumu backendam, lai palielinātu like skaitu
            fetch(backendUrl + '?action=like&recId=' + recId + '&uid=' + uid)
              .then(response => response.json())
              .then(result => {
                if(result.success) {
                  localStorage.setItem('liked_' + recId, 'true');
                  // Atjaunina like skaitu poga tekstā
                  let currentLikes = parseInt(likeBtn.textContent.match(/\d+/)[0]);
                  likeBtn.textContent = 'Like (' + (currentLikes + 1) + ')';
                }
              })
              .catch(err => console.error('Kļūda nospiežot like:', err));
          });
        });
      }

      // Poga, lai pievienotu jaunu ieteikumu
      document.getElementById('addRecommendation').addEventListener('click', function() {
        const text = prompt('Ievadiet ieteikumu/atsauksmi:');
        if(!text) return;
        fetch(backendUrl + '?action=add&text=' + encodeURIComponent(text) + '&uid=' + uid)
          .then(response => response.json())
          .then(result => {
            if(result.success) {
              loadRecommendations();
            } else {
              alert('Kļūda saglabājot ieteikumu.');
            }
          })
          .catch(err => console.error('Kļūda pievienojot ieteikumu:', err));
      });

      // Noklikšķinot ārpus aktīva ieraksta, paplašinājums pazūd
      document.addEventListener('click', function(e) {
        if(!e.target.closest('.recommendation')) {
          const expanded = document.querySelector('.recommendation.expanded');
          if(expanded) expanded.classList.remove('expanded');
        }
      });

      // Sākotnēji ielādē ieteikumus
      loadRecommendations();
    })();
  </script>
</body>
</html>
